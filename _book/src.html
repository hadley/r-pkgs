<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 10 Compiled code | R packages</title>
  <meta name="description" content="This is the book site for “R packages”.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 10 Compiled code | R packages" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://r-pkgs.xiaosongz.com" />
  <meta property="og:image" content="https://r-pkgs.xiaosongz.comimages/cover.png" />
  <meta property="og:description" content="This is the book site for “R packages”." />
  <meta name="github-repo" content="hadley/r-pkgs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Compiled code | R packages" />
  
  <meta name="twitter:description" content="This is the book site for “R packages”." />
  <meta name="twitter:image" content="https://r-pkgs.xiaosongz.comimages/cover.png" />

<meta name="author" content="Hadley Wickham">


<meta name="date" content="2019-01-29">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="data.html">
<link rel="next" href="inst.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R packages by Hadley Wickham</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>R packages</a></li>
<li class="chapter" data-level="1" data-path="intro-why.html"><a href="intro-why.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro-why.html"><a href="intro-why.html#intro-phil"><i class="fa fa-check"></i><b>1.1</b> Philosophy</a></li>
<li class="chapter" data-level="1.2" data-path="intro-why.html"><a href="intro-why.html#intro-outline"><i class="fa fa-check"></i><b>1.2</b> In this book</a></li>
<li class="chapter" data-level="1.3" data-path="intro-why.html"><a href="intro-why.html#intro-get"><i class="fa fa-check"></i><b>1.3</b> Getting started</a></li>
<li class="chapter" data-level="1.4" data-path="intro-why.html"><a href="intro-why.html#intro-ack"><i class="fa fa-check"></i><b>1.4</b> Acknowledgments</a></li>
<li class="chapter" data-level="1.5" data-path="intro-why.html"><a href="intro-why.html#intro-conventions"><i class="fa fa-check"></i><b>1.5</b> Conventions</a></li>
<li class="chapter" data-level="1.6" data-path="intro-why.html"><a href="intro-why.html#intro-colophon"><i class="fa fa-check"></i><b>1.6</b> Colophon</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="package-structure.html"><a href="package-structure.html"><i class="fa fa-check"></i><b>2</b> Package structure</a><ul>
<li class="chapter" data-level="2.1" data-path="package-structure.html"><a href="package-structure.html#naming"><i class="fa fa-check"></i><b>2.1</b> Naming your package</a><ul>
<li class="chapter" data-level="2.1.1" data-path="package-structure.html"><a href="package-structure.html#requirements-for-a-name"><i class="fa fa-check"></i><b>2.1.1</b> Requirements for a name</a></li>
<li class="chapter" data-level="2.1.2" data-path="package-structure.html"><a href="package-structure.html#strategies-for-creating-a-name"><i class="fa fa-check"></i><b>2.1.2</b> Strategies for creating a name</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="package-structure.html"><a href="package-structure.html#getting-started"><i class="fa fa-check"></i><b>2.2</b> Creating a package</a></li>
<li class="chapter" data-level="2.3" data-path="package-structure.html"><a href="package-structure.html#projects"><i class="fa fa-check"></i><b>2.3</b> RStudio projects</a><ul>
<li class="chapter" data-level="2.3.1" data-path="package-structure.html"><a href="package-structure.html#what-is-an-rstudio-project-file"><i class="fa fa-check"></i><b>2.3.1</b> What is an RStudio project file?</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="package-structure.html"><a href="package-structure.html#package"><i class="fa fa-check"></i><b>2.4</b> What is a package?</a><ul>
<li class="chapter" data-level="2.4.1" data-path="package-structure.html"><a href="package-structure.html#source-packages"><i class="fa fa-check"></i><b>2.4.1</b> Source packages</a></li>
<li class="chapter" data-level="2.4.2" data-path="package-structure.html"><a href="package-structure.html#bundled-packages"><i class="fa fa-check"></i><b>2.4.2</b> Bundled packages</a></li>
<li class="chapter" data-level="2.4.3" data-path="package-structure.html"><a href="package-structure.html#binary-packages"><i class="fa fa-check"></i><b>2.4.3</b> Binary packages</a></li>
<li class="chapter" data-level="2.4.4" data-path="package-structure.html"><a href="package-structure.html#install"><i class="fa fa-check"></i><b>2.4.4</b> Installed packages</a></li>
<li class="chapter" data-level="2.4.5" data-path="package-structure.html"><a href="package-structure.html#in-memory-packages"><i class="fa fa-check"></i><b>2.4.5</b> In memory packages</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="package-structure.html"><a href="package-structure.html#library"><i class="fa fa-check"></i><b>2.5</b> What is a library?</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="r.html"><a href="r.html"><i class="fa fa-check"></i><b>3</b> R code</a><ul>
<li class="chapter" data-level="3.1" data-path="r.html"><a href="r.html#r-workflow"><i class="fa fa-check"></i><b>3.1</b> R code workflow</a></li>
<li class="chapter" data-level="3.2" data-path="r.html"><a href="r.html#r-organising"><i class="fa fa-check"></i><b>3.2</b> Organising your functions</a></li>
<li class="chapter" data-level="3.3" data-path="r.html"><a href="r.html#style"><i class="fa fa-check"></i><b>3.3</b> Code style</a><ul>
<li class="chapter" data-level="3.3.1" data-path="r.html"><a href="r.html#object-names"><i class="fa fa-check"></i><b>3.3.1</b> Object names</a></li>
<li class="chapter" data-level="3.3.2" data-path="r.html"><a href="r.html#spacing"><i class="fa fa-check"></i><b>3.3.2</b> Spacing</a></li>
<li class="chapter" data-level="3.3.3" data-path="r.html"><a href="r.html#curly-braces"><i class="fa fa-check"></i><b>3.3.3</b> Curly braces</a></li>
<li class="chapter" data-level="3.3.4" data-path="r.html"><a href="r.html#line-length"><i class="fa fa-check"></i><b>3.3.4</b> Line length</a></li>
<li class="chapter" data-level="3.3.5" data-path="r.html"><a href="r.html#indentation"><i class="fa fa-check"></i><b>3.3.5</b> Indentation</a></li>
<li class="chapter" data-level="3.3.6" data-path="r.html"><a href="r.html#assignment"><i class="fa fa-check"></i><b>3.3.6</b> Assignment</a></li>
<li class="chapter" data-level="3.3.7" data-path="r.html"><a href="r.html#commenting-guidelines"><i class="fa fa-check"></i><b>3.3.7</b> Commenting guidelines</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="r.html"><a href="r.html#r-differences"><i class="fa fa-check"></i><b>3.4</b> Top-level code</a><ul>
<li class="chapter" data-level="3.4.1" data-path="r.html"><a href="r.html#loading-code"><i class="fa fa-check"></i><b>3.4.1</b> Loading code</a></li>
<li class="chapter" data-level="3.4.2" data-path="r.html"><a href="r.html#the-r-landscape"><i class="fa fa-check"></i><b>3.4.2</b> The R landscape</a></li>
<li class="chapter" data-level="3.4.3" data-path="r.html"><a href="r.html#when-you-do-need-side-effects"><i class="fa fa-check"></i><b>3.4.3</b> When you <strong>do</strong> need side-effects</a></li>
<li class="chapter" data-level="3.4.4" data-path="r.html"><a href="r.html#s4-classes-generics-and-methods"><i class="fa fa-check"></i><b>3.4.4</b> S4 classes, generics and methods</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="r.html"><a href="r.html#r-cran"><i class="fa fa-check"></i><b>3.5</b> CRAN notes</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="description.html"><a href="description.html"><i class="fa fa-check"></i><b>4</b> Package metadata</a><ul>
<li class="chapter" data-level="4.1" data-path="description.html"><a href="description.html#dependencies"><i class="fa fa-check"></i><b>4.1</b> Dependencies: What does your package need?</a><ul>
<li class="chapter" data-level="4.1.1" data-path="description.html"><a href="description.html#versioning"><i class="fa fa-check"></i><b>4.1.1</b> Versioning</a></li>
<li class="chapter" data-level="4.1.2" data-path="description.html"><a href="description.html#other-dependencies"><i class="fa fa-check"></i><b>4.1.2</b> Other dependencies</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="description.html"><a href="description.html#pkg-description"><i class="fa fa-check"></i><b>4.2</b> Title and description: What does your package do?</a></li>
<li class="chapter" data-level="4.3" data-path="description.html"><a href="description.html#author"><i class="fa fa-check"></i><b>4.3</b> Author: who are you?</a><ul>
<li class="chapter" data-level="4.3.1" data-path="description.html"><a href="description.html#on-cran"><i class="fa fa-check"></i><b>4.3.1</b> On CRAN</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="description.html"><a href="description.html#license"><i class="fa fa-check"></i><b>4.4</b> License: Who can use your package?</a><ul>
<li class="chapter" data-level="4.4.1" data-path="description.html"><a href="description.html#on-cran-1"><i class="fa fa-check"></i><b>4.4.1</b> On CRAN</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="description.html"><a href="description.html#version"><i class="fa fa-check"></i><b>4.5</b> Version</a></li>
<li class="chapter" data-level="4.6" data-path="description.html"><a href="description.html#description-misc"><i class="fa fa-check"></i><b>4.6</b> Other components</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="man.html"><a href="man.html"><i class="fa fa-check"></i><b>5</b> Object documentation</a><ul>
<li class="chapter" data-level="5.1" data-path="man.html"><a href="man.html#man-workflow"><i class="fa fa-check"></i><b>5.1</b> The documentation workflow</a></li>
<li class="chapter" data-level="5.2" data-path="man.html"><a href="man.html#man-workflow-2"><i class="fa fa-check"></i><b>5.2</b> Alternative documentation workflow</a></li>
<li class="chapter" data-level="5.3" data-path="man.html"><a href="man.html#roxygen-comments"><i class="fa fa-check"></i><b>5.3</b> Roxygen comments</a></li>
<li class="chapter" data-level="5.4" data-path="man.html"><a href="man.html#man-functions"><i class="fa fa-check"></i><b>5.4</b> Documenting functions</a></li>
<li class="chapter" data-level="5.5" data-path="man.html"><a href="man.html#man-data"><i class="fa fa-check"></i><b>5.5</b> Documenting datasets</a></li>
<li class="chapter" data-level="5.6" data-path="man.html"><a href="man.html#man-packages"><i class="fa fa-check"></i><b>5.6</b> Documenting packages</a></li>
<li class="chapter" data-level="5.7" data-path="man.html"><a href="man.html#man-classes"><i class="fa fa-check"></i><b>5.7</b> Documenting classes, generics and methods</a><ul>
<li class="chapter" data-level="5.7.1" data-path="man.html"><a href="man.html#man-s3"><i class="fa fa-check"></i><b>5.7.1</b> S3</a></li>
<li class="chapter" data-level="5.7.2" data-path="man.html"><a href="man.html#man-s4"><i class="fa fa-check"></i><b>5.7.2</b> S4</a></li>
<li class="chapter" data-level="5.7.3" data-path="man.html"><a href="man.html#man-rc"><i class="fa fa-check"></i><b>5.7.3</b> RC</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="man.html"><a href="man.html#man-special"><i class="fa fa-check"></i><b>5.8</b> Special characters</a></li>
<li class="chapter" data-level="5.9" data-path="man.html"><a href="man.html#dry2"><i class="fa fa-check"></i><b>5.9</b> Do repeat yourself</a><ul>
<li class="chapter" data-level="5.9.1" data-path="man.html"><a href="man.html#inheriting-parameters-from-other-functions"><i class="fa fa-check"></i><b>5.9.1</b> Inheriting parameters from other functions</a></li>
<li class="chapter" data-level="5.9.2" data-path="man.html"><a href="man.html#multiple-man"><i class="fa fa-check"></i><b>5.9.2</b> Documenting multiple functions in the same file</a></li>
</ul></li>
<li class="chapter" data-level="5.10" data-path="man.html"><a href="man.html#text-formatting"><i class="fa fa-check"></i><b>5.10</b> Text formatting reference sheet</a><ul>
<li class="chapter" data-level="5.10.1" data-path="man.html"><a href="man.html#character-formatting"><i class="fa fa-check"></i><b>5.10.1</b> Character formatting</a></li>
<li class="chapter" data-level="5.10.2" data-path="man.html"><a href="man.html#links"><i class="fa fa-check"></i><b>5.10.2</b> Links</a></li>
<li class="chapter" data-level="5.10.3" data-path="man.html"><a href="man.html#lists"><i class="fa fa-check"></i><b>5.10.3</b> Lists</a></li>
<li class="chapter" data-level="5.10.4" data-path="man.html"><a href="man.html#mathematics"><i class="fa fa-check"></i><b>5.10.4</b> Mathematics</a></li>
<li class="chapter" data-level="5.10.5" data-path="man.html"><a href="man.html#tables"><i class="fa fa-check"></i><b>5.10.5</b> Tables</a></li>
<li class="chapter" data-level="5.10.6" data-path="man.html"><a href="man.html#notes"><i class="fa fa-check"></i><b>5.10.6</b> Notes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="vignettes.html"><a href="vignettes.html"><i class="fa fa-check"></i><b>6</b> Vignettes: long-form documentation</a><ul>
<li class="chapter" data-level="6.1" data-path="vignettes.html"><a href="vignettes.html#vignette-workflow"><i class="fa fa-check"></i><b>6.1</b> Vignette workflow</a></li>
<li class="chapter" data-level="6.2" data-path="vignettes.html"><a href="vignettes.html#vignette-metadata"><i class="fa fa-check"></i><b>6.2</b> Metadata</a></li>
<li class="chapter" data-level="6.3" data-path="vignettes.html"><a href="vignettes.html#markdown"><i class="fa fa-check"></i><b>6.3</b> Markdown</a><ul>
<li class="chapter" data-level="6.3.1" data-path="vignettes.html"><a href="vignettes.html#sections"><i class="fa fa-check"></i><b>6.3.1</b> Sections</a></li>
<li class="chapter" data-level="6.3.2" data-path="vignettes.html"><a href="vignettes.html#lists-1"><i class="fa fa-check"></i><b>6.3.2</b> Lists</a></li>
<li class="chapter" data-level="6.3.3" data-path="vignettes.html"><a href="vignettes.html#inline-formatting"><i class="fa fa-check"></i><b>6.3.3</b> Inline formatting</a></li>
<li class="chapter" data-level="6.3.4" data-path="vignettes.html"><a href="vignettes.html#tables-1"><i class="fa fa-check"></i><b>6.3.4</b> Tables</a></li>
<li class="chapter" data-level="6.3.5" data-path="vignettes.html"><a href="vignettes.html#code"><i class="fa fa-check"></i><b>6.3.5</b> Code</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="vignettes.html"><a href="vignettes.html#knitr"><i class="fa fa-check"></i><b>6.4</b> Knitr</a><ul>
<li class="chapter" data-level="6.4.1" data-path="vignettes.html"><a href="vignettes.html#options"><i class="fa fa-check"></i><b>6.4.1</b> Options</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="vignettes.html"><a href="vignettes.html#vignette-workflow-2"><i class="fa fa-check"></i><b>6.5</b> Development cycle</a></li>
<li class="chapter" data-level="6.6" data-path="vignettes.html"><a href="vignettes.html#vignette-advice"><i class="fa fa-check"></i><b>6.6</b> Advice for writing vignettes</a><ul>
<li class="chapter" data-level="6.6.1" data-path="vignettes.html"><a href="vignettes.html#organisation"><i class="fa fa-check"></i><b>6.6.1</b> Organisation</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="vignettes.html"><a href="vignettes.html#vignette-cran"><i class="fa fa-check"></i><b>6.7</b> CRAN notes</a></li>
<li class="chapter" data-level="6.8" data-path="vignettes.html"><a href="vignettes.html#where-next"><i class="fa fa-check"></i><b>6.8</b> Where next</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="tests.html"><a href="tests.html"><i class="fa fa-check"></i><b>7</b> Testing</a><ul>
<li class="chapter" data-level="7.1" data-path="tests.html"><a href="tests.html#test-workflow"><i class="fa fa-check"></i><b>7.1</b> Test workflow</a></li>
<li class="chapter" data-level="7.2" data-path="tests.html"><a href="tests.html#test-structure"><i class="fa fa-check"></i><b>7.2</b> Test structure</a><ul>
<li class="chapter" data-level="7.2.1" data-path="tests.html"><a href="tests.html#expectations"><i class="fa fa-check"></i><b>7.2.1</b> Expectations</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="tests.html"><a href="tests.html#test-tests"><i class="fa fa-check"></i><b>7.3</b> Writing tests</a><ul>
<li class="chapter" data-level="7.3.1" data-path="tests.html"><a href="tests.html#what-to-test"><i class="fa fa-check"></i><b>7.3.1</b> What to test</a></li>
<li class="chapter" data-level="7.3.2" data-path="tests.html"><a href="tests.html#skipping-a-test"><i class="fa fa-check"></i><b>7.3.2</b> Skipping a test</a></li>
<li class="chapter" data-level="7.3.3" data-path="tests.html"><a href="tests.html#building-your-own-testing-tools"><i class="fa fa-check"></i><b>7.3.3</b> Building your own testing tools</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="tests.html"><a href="tests.html#test-files"><i class="fa fa-check"></i><b>7.4</b> Test files</a></li>
<li class="chapter" data-level="7.5" data-path="tests.html"><a href="tests.html#test-cran"><i class="fa fa-check"></i><b>7.5</b> CRAN notes</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="namespace.html"><a href="namespace.html"><i class="fa fa-check"></i><b>8</b> Namespace</a><ul>
<li class="chapter" data-level="8.1" data-path="namespace.html"><a href="namespace.html#namespace-motivation"><i class="fa fa-check"></i><b>8.1</b> Motivation</a></li>
<li class="chapter" data-level="8.2" data-path="namespace.html"><a href="namespace.html#search-path"><i class="fa fa-check"></i><b>8.2</b> Search path</a></li>
<li class="chapter" data-level="8.3" data-path="namespace.html"><a href="namespace.html#namespace-NAMESPACE"><i class="fa fa-check"></i><b>8.3</b> The <code>NAMESPACE</code></a></li>
<li class="chapter" data-level="8.4" data-path="namespace.html"><a href="namespace.html#namespace-workflow"><i class="fa fa-check"></i><b>8.4</b> Workflow</a></li>
<li class="chapter" data-level="8.5" data-path="namespace.html"><a href="namespace.html#exports"><i class="fa fa-check"></i><b>8.5</b> Exports</a><ul>
<li class="chapter" data-level="8.5.1" data-path="namespace.html"><a href="namespace.html#export-s3"><i class="fa fa-check"></i><b>8.5.1</b> S3</a></li>
<li class="chapter" data-level="8.5.2" data-path="namespace.html"><a href="namespace.html#export-s4"><i class="fa fa-check"></i><b>8.5.2</b> S4</a></li>
<li class="chapter" data-level="8.5.3" data-path="namespace.html"><a href="namespace.html#export-rc"><i class="fa fa-check"></i><b>8.5.3</b> RC</a></li>
<li class="chapter" data-level="8.5.4" data-path="namespace.html"><a href="namespace.html#export-data"><i class="fa fa-check"></i><b>8.5.4</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="namespace.html"><a href="namespace.html#imports"><i class="fa fa-check"></i><b>8.6</b> Imports</a><ul>
<li class="chapter" data-level="8.6.1" data-path="namespace.html"><a href="namespace.html#import-r"><i class="fa fa-check"></i><b>8.6.1</b> R functions</a></li>
<li class="chapter" data-level="8.6.2" data-path="namespace.html"><a href="namespace.html#import-s3"><i class="fa fa-check"></i><b>8.6.2</b> S3</a></li>
<li class="chapter" data-level="8.6.3" data-path="namespace.html"><a href="namespace.html#import-s4"><i class="fa fa-check"></i><b>8.6.3</b> S4</a></li>
<li class="chapter" data-level="8.6.4" data-path="namespace.html"><a href="namespace.html#import-src"><i class="fa fa-check"></i><b>8.6.4</b> Compiled functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>9</b> External data</a><ul>
<li class="chapter" data-level="9.1" data-path="data.html"><a href="data.html#data-data"><i class="fa fa-check"></i><b>9.1</b> Exported data</a><ul>
<li class="chapter" data-level="9.1.1" data-path="data.html"><a href="data.html#documenting-data"><i class="fa fa-check"></i><b>9.1.1</b> Documenting datasets</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="data.html"><a href="data.html#data-sysdata"><i class="fa fa-check"></i><b>9.2</b> Internal data</a></li>
<li class="chapter" data-level="9.3" data-path="data.html"><a href="data.html#data-extdata"><i class="fa fa-check"></i><b>9.3</b> Raw data</a></li>
<li class="chapter" data-level="9.4" data-path="data.html"><a href="data.html#other-data"><i class="fa fa-check"></i><b>9.4</b> Other data</a></li>
<li class="chapter" data-level="9.5" data-path="data.html"><a href="data.html#data-cran"><i class="fa fa-check"></i><b>9.5</b> CRAN notes</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="src.html"><a href="src.html"><i class="fa fa-check"></i><b>10</b> Compiled code</a><ul>
<li class="chapter" data-level="10.1" data-path="src.html"><a href="src.html#cpp"><i class="fa fa-check"></i><b>10.1</b> C++</a><ul>
<li class="chapter" data-level="10.1.1" data-path="src.html"><a href="src.html#cpp-workflow"><i class="fa fa-check"></i><b>10.1.1</b> Workflow</a></li>
<li class="chapter" data-level="10.1.2" data-path="src.html"><a href="src.html#cpp-man"><i class="fa fa-check"></i><b>10.1.2</b> Documentation</a></li>
<li class="chapter" data-level="10.1.3" data-path="src.html"><a href="src.html#cpp-export"><i class="fa fa-check"></i><b>10.1.3</b> Exporting C++ code</a></li>
<li class="chapter" data-level="10.1.4" data-path="src.html"><a href="src.html#cpp-import"><i class="fa fa-check"></i><b>10.1.4</b> Importing C++ code</a></li>
<li class="chapter" data-level="10.1.5" data-path="src.html"><a href="src.html#cpp-best-practices"><i class="fa fa-check"></i><b>10.1.5</b> Best practices</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="src.html"><a href="src.html#clang"><i class="fa fa-check"></i><b>10.2</b> C</a><ul>
<li class="chapter" data-level="10.2.1" data-path="src.html"><a href="src.html#getting-started-with-.call"><i class="fa fa-check"></i><b>10.2.1</b> Getting started with <code>.Call()</code></a></li>
<li class="chapter" data-level="10.2.2" data-path="src.html"><a href="src.html#getting-started-with-.c"><i class="fa fa-check"></i><b>10.2.2</b> Getting started with <code>.C()</code></a></li>
<li class="chapter" data-level="10.2.3" data-path="src.html"><a href="src.html#c-workflow"><i class="fa fa-check"></i><b>10.2.3</b> Workflow</a></li>
<li class="chapter" data-level="10.2.4" data-path="src.html"><a href="src.html#c-export"><i class="fa fa-check"></i><b>10.2.4</b> Exporting C code</a></li>
<li class="chapter" data-level="10.2.5" data-path="src.html"><a href="src.html#c-import"><i class="fa fa-check"></i><b>10.2.5</b> Importing C code</a></li>
<li class="chapter" data-level="10.2.6" data-path="src.html"><a href="src.html#c-best-practices"><i class="fa fa-check"></i><b>10.2.6</b> Best practices</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="src.html"><a href="src.html#src-debugging"><i class="fa fa-check"></i><b>10.3</b> Debugging compiled code</a></li>
<li class="chapter" data-level="10.4" data-path="src.html"><a href="src.html#make"><i class="fa fa-check"></i><b>10.4</b> Makefiles</a></li>
<li class="chapter" data-level="10.5" data-path="src.html"><a href="src.html#src-other"><i class="fa fa-check"></i><b>10.5</b> Other languages</a></li>
<li class="chapter" data-level="10.6" data-path="src.html"><a href="src.html#src-licensing"><i class="fa fa-check"></i><b>10.6</b> Licensing</a></li>
<li class="chapter" data-level="10.7" data-path="src.html"><a href="src.html#src-workflow"><i class="fa fa-check"></i><b>10.7</b> Development workflow</a></li>
<li class="chapter" data-level="10.8" data-path="src.html"><a href="src.html#src-cran"><i class="fa fa-check"></i><b>10.8</b> CRAN issues</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="inst.html"><a href="inst.html"><i class="fa fa-check"></i><b>11</b> Installed files</a><ul>
<li class="chapter" data-level="11.1" data-path="inst.html"><a href="inst.html#inst-citation"><i class="fa fa-check"></i><b>11.1</b> Package citation</a></li>
<li class="chapter" data-level="11.2" data-path="inst.html"><a href="inst.html#inst-other-langs"><i class="fa fa-check"></i><b>11.2</b> Other languages</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="misc.html"><a href="misc.html"><i class="fa fa-check"></i><b>12</b> Other components</a><ul>
<li class="chapter" data-level="12.1" data-path="misc.html"><a href="misc.html#demo"><i class="fa fa-check"></i><b>12.1</b> Demos</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="git.html"><a href="git.html"><i class="fa fa-check"></i><b>13</b> Git and GitHub</a><ul>
<li class="chapter" data-level="13.1" data-path="git.html"><a href="git.html#git-rstudio"><i class="fa fa-check"></i><b>13.1</b> RStudio, Git and GitHub</a></li>
<li class="chapter" data-level="13.2" data-path="git.html"><a href="git.html#git-setup"><i class="fa fa-check"></i><b>13.2</b> Initial set up</a></li>
<li class="chapter" data-level="13.3" data-path="git.html"><a href="git.html#git-init"><i class="fa fa-check"></i><b>13.3</b> Create a local Git repository</a></li>
<li class="chapter" data-level="13.4" data-path="git.html"><a href="git.html#git-status"><i class="fa fa-check"></i><b>13.4</b> See what’s changed</a></li>
<li class="chapter" data-level="13.5" data-path="git.html"><a href="git.html#git-commit"><i class="fa fa-check"></i><b>13.5</b> Record changes</a></li>
<li class="chapter" data-level="13.6" data-path="git.html"><a href="git.html#commit-best-practices"><i class="fa fa-check"></i><b>13.6</b> Commit best practices</a></li>
<li class="chapter" data-level="13.7" data-path="git.html"><a href="git.html#git-ignore"><i class="fa fa-check"></i><b>13.7</b> Ignoring files</a></li>
<li class="chapter" data-level="13.8" data-path="git.html"><a href="git.html#git-undo"><i class="fa fa-check"></i><b>13.8</b> Undo a mistake</a></li>
<li class="chapter" data-level="13.9" data-path="git.html"><a href="git.html#github-init"><i class="fa fa-check"></i><b>13.9</b> Synchronising with GitHub</a></li>
<li class="chapter" data-level="13.10" data-path="git.html"><a href="git.html#github-benefit"><i class="fa fa-check"></i><b>13.10</b> Benefits of using GitHub</a></li>
<li class="chapter" data-level="13.11" data-path="git.html"><a href="git.html#git-pull"><i class="fa fa-check"></i><b>13.11</b> Working with others</a></li>
<li class="chapter" data-level="13.12" data-path="git.html"><a href="git.html#github-issues"><i class="fa fa-check"></i><b>13.12</b> Issues</a></li>
<li class="chapter" data-level="13.13" data-path="git.html"><a href="git.html#git-branch"><i class="fa fa-check"></i><b>13.13</b> Branches</a></li>
<li class="chapter" data-level="13.14" data-path="git.html"><a href="git.html#git-pullreq"><i class="fa fa-check"></i><b>13.14</b> Making a pull request</a></li>
<li class="chapter" data-level="13.15" data-path="git.html"><a href="git.html#pr-make"><i class="fa fa-check"></i><b>13.15</b> Submitting a pull request to another repo</a></li>
<li class="chapter" data-level="13.16" data-path="git.html"><a href="git.html#pr-accept"><i class="fa fa-check"></i><b>13.16</b> Reviewing and accepting pull requests</a></li>
<li class="chapter" data-level="13.17" data-path="git.html"><a href="git.html#git-learning"><i class="fa fa-check"></i><b>13.17</b> Learning more</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="check.html"><a href="check.html"><i class="fa fa-check"></i><b>14</b> Automated checking</a><ul>
<li class="chapter" data-level="14.1" data-path="check.html"><a href="check.html#check-workflow"><i class="fa fa-check"></i><b>14.1</b> Workflow</a></li>
<li class="chapter" data-level="14.2" data-path="check.html"><a href="check.html#check-checks"><i class="fa fa-check"></i><b>14.2</b> Checks</a><ul>
<li class="chapter" data-level="14.2.1" data-path="check.html"><a href="check.html#check-metadata"><i class="fa fa-check"></i><b>14.2.1</b> Check metadata</a></li>
<li class="chapter" data-level="14.2.2" data-path="check.html"><a href="check.html#package-structure-1"><i class="fa fa-check"></i><b>14.2.2</b> Package structure</a></li>
<li class="chapter" data-level="14.2.3" data-path="check.html"><a href="check.html#description-1"><i class="fa fa-check"></i><b>14.2.3</b> Description</a></li>
<li class="chapter" data-level="14.2.4" data-path="check.html"><a href="check.html#namespace-1"><i class="fa fa-check"></i><b>14.2.4</b> Namespace</a></li>
<li class="chapter" data-level="14.2.5" data-path="check.html"><a href="check.html#r-code"><i class="fa fa-check"></i><b>14.2.5</b> R code</a></li>
<li class="chapter" data-level="14.2.6" data-path="check.html"><a href="check.html#data-1"><i class="fa fa-check"></i><b>14.2.6</b> Data</a></li>
<li class="chapter" data-level="14.2.7" data-path="check.html"><a href="check.html#documentation"><i class="fa fa-check"></i><b>14.2.7</b> Documentation</a></li>
<li class="chapter" data-level="14.2.8" data-path="check.html"><a href="check.html#demos"><i class="fa fa-check"></i><b>14.2.8</b> Demos</a></li>
<li class="chapter" data-level="14.2.9" data-path="check.html"><a href="check.html#compiled-code"><i class="fa fa-check"></i><b>14.2.9</b> Compiled code</a></li>
<li class="chapter" data-level="14.2.10" data-path="check.html"><a href="check.html#tests-1"><i class="fa fa-check"></i><b>14.2.10</b> Tests</a></li>
<li class="chapter" data-level="14.2.11" data-path="check.html"><a href="check.html#vignettes-1"><i class="fa fa-check"></i><b>14.2.11</b> Vignettes</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="check.html"><a href="check.html#travis"><i class="fa fa-check"></i><b>14.3</b> Checking after every commit with Travis</a><ul>
<li class="chapter" data-level="14.3.1" data-path="check.html"><a href="check.html#basic-config"><i class="fa fa-check"></i><b>14.3.1</b> Basic config</a></li>
<li class="chapter" data-level="14.3.2" data-path="check.html"><a href="check.html#other-uses"><i class="fa fa-check"></i><b>14.3.2</b> Other uses</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="release.html"><a href="release.html"><i class="fa fa-check"></i><b>15</b> Releasing a package</a><ul>
<li class="chapter" data-level="15.1" data-path="release.html"><a href="release.html#release-version"><i class="fa fa-check"></i><b>15.1</b> Version number</a></li>
<li class="chapter" data-level="15.2" data-path="release.html"><a href="release.html#compatibility"><i class="fa fa-check"></i><b>15.2</b> Backward compatibility</a></li>
<li class="chapter" data-level="15.3" data-path="release.html"><a href="release.html#release-check"><i class="fa fa-check"></i><b>15.3</b> The submission process</a><ul>
<li class="chapter" data-level="15.3.1" data-path="release.html"><a href="release.html#release-test-env"><i class="fa fa-check"></i><b>15.3.1</b> Test environments</a></li>
<li class="chapter" data-level="15.3.2" data-path="release.html"><a href="release.html#release-check"><i class="fa fa-check"></i><b>15.3.2</b> Check results</a></li>
<li class="chapter" data-level="15.3.3" data-path="release.html"><a href="release.html#release-deps"><i class="fa fa-check"></i><b>15.3.3</b> Reverse dependencies</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="release.html"><a href="release.html#cran-policies"><i class="fa fa-check"></i><b>15.4</b> CRAN policies</a></li>
<li class="chapter" data-level="15.5" data-path="release.html"><a href="release.html#important-files"><i class="fa fa-check"></i><b>15.5</b> Important files</a><ul>
<li class="chapter" data-level="15.5.1" data-path="release.html"><a href="release.html#readme"><i class="fa fa-check"></i><b>15.5.1</b> README.md</a></li>
<li class="chapter" data-level="15.5.2" data-path="release.html"><a href="release.html#readme-rmd"><i class="fa fa-check"></i><b>15.5.2</b> README.Rmd</a></li>
<li class="chapter" data-level="15.5.3" data-path="release.html"><a href="release.html#news"><i class="fa fa-check"></i><b>15.5.3</b> NEWS.md</a></li>
</ul></li>
<li class="chapter" data-level="15.6" data-path="release.html"><a href="release.html#release-submission"><i class="fa fa-check"></i><b>15.6</b> Release</a><ul>
<li class="chapter" data-level="15.6.1" data-path="release.html"><a href="release.html#on-failure"><i class="fa fa-check"></i><b>15.6.1</b> On failure</a></li>
<li class="chapter" data-level="15.6.2" data-path="release.html"><a href="release.html#binary-builds"><i class="fa fa-check"></i><b>15.6.2</b> Binary builds</a></li>
</ul></li>
<li class="chapter" data-level="15.7" data-path="release.html"><a href="release.html#post-release"><i class="fa fa-check"></i><b>15.7</b> Prepare for next version</a></li>
<li class="chapter" data-level="15.8" data-path="release.html"><a href="release.html#promotion"><i class="fa fa-check"></i><b>15.8</b> Publicising your package</a></li>
<li class="chapter" data-level="15.9" data-path="release.html"><a href="release.html#congratulations"><i class="fa fa-check"></i><b>15.9</b> Congratulations!</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/hadley/r-pkgs/" target="blank">PBuilding R package - Hadley Wickham</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R packages</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="src" class="section level1">
<h1><span class="header-section-number">Chapter 10</span> Compiled code</h1>
<p>R is a high-level, expressive language. But that expressivity comes at a price: speed. That’s why incorporating a low-level, compiled language like C or C++ can powerfully complement your R code. While C and C++ often require more lines of code (and more careful thought) to solve the same problem, they can be orders of magnitude faster than R.</p>
<p>Unfortunately, teaching you how to program in C or C++ is beyond the scope of the book. If you’d like to learn, I recommend starting with C++ and the Rcpp package. Rcpp makes it easy to connect C++ to R. I’d also recommend using RStudio because it has many tools that facilitate the entire process. Start by reading my <a href="http://adv-r.had.co.nz/Rcpp.html">“High performance functions with Rcpp”</a>, a freely available book chapter from <a href="http://amzn.com/1466586966?tag=devtools-20">Advanced R</a>: it gently introduces the language by translating examples of familiar R code into C++. Next, check out the <a href="http://www.rcpp.org/book">Rcpp book</a> and the other resources listed in <a href="http://adv-r.had.co.nz/Rcpp.html#rcpp-more">learning more</a>.</p>
<div id="cpp" class="section level2">
<h2><span class="header-section-number">10.1</span> C++</h2>
<p>To set up your package with Rcpp, run:</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw">use_rcpp</span>()</code></pre>
<p>This will:</p>
<ul>
<li><p>Create a <code>src/</code> directory to hold your <code>.cpp</code> files.</p></li>
<li><p>Add <code>Rcpp</code> to the <code>LinkingTo</code> and <code>Imports</code> fields in the <code>DESCRIPTION</code>.</p></li>
<li><p>Set up a <code>.gitignore</code> file to make sure you don’t accidentally check in
any compiled files (learn more about this in <a href="git.html#git">git</a>).</p></li>
<li><p>Tell you the two roxygen tags you need to add to your package:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @useDynLib your-package-name</span>
<span class="co">#&#39; @importFrom Rcpp sourceCpp</span>
<span class="ot">NULL</span></code></pre>
<pre><code>## NULL</code></pre></li>
</ul>
<div id="cpp-workflow" class="section level3">
<h3><span class="header-section-number">10.1.1</span> Workflow</h3>
<p>Once you’re set up, the basic workflow should now be familiar:</p>
<ol style="list-style-type: decimal">
<li><p>Create a new C++ file:</p>
<p><img src="images/new-cpp.png" /><!-- --></p>
<p>The default template looks like this:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span>
<span class="kw">using</span> <span class="kw">namespace</span> Rcpp;

<span class="co">// Below is a simple example of exporting a C++ function to R. You can</span>
<span class="co">// source this function into an R session using the Rcpp::sourceCpp </span>
<span class="co">// function (or via the Source button on the editor toolbar)</span>

<span class="co">// For more on using Rcpp click the Help button on the editor toolbar</span>

<span class="co">// [[Rcpp::export]]</span>
<span class="dt">int</span> timesTwo(<span class="dt">int</span> x) {
   <span class="cf">return</span> x * <span class="dv">2</span>;
}</code></pre>
<p>It includes a basic function and some instructions to get started. The
two most important parts are the header <code>#include</code>, and the special
attribute <code>// [[Rcpp::export]]</code>.</p></li>
<li><p>Generate the necessary modifications to your <code>NAMESPACE</code> by documenting
them with Ctrl/Cmd + Shift + D.</p></li>
<li><p>Click Build &amp; Reload in the build pane, or press Ctrl/Cmd + Shift + B. You can
continue to use the standard <code>devtools::load_all()</code> process but it is more
risky. Because you’re loading and unloading C code, the chances of
corrupting memory are high, and you’re better off with the safer, but
slower, “Build &amp; Reload” which installs the package then restarts R.</p></li>
<li><p>Run <code>timesTwo(10)</code> from the console to check that it works.</p></li>
</ol>
<p>Behind the scenes, “Build and reload” is doing a lot of work for you. They:</p>
<ul>
<li><p>Set up your R environment to compile code and warn you if you’re missing
necessary pieces.</p></li>
<li><p>Call <code>Rcpp::compileAttributes()</code>. This inspects your <code>.cpp</code> functions
looking for <strong>attributes</strong> of the form <code>// [[Rcpp::export]]</code>. When it finds
one, it generates the code needed to make the function available in
R, and creates <code>src/RcppExports.cpp</code> and <code>R/RcppExports.R</code>. You should never
modify these files by hand.</p></li>
<li><p>Build a DLL (dynamically linked library) and make it available to R.</p></li>
</ul>
</div>
<div id="cpp-man" class="section level3">
<h3><span class="header-section-number">10.1.2</span> Documentation</h3>
<p>Each exported C++ function automatically gets a wrapper function (it will be located in <code>R/RcppExports.R</code>). For example, the R <code>timesTwo()</code> function looks like:</p>
<pre class="sourceCode r"><code class="sourceCode r">timesTwo &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  <span class="kw">.Call</span>(<span class="st">&#39;timesTwo&#39;</span>, <span class="dt">PACKAGE =</span> <span class="st">&#39;mypackage&#39;</span>, x)
}</code></pre>
<p>This uses the base function <code>.Call()</code> to execute the C function <code>timesTwo</code> provided by “mypackage”. You can use roxygen2 to document this like a regular R function. But instead of using <code>#'</code> for comments use <code>//'</code>, the C++ convention:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//&#39; Multiply a number by two</span>
<span class="co">//&#39; </span>
<span class="co">//&#39; @param x A single integer.</span>
<span class="co">//&#39; @export</span>
<span class="co">// [[Rcpp::export]]</span>
<span class="dt">int</span> timesTwo(<span class="dt">int</span> x) {
   <span class="cf">return</span> x * <span class="dv">2</span>;
}</code></pre>
<p>That generates roxygen comments in <code>R/RcppExports.R</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; Multiply a number by two</span>
<span class="co">#&#39; </span>
<span class="co">#&#39; @param x A single integer.</span>
<span class="co">#&#39; @export</span>
timesTwo &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  <span class="kw">.Call</span>(<span class="st">&#39;timesTwo&#39;</span>, <span class="dt">PACKAGE =</span> <span class="st">&#39;mypackage&#39;</span>, x)
}</code></pre>
<p>The distinctions between the two export directives is important:</p>
<ul>
<li><p><code>[[Rcpp::export]]</code> makes the C++ function available to R. If you have
trouble remembering the exact details, note that everything comes in
twos: Two <code>/</code>, two <code>[</code>, two <code>:</code> and two <code>]</code>.</p></li>
<li><p><code>@export</code> makes the R wrapper function available outside your package by
adding it to the <code>NAMESPACE</code>.</p></li>
</ul>
</div>
<div id="cpp-export" class="section level3">
<h3><span class="header-section-number">10.1.3</span> Exporting C++ code</h3>
<p>To make your C++ code callable from C++ code in other packages, add:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// [[Rcpp::interfaces(r, cpp)]]</span></code></pre>
<p>This will generate a header file, <code>inst/include/mypackage.h</code> that can be included by other packages (The low-level details are described in <a href="src.html#c-export">Exporting C code</a>). See “<a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-attributes.pdf">Rcpp Attributes</a>” for more details, including how to combine hand-written and automatically generated header files.</p>
</div>
<div id="cpp-import" class="section level3">
<h3><span class="header-section-number">10.1.4</span> Importing C++ code</h3>
<p>To use C++ code from another package:</p>
<ol style="list-style-type: decimal">
<li><p>In <code>DESCRIPTION</code>, add <code>LinkingTo: otherPackage</code>. Confusingly this has nothing
to do with the linker. It’s called <code>LinkingTo</code> because it adds
<code>otherPackage/include</code> to the include path, allowing you to dynamically
“link to” other code via the headers.</p></li>
<li><p>In the C++ file, add:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="pp">#include </span><span class="im">&lt;otherPackage.h&gt;</span></code></pre></li>
<li><p>C++ functions from otherPackage will be included in the <code>otherPackage</code>
namespace. Use <code>otherPackage::foo()</code> to access functions, or make
them available globally with <code>using namespace otherPackage</code>.</p></li>
</ol>
</div>
<div id="cpp-best-practices" class="section level3">
<h3><span class="header-section-number">10.1.5</span> Best practices</h3>
<ul>
<li><p>To print output use <code>Rcout &lt;&lt; ...</code> (not <code>cout &lt;&lt; ...</code>). This prints to
the right place, which might be a GUI console or a file (if <code>sink()</code>
is active)</p></li>
<li><p>In long-running loops, regularly run <code>Rcpp::checkUserInterrupt()</code>. This
aborts your C++ if the user has pressed Ctrl + C or Escape in R.</p></li>
<li><p>Use <code>.h</code> extension for headers and include files. (If you don’t
<code>R CMD check</code> will complain).</p></li>
<li><p>Follow Martyn Plummer’s recommendations on
<a href="http://journal.r-project.org/archive/2011-2/RJournal_2011-2_Plummer.pdf">Portable C++ for R packages</a>.</p></li>
<li><p>Whenever you use C++ code in your package, you need to clean up after
yourself when your package is unloaded. Do this by writing a <code>.onUnload()</code>
function that unloads the DLL:</p>
<pre class="sourceCode r"><code class="sourceCode r">.onUnload &lt;-<span class="st"> </span><span class="cf">function</span> (libpath) {
  <span class="kw">library.dynam.unload</span>(<span class="st">&quot;mypackage&quot;</span>, libpath)
}</code></pre></li>
<li><p>Use <code>clang</code> instead of <code>gcc</code> to compile your C++ code: it gives much
better error messages. You can make <code>clang</code> the default by creating a
<code>.R/Makevars</code> (linux and mac) or <code>.R/Makevars.win</code> (windows) file in
your home directory that contains:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="va">CXX=</span>clang++</code></pre>
<p>(If you don’t know where your home directory is <code>path.expand(&quot;~&quot;)</code> will
tell you.)</p></li>
<li><p>To speed up compilation on linux or mac, install <code>ccache</code>, then replace
<code>~/.R/Makevars</code> with:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="va">CC=</span>ccache <span class="fu">clang</span> -Qunused-arguments
<span class="va">CXX=</span>ccache <span class="fu">clang</span>++ -Qunused-arguments
<span class="va">CCACHE_CPP2=</span>yes</code></pre></li>
</ul>
</div>
</div>
<div id="clang" class="section level2">
<h2><span class="header-section-number">10.2</span> C</h2>
<p>If you’re writing new compiled code, it’s almost always better to use Rcpp. It’s less work, more consistent, better documented, and it has better tools. However, there are some reasons to choose C:</p>
<ul>
<li>You’re working with an older package that already uses the C API.</li>
<li>You’re binding to an existing C library.</li>
</ul>
<p>There are two ways to call C functions from R: <code>.C()</code> and <code>.Call()</code>. <code>.C()</code> is a quick and dirty way to call an C function that doesn’t know anything about R because <code>.C()</code> automatically converts between R vectors and the corresponding C types. <code>.Call()</code> is more flexible, but more work: your C function needs to use the R API to convert its inputs to standard C data types.</p>
<div id="getting-started-with-.call" class="section level3">
<h3><span class="header-section-number">10.2.1</span> Getting started with <code>.Call()</code></h3>
<p>To call a C function from R, you first need a C function! In an R package, C code lives in <code>.c</code> files in <code>src/</code>. You’ll need to include two header files:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></code></pre>
<p>(Yes, including <code>&lt;Rinternals.h&gt;</code> seems like bad form. On top of that, doing so doesn’t actually give you access to the “internal” internal API unless you set some additional flags. The default just gives you access to the “public” internal API, which is both necessary and done for safety’s sake. Yes, this is confusing.)</p>
<p>These headers allow you to access R’s C API. Unfortunately this API is not well documented. I’d recommend starting with my notes at <a href="http://adv-r.had.co.nz/C-interface.html">R’s C interface</a>. After that, read “<a href="http://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#The-R-API">The R API</a>” in “Writing R Extensions”. A number of exported functions are not documented, so you’ll also need to read the <a href="https://github.com/wch/r-source">R source code</a> to figure out the details.</p>
<p>Here’s the bare minimum you need to know: C functions that talk to R must use the <code>SEXP</code> type for both inputs and outputs. <code>SEXP</code>, short for S expression, is the C struct used to represent every type of object in R. A C function typically starts by converting <code>SEXP</code>s to atomic C objects, and ends by converting C objects back to a <code>SEXP</code>. (The R API is designed so that these conversions often don’t require copying.) The following table lists the functions that convert length one R vectors to and from C scalars:</p>
<table>
<thead>
<tr class="header">
<th>R type</th>
<th>C type</th>
<th>R -&gt; C</th>
<th>C -&gt; R</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>integer</td>
<td>int</td>
<td><code>asInteger(x)</code></td>
<td><code>ScalarInteger(x)</code></td>
</tr>
<tr class="even">
<td>numeric</td>
<td>double</td>
<td><code>asReal(x)</code></td>
<td><code>ScalarReal(x)</code></td>
</tr>
<tr class="odd">
<td>logical</td>
<td>int</td>
<td><code>asLogical(x)</code></td>
<td><code>ScalarLogical(x)</code></td>
</tr>
<tr class="even">
<td>character</td>
<td>const char*</td>
<td><code>CHAR(asChar(x))</code></td>
<td><code>mkString(x)</code></td>
</tr>
</tbody>
</table>
<p>We now have enough information to write a simple C function that can add two numbers:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span>

SEXP add_(SEXP x_, SEXP y_) {
  <span class="dt">double</span> x = asReal(x_);
  <span class="dt">double</span> y = asReal(y_);
  
  <span class="dt">double</span> sum = x + y;
  
  <span class="cf">return</span> ScalarReal(sum);
}</code></pre>
<p>We call this from R with <code>.Call()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @useDynLib mypackage add_</span>
add &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">.Call</span>(add_, x, y)</code></pre>
<p>Where does the first argument to <code>.Call()</code>, <code>add_</code>, come from? It comes from <code>@useDynLib</code>, which creates a line in the NAMESPACE that looks like:</p>
<pre><code>useDynLib(mypackage, add_)</code></pre>
<p>This directive instructs R to create an object called <code>add_</code> which describes a C function pointer:</p>
<pre class="sourceCode r"><code class="sourceCode r">mypackage<span class="op">:::</span>add_
<span class="co">#&gt; $name</span>
<span class="co">#&gt; [1] &quot;add_&quot;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $address</span>
<span class="co">#&gt; &lt;pointer: 0x107be3f40&gt;</span>
<span class="co">#&gt; $package</span>
<span class="co">#&gt; NULL</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attr(,&quot;class&quot;)</span>
<span class="co">#&gt; [1] &quot;NativeSymbolInfo&quot;</span></code></pre>
<p><code>.Call()</code> takes the pointer to a C function and calls it. All R objects have the same C type (the <code>SEXP</code>) you need to make sure the arguments are of the type you expect. Either do that in the R function, in the C function, or just accept that R will crash every time you accidentally supply the wrong type of input.</p>
<p>The most complicated part of working with the <code>.Call()</code> interface is memory-management. Whenever you create an R-level data structure, you must <code>PROTECT()</code> it so the garbage collector doesn’t try and free it, then <code>UNPROTECT()</code> it at the end of the function. This topic is beyond the scope of this chapter, but you can learn more about it at <a href="http://adv-r.had.co.nz/C-interface.html#c-vectors" class="uri">http://adv-r.had.co.nz/C-interface.html#c-vectors</a>.</p>
</div>
<div id="getting-started-with-.c" class="section level3">
<h3><span class="header-section-number">10.2.2</span> Getting started with <code>.C()</code></h3>
<p><code>.C()</code> is simpler than <code>.Call()</code> and can be useful if you already have standard C code. Since you never create R objects in <code>.C()</code>, you never need to worry about memory management. To use it, you first write a void C function, using in-place modification of function parameters to return values:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="dt">void</span> add_(<span class="dt">double</span>* x, <span class="dt">double</span>* y, <span class="dt">double</span>* out) {
  out[<span class="dv">0</span>] = x[<span class="dv">0</span>] + y[<span class="dv">0</span>];
}</code></pre>
<p>Then like <code>.Call()</code> you create an R wrapper:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @useDynLib mypackage add_</span>
add &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {
  <span class="kw">.C</span>(add_, x, y, <span class="kw">numeric</span>(<span class="dv">1</span>))[[<span class="dv">3</span>]]
}</code></pre>
<p>(Here we extract the 3rd element of the result because that corresponds to the out parameter.)</p>
<p><code>.C()</code> automatically converts back and forth between R vectors and their C equivalents:</p>
<table>
<thead>
<tr class="header">
<th>R type</th>
<th>C type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>logical</td>
<td><code>int*</code></td>
</tr>
<tr class="even">
<td>integer</td>
<td><code>int*</code></td>
</tr>
<tr class="odd">
<td>double</td>
<td><code>double*</code></td>
</tr>
<tr class="even">
<td>character</td>
<td><code>char**</code></td>
</tr>
<tr class="odd">
<td>raw</td>
<td><code>unsigned char*</code></td>
</tr>
</tbody>
</table>
<p>Note that <code>.C()</code> assumes your function doesn’t know how to deal with missing values and will throw an error if any arguments contain an NA. If it can correctly handle missing values, set <code>NAOK = TRUE</code> in the call to <code>.C()</code>.</p>
<p>You can learn more about <code>.C()</code> in its help, <code>?.C</code> and in <a href="http://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Interface-functions-_002eC-and-_002eFortran">R-extensions</a>.</p>
</div>
<div id="c-workflow" class="section level3">
<h3><span class="header-section-number">10.2.3</span> Workflow</h3>
<p>The usual workflow still applies:</p>
<ol style="list-style-type: decimal">
<li>Modify the C code.</li>
<li>Build and reload the package with Ctrl/Cmd + Shift + B</li>
<li>Experiment at the console.</li>
</ol>
<p>The first time you add <code>@useDynLib</code>, you’ll also need to run <code>devtools::document()</code> (Ctrl/Cmd + Shift + D) and reload the package.</p>
</div>
<div id="c-export" class="section level3">
<h3><span class="header-section-number">10.2.4</span> Exporting C code</h3>
<p>R packages need to provide DLLs that can be relocated; DLLs that work regardless of where they live on disk. This is because most R users don’t build packages from source. Instead, they get binaries from CRAN that can get installed in many different places. This need for relocatable DLLs adds a few more steps to the job of importing and exporting C code for R packages (the same problem arises for C++, but Rcpp attributes automate the manual steps described below).</p>
<p>R solves this problem using <strong>function registration</strong>. To export a <code>.Call()</code> C function, you register it with <code>R_RegisterCCallable()</code>. To import a <code>.Call()</code> C function, you get a pointer to it with <code>R_GetCCallable()</code>. Similar techniques are available for <code>.C()</code> C functions, but are beyond the scope of this book. As we’ll see below, a user-friendly package will do both these tasks, so users of the package can ignore the details and simply include a header a file.</p>
<p>[Sidebar: Confusingly, there’s another type of function registration. Instead of registering C functions using the namespace (i.e. <code>@useDynLib pkg fun</code>), you can register them with <code>R_registerRoutines()</code> and <code>@useDynLib mypackage, .registration = TRUE</code>. To learn the details read <a href="http://cran.r-project.org/doc/manuals/R-exts.html#Registering-native-routines">Registering native extensions</a> in “Writing R extensions”.]</p>
<p>To register a function, call <code>R_RegisterCCallable()</code>, defined in <code>&lt;R_ext/Rdynload.h&gt;</code>. Function registration should be done in a function called <code>R_init_&lt;mypackage&gt;</code>. This function is called automatically when the “mypackage” DLL is loaded. <code>R_RegisterCCallable()</code> has three arguments:</p>
<ul>
<li>A pointer to the DLL.</li>
<li>The name of the function.</li>
<li>A pointer to the function, cast as <code>DL_FUNC</code> (i.e. a <strong>d</strong>ynamically
<strong>l</strong>oaded <strong>func</strong>tion).</li>
</ul>
<p>The following code registers the <code>add_()</code> function defined above:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#include </span><span class="im">&quot;add.h&quot;</span>
<span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span>

<span class="dt">void</span> R_init_mypackage(DllInfo *info) {
  R_RegisterCCallable(<span class="st">&quot;mypackage&quot;</span>, <span class="st">&quot;add&quot;</span>,  (DL_FUNC) &amp;add_);
}</code></pre>
<p>It doesn’t matter where this code lives, but it’s usually put in a file called <code>src/mypackage-init.c</code>.</p>
<p>To access a registered function from another package, call <code>R_GetCCallable()</code>. It has two arguments, the package name and the function name. It returns a function pointer. The function pointer has no type information, so it should always be wrapped in a helper function that defines the inputs:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;R.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span>

SEXP add_(SEXP x, SEXP y) {
  <span class="dt">static</span> SEXP(*fun)(SEXP, SEXP) = NULL;
  <span class="cf">if</span> (fun == NULL)
    fun = (SEXP(*)(SEXP, SEXP)) R_GetCCallable(<span class="st">&quot;mypackage&quot;</span>, <span class="st">&quot;add&quot;</span>);
  <span class="cf">return</span> fun(x, y);
}</code></pre>
<p>Rather than relying on each package that imports your C code to do this correctly, you should instead do it for them. Write <code>inst/include/mypackageAPI.h</code> which provides a wrapper function for each exported function. A popular package that does that is <a href="http://cran.r-project.org/web/packages/xts/">xts</a>. Download the source package and look in the <code>include/</code> directory to see what it does.</p>
</div>
<div id="c-import" class="section level3">
<h3><span class="header-section-number">10.2.5</span> Importing C code</h3>
<p>Using C code from another package varies based on how the package is implemented:</p>
<ul>
<li><p>If it uses the system described above, all you need is <code>LinkingTo: otherPackage</code>
in the <code>DESCRIPTION</code>, and <code>#include otherPackageAPI.h</code> in the C file. (Remember
<code>LinkingTo</code> is not about the linker, but actually affects the include path).</p></li>
<li><p>If it registers the functions, but doesn’t provide a header file, you’ll
need to write the wrapper yourself. Since you’re not using any header
files from the package, use <code>Imports</code> and not <code>LinkingTo</code>. You also need to
make sure the package is loaded. You can do this by importing any function
with <code>@importFrom mypackage foo</code>, or by adding <code>requireNamespace(&quot;mypackage&quot;,  quietly = TRUE)</code> to <code>.onLoad()</code>.</p></li>
<li><p>If it doesn’t register the functions, you can’t use them. You’ll have to
ask the maintainer nicely or even provide a pull request.</p></li>
</ul>
</div>
<div id="c-best-practices" class="section level3">
<h3><span class="header-section-number">10.2.6</span> Best practices</h3>
<ul>
<li><p>Avoid calls to <code>assert()</code>, <code>abort()</code> and <code>exit()</code>: these will kill the
R process, not just your C code. Instead, use <code>error()</code> which is
equivalent to calling <code>stop()</code> in R.</p></li>
<li><p>To print output use <code>Rprintf()</code>, not <code>printf()</code>. Doing so always prints to
the right place, whether it’s the GUI console or a file (if <code>sink()</code> is
active).</p></li>
<li><p>In long-running loops, regularly call <code>R_CheckUserInterrupt()</code> to allow
the user to interrupt the C code.</p></li>
<li><p>Don’t use C’s random number generators (like <code>rand()</code> or <code>random()</code>),
instead use the C API to R’s rngs: <code>unif_rand()</code>, <code>norm_rand()</code>, etc.
Note the caveats in <a href="http://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Random-numbers">“Random number generation”</a> - you must call <code>GetRNGstate()</code> before and
<code>PutRNGstate()</code> after.</p></li>
<li><p>Use R macros <code>ISNAN(x)</code> and <code>R_FINITE(x)</code> to check for NaNs and infinite
values. These work on more platforms than the C99 <code>isnan()</code> and <code>isfinite()</code>.</p></li>
<li><p>Like with C++, whenever you use C code in your package, you should unload the
DLL when the package is unloaded:</p>
<pre class="sourceCode r"><code class="sourceCode r">.onUnload &lt;-<span class="st"> </span><span class="cf">function</span> (libpath) {
  <span class="kw">library.dynam.unload</span>(<span class="st">&quot;mypackage&quot;</span>, libpath)
}</code></pre></li>
<li><p>Use <code>clang</code> instead of <code>gcc</code> to compile your C code: it gives much
better error messages. You can make <code>clang</code> the default by creating a
<code>~/.R/Makevars</code> that contains:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="va">C=</span>clang</code></pre></li>
</ul>
</div>
</div>
<div id="src-debugging" class="section level2">
<h2><span class="header-section-number">10.3</span> Debugging compiled code</h2>
<p>It’s possible, with a little extra work, to use an interactive debugger to debug your C/C++ in the same way that you can use <code>browser()</code> and <code>debug()</code> to debug your R code. Unfortunately you won’t be able to use RStudio, you’ll have to run R from the command line.</p>
<p>Open a shell (e.g. with Tools | Shell…) and start R by typing:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># If you compile with clang</span>
<span class="ex">R</span> --debugger=lldb
<span class="co"># If you compile with gcc</span>
<span class="ex">R</span> --debugger=gdb</code></pre>
<p>This will start either <a href="http://lldb.llvm.org">lldb</a> or <a href="http://www.gnu.org/software/gdb/">gdb</a>, the debuggers that work with code produced by <code>clang</code> or <code>gcc</code> respectively. Like R, <code>lldb</code> and <code>gdb</code> provide a REPL, a run-eval-print loop where you enter commands and then look at the results. In the examples below I’ll show the results of <code>lldb</code>, which is what I use (the output from <code>gdb</code> is similar). For each interactive command I’ll tell you the explicit, but long, <code>lldb</code> command and the short, but cryptic, <code>gdb</code> command. Because <code>lldb</code> understand all <code>gdb</code> commands, you can use choose to be explicit of terse.</p>
<p>Once you’ve started the debugger, start R by typing <code>process start</code> (lldb) or <code>run</code> (gdb). Now when your C/C++ code crashes you’ll be dumped into an interactive debugger instead of getting a cryptic error message and a crash.</p>
<p>Let’s start with a simple C++ function that writes to memory it doesn’t “own”:</p>
<pre class="sourceCode r"><code class="sourceCode r">Rcpp<span class="op">::</span><span class="kw">cppFunction</span>(<span class="st">&quot;</span>
<span class="st">bool mistake() {</span>
<span class="st">  NumericVector x(1);</span>
<span class="st">  int n = INT_MAX;</span>
<span class="st">  x[n] = 0;</span>
<span class="st">  return true;</span>
<span class="st">}</span>
<span class="st">&quot;</span>, <span class="dt">plugins =</span> <span class="st">&quot;debug&quot;</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>, <span class="dt">rebuild =</span> <span class="ot">TRUE</span>)
<span class="kw">mistake</span>()</code></pre>
<p>Use <code>devtools::load_all()</code> to load the current package. Then copy and paste the code that creates the bug. Here’s a crash report from a package I was working on:</p>
<pre><code>Process 32743 stopped
* thread #1: tid = 0x1f79f6, 0x... gggeom.so...`
   frame #0: 0x0.. gggeom.so`vw_distance(x=..., y=...) + ... at vw-distance.cpp:54
   51        int prev_idx = prev[idx];
   52   
   53       next[prev[idx]] = next_idx;
-&gt; 54       prev[next[idx]] = prev_idx;
   55       prev[idx] = -1;
   56       next[idx] = -1;
   57</code></pre>
<p>It tells us that the crash occurred because of a <code>EXC_BAD_ACCESS</code> - this is one of the most common types of crash in C/C++ code. Helpfully, lldb shows exactly which line of C++ code caused the problem: <code>vw-distance.cpp:54</code>. Often just knowing where the problem occurs is enough to fix it. But we’re also now at an interactive prompt. There are many commands you can run here to explore what’s going on. The most useful are listed below:</p>
<ul>
<li><p>See a list of all commands: <code>help</code>.</p></li>
<li><p>Show your location on the callstack with <code>thread backtrace</code>/<code>bt</code>. This
will print a list of calls leading up to the error, much like <code>traceback()</code>
does in R. Navigate the callstack with <code>frame select &lt;n&gt;</code>/<code>frame &lt;n&gt;</code>, or
<code>up</code> and <code>down</code>.</p></li>
<li><p>Evaluate the next expression with <code>thread step-over</code>/<code>next</code>, or step into it
with <code>thread step-in</code>/<code>step</code>. Continue executing the rest of the code with
<code>thread step-out</code>/<code>finish</code></p></li>
<li><p>Show all variables defined in the current frame with <code>frame variable</code>/
<code>info locals</code>, or print the value of a single variable with
<code>frame variable &lt;var&gt;</code>/<code>p &lt;var&gt;</code>.</p></li>
</ul>
<p>Instead of waiting for a crash to occur you can also set breakpoints in your code. To do so, start the debugger, run R, then:</p>
<ol style="list-style-type: decimal">
<li><p>Press <code>Ctrl + C</code></p></li>
<li><p>Type <code>breakpoint set --file foo.c --line 12</code>/<code>break foo.c:12</code>.</p></li>
<li><p><code>process continue</code>/<code>c</code> to go back to the R console. Now run the C code
you’re interested in, and the debugger will stop when it gets to the
specified line.</p></li>
</ol>
<p>You can also set a breakpoint for any C++ exception: this allows you to figure out exactly where a C++ error occurs:</p>
<ol style="list-style-type: decimal">
<li><p>Press <code>Ctrl + C</code></p></li>
<li><p>Type <code>breakpoint set -E c++</code>.</p></li>
<li><p><code>process continue</code>/<code>c</code> to go back to the R console. Now if an exception
is thrown in C++ code (or by R’s C API when wrapped in Rcpp code), the
debugger will stop.</p></li>
</ol>
<p>Finally, you can also use the debugger if your code is stuck in an infinite loop. Press <code>Ctrl + C</code> to break into the debugger and you’ll see which line of code is causing the problem.</p>
</div>
<div id="make" class="section level2">
<h2><span class="header-section-number">10.4</span> Makefiles</h2>
<p>While makefiles are beyond the scope of this book, they are a useful tool. A good, gentle introduction with a focus on reproducible research is Karl Broman’s <a href="http://kbroman.org/minimal_make/">“Minimal make”</a>.</p>
<p>Generally, R packages should avoid a custom <code>Makefile</code>. Instead, use <code>Makevars</code>. <code>Makevars</code> is a make file that overrides the default make file generated by R (which is located at <code>file.path(R.home(&quot;etc&quot;), &quot;Makeconf&quot;)</code>). This allows you to take advantage of R’s default behaviour (it’s over 150 lines, and battle-tested across many years and many systems, so you want to!) while being able to set the flags you need. The most commonly used flags are:</p>
<ul>
<li><p><code>PKG_LIBS</code>: Linker flags. A common use is <code>PKG_LIBS = $(BLAS_LIBS)</code>. This
allows you to use the same BLAS library as R.</p></li>
<li><p><code>PKG_CFLAGS</code> &amp; <code>PKG_CXXFLAGS</code>: C and C++ flags. Most commonly used to set
define directives with <code>-D</code>.</p></li>
<li><p><code>PKG_CPPFLAGS</code>: Pre-processor flags (not C++ flags!). Most commonly used to
set include directories with <code>-I</code>. Any package listed in the <code>LinkingTo</code> field
in the <code>DESCRIPTION</code> will be automatically included - you do not need to
explicitly add it.</p></li>
</ul>
<p>To set flags only on Windows, use <code>Makevars.win</code>. To build a <code>Makevars</code> with <code>configure</code>, use <code>Makevars.in</code>.</p>
<p>By default, R will use the system make, which is not always GNU compatible (i.e. on Solaris). If you want to use GNU extensions (which are extremely common), add <code>SystemRequirements: GNU make</code> to <code>DESCRIPTION</code>. If you’re not sure if you’re using GNU extensions, play it safe and add it to the system requirement.</p>
</div>
<div id="src-other" class="section level2">
<h2><span class="header-section-number">10.5</span> Other languages</h2>
<p>It is possible to connect R to other languages, but the interfaces are not as nice as the one for C++:</p>
<ul>
<li><p><strong>Fortran</strong>: It’s possible to call Fortran subroutines directly with
<code>.Fortran()</code>, or via C or C++ with <code>.Call()</code>. See <code>?.Fortran</code> and</p></li>
<li><p><strong>Java</strong>: The <a href="https://github.com/s-u/rJava">rJava</a> package makes it
possible to call Java code from within R. Note that unlike with C and C++,
passing an R object to a Java call will involve a copy operation, something
which has serious performance implications.</p></li>
</ul>
</div>
<div id="src-licensing" class="section level2">
<h2><span class="header-section-number">10.6</span> Licensing</h2>
<p>Because it’s common to use other peoples’ libraries when writing compiled code, you need to make sure that your package license is compatible with the licenses of all included code:</p>
<ul>
<li><p>The simplest solution is to use the same license as the included code. Since
you can’t relicense someone else’s code, you may need to change your license.</p></li>
<li><p>If you don’t want to use the same license, you’re best sticking
with common cases where the interactions are well known. For example,
<a href="https://www.gnu.org/licenses/license-list.html">Various Licenses and Comments about Them</a>
describes what licenses are compatible with the GPL license.</p>
<p>In this case your description should contain
<code>License: &lt;main license&gt; + FILE license</code> where <code>&lt;main license&gt;</code> is a license
that is valid for the entire package (both R and compiled code), and the
<code>license</code> file describes the licenses of individual components.</p></li>
<li><p>For non-standard cases, you’ll need to consult a lawyer.</p></li>
</ul>
<p>In all cases, make sure you include copyright and license statements from the original code.</p>
</div>
<div id="src-workflow" class="section level2">
<h2><span class="header-section-number">10.7</span> Development workflow</h2>
<p>When developing C or C++ code, it’s usually better to use RStudio’s Build &amp; Reload instead of <code>devtools::load_all()</code>. Note this is known as “Install and Restart” in more recent versions of RStudio. If you have C objects that persist between reloads, and you change the data structure, then it’s better to use Install and Restart: otherwise there’s a high chance of crashes due to differences between versions of your C code.</p>
</div>
<div id="src-cran" class="section level2">
<h2><span class="header-section-number">10.8</span> CRAN issues</h2>
<p>Packages with compiled code are much more likely to have difficulties getting on CRAN than those without. The reason? Your package must build from source on all major platforms (Linux, Mac and Windows). This is hard!</p>
<ul>
<li><p>CRAN provides an automated service for checking R packages on windows:
<a href="http://win-builder.r-project.org">win-builder</a>. You can easily access this
by running <code>devtools::build_win()</code>, which builds and uploads a package bundle.</p></li>
<li><p>I’ve tried to include the most important advice in this chapter, but I’d
recommend reading the entire section on <a href="http://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Portable-C-and-C_002b_002b-code">writing portable C and C++ code</a> in “Writing
R extensions”.</p></li>
<li><p>In exceptional circumstances, like binding to Windows-only functionality,
you may be able to opt-out of cross-platform requirement, but be prepared<br />
to make a strong case for it.</p></li>
</ul>
<p>The interface between CRAN’s automated and manual checking can be particularly frustrating for compiled code. Requirements vary from submission to submission, based on which maintainer you get and how much free time they have. The rules are inconsistently applied, but if your package doesn’t pass, it’s better to bite the bullet and make the change rather than trying to argue about it:</p>
<ul>
<li><p>Sometimes you will need to list all authors and copyright holders of included
code in the DESCRIPTION.</p></li>
<li><p>Sometimes your package will need to work on Solaris. But due to the difficulty
of accessing a computer running Solaris, fixing Solaris issues can be hard.
However, you will be in a stronger negotiating position if the package has no
problems on other platforms.</p>
<p>One common gotcha: gcc/clang flags <code>-Wall</code>, <code>-pedantic</code> and <code>-O0</code> do not work
with the default compiler on Solaris.</p></li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="inst.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/hadley/r-pkgs/edit/master/10-src.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
