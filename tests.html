<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 12 Testing | R Packages</title>
<meta name="author" content="Hadley Wickham">
<meta name="author" content="Jennifer Bryan">
<meta name="description" content="Testing is a vital part of package development. It ensures that your code does what you want it to do. Testing, however, adds an additional step to your development workflow. The goal of this...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 12 Testing | R Packages">
<meta property="og:type" content="book">
<meta property="og:url" content="https://r-pkgs.org/tests.html">
<meta property="og:image" content="https://r-pkgs.org/images/cover.png">
<meta property="og:description" content="Testing is a vital part of package development. It ensures that your code does what you want it to do. Testing, however, adds an additional step to your development workflow. The goal of this...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 12 Testing | R Packages">
<meta name="twitter:site" content="@hadley">
<meta name="twitter:description" content="Testing is a vital part of package development. It ensures that your code does what you want it to do. Testing, however, adds an additional step to your development workflow. The goal of this...">
<meta name="twitter:image" content="https://r-pkgs.org/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141182576-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-141182576-1');
  </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Packages</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="whole-game.html"><span class="header-section-number">2</span> The whole game</a></li>
<li><a class="" href="setup.html"><span class="header-section-number">3</span> System setup</a></li>
<li><a class="" href="package-structure-state.html"><span class="header-section-number">4</span> Package structure and state</a></li>
<li><a class="" href="workflows101.html"><span class="header-section-number">5</span> Fundamental development workflows</a></li>
<li><a class="" href="package-within.html"><span class="header-section-number">6</span> The package within</a></li>
<li class="book-part">Package components</li>
<li><a class="" href="r.html"><span class="header-section-number">7</span> R code</a></li>
<li><a class="" href="description.html"><span class="header-section-number">8</span> Package metadata</a></li>
<li><a class="" href="license.html"><span class="header-section-number">9</span> Licensing</a></li>
<li><a class="" href="man.html"><span class="header-section-number">10</span> Object documentation</a></li>
<li><a class="" href="vignettes.html"><span class="header-section-number">11</span> Vignettes: long-form documentation</a></li>
<li><a class="active" href="tests.html"><span class="header-section-number">12</span> Testing</a></li>
<li><a class="" href="namespace.html"><span class="header-section-number">13</span> Namespace</a></li>
<li><a class="" href="data.html"><span class="header-section-number">14</span> External data</a></li>
<li><a class="" href="src.html"><span class="header-section-number">15</span> Compiled code</a></li>
<li><a class="" href="inst.html"><span class="header-section-number">16</span> Installed files</a></li>
<li><a class="" href="misc.html"><span class="header-section-number">17</span> Other components</a></li>
<li class="book-part">Sharing with others</li>
<li><a class="" href="git.html"><span class="header-section-number">18</span> Git and GitHub</a></li>
<li><a class="" href="r-cmd-check.html"><span class="header-section-number">19</span> Automated checking</a></li>
<li><a class="" href="release.html"><span class="header-section-number">20</span> Releasing a package</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/r-pkgs">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="tests" class="section level1">
<h1>
<span class="header-section-number">12</span> Testing<a class="anchor" aria-label="anchor" href="#tests"><i class="fas fa-link"></i></a>
</h1>
<p>Testing is a vital part of package development. It ensures that your code does what you want it to do. Testing, however, adds an additional step to your development workflow. The goal of this chapter is to show you how to make this task easier and more effective by doing formal automated testing using the testthat package.</p>
<p>Up until now, your workflow probably looks like this:</p>
<ol style="list-style-type: decimal">
<li>Write a function.</li>
<li>Load it with Ctrl/Cmd + Shift + L or <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code>.</li>
<li>Experiment with it in the console to see if it works.</li>
<li>Rinse and repeat.</li>
</ol>
<p>While you <em>are</em> testing your code in this workflow, you‚Äôre only doing it informally. The problem with this approach is that when you come back to this code in 3 months time to add a new feature, you‚Äôve probably forgotten some of the informal tests you ran the first time around. This makes it very easy to break code that used to work.</p>
<p>I started using automated tests because I discovered I was spending too much time re-fixing bugs that I‚Äôd already fixed before. While writing code or fixing bugs, I‚Äôd perform interactive tests to make sure the code worked. But I never had a system which could store those tests so I could re-run them as needed. I think that this is a common practice among R programmers. It‚Äôs not that you don‚Äôt test your code, it‚Äôs that you don‚Äôt automate your tests.</p>
<p>In this chapter you‚Äôll learn how to graduate from using informal ad hoc testing, done at the command line, to formal automated testing (aka unit testing). While turning casual interactive tests into reproducible scripts requires a little more work up front, it pays off in four ways:</p>
<ul>
<li><p>Fewer bugs. Because you‚Äôre explicit about how your code should behave
you will have fewer bugs. The reason why is a bit like the reason double
entry book-keeping works: because you describe the behaviour of your code in
two places, both in your code and in your tests, you are able to check one against
the other. By following this approach to testing, you can be sure that bugs
that you‚Äôve fixed in the past will never come back to haunt you.</p></li>
<li><p>Better code structure. Code that‚Äôs easy to test is usually better designed.
This is because writing tests forces you to break up complicated parts of
your code into separate functions that can work in isolation. This reduces
duplication in your code. As a result, functions will be easier to test,
understand and work with (it‚Äôll be easier to combine them in new ways).</p></li>
<li><p>Easier restarts. If you always finish a coding session by creating a failing
test (e.g.¬†for the next feature you want to implement), testing makes it
easier for you to pick up where you left off: your tests will let you know
what to do next.</p></li>
<li><p>Robust code. If you know that all the major functionality of your package has
an associated test, you can confidently make big changes without worrying
about accidentally breaking something. For me, this is particularly useful
when I think I have a simpler way to accomplish a task (usually the reason my
solution is simpler is that I‚Äôve forgotten an important use case!).</p></li>
</ul>
<p>If you‚Äôre familiar with unit testing in other languages, you should note that there are some fundamental differences with testthat. This is because R is, at heart, more a functional programming language than an object oriented programming language. For instance, because R‚Äôs main OO systems (S3 and S4) are based on generic functions (i.e., methods belong to functions not classes), testing approaches built around objects and methods don‚Äôt make much sense.</p>
<div id="test-workflow" class="section level2">
<h2>
<span class="header-section-number">12.1</span> Test workflow<a class="anchor" aria-label="anchor" href="#test-workflow"><i class="fas fa-link"></i></a>
</h2>
<p>To set up your package to use testthat, run:</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_testthat.html">use_testthat</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will:</p>
<ol style="list-style-type: decimal">
<li><p>Create a <code>tests/testthat</code> directory.</p></li>
<li><p>Add testthat to the <code>Suggests</code> field in the <code>DESCRIPTION</code>.</p></li>
<li><p>Create a file <code>tests/testthat.R</code> that runs all your tests when
<code>R CMD check</code> runs. (You‚Äôll learn more about that in
<a href="r-cmd-check.html#r-cmd-check">automated checking</a>.)</p></li>
</ol>
<p>Once you‚Äôre set up the workflow is simple:</p>
<ol style="list-style-type: decimal">
<li><p>Modify your code or tests.</p></li>
<li><p>Test your package with Ctrl/Cmd + Shift + T or <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code>.</p></li>
<li><p>Repeat until all tests pass.</p></li>
</ol>
<p>The testing output looks like this:</p>
<pre><code>Expectation : ...........
rv : ...
Variance : ....123.45.</code></pre>
<p>Each line represents a test file. Each <code>.</code> represents a passed test. Each number represents a failed test. The numbers index into a list of failures that provides more details:</p>
<pre><code>1. Failure(@test-variance.R#22): Variance correct for discrete uniform rvs -----
VAR(dunif(0, 10)) not equal to var_dunif(0, 10)
Mean relative difference: 3

2. Failure(@test-variance.R#23): Variance correct for discrete uniform rvs -----
VAR(dunif(0, 100)) not equal to var_dunif(0, 100)
Mean relative difference: 3.882353</code></pre>
<p>Each failure gives a description of the test (e.g., ‚ÄúVariance correct for discrete uniform rvs‚Äù), its location (e.g., ‚Äú@test-variance.R#22‚Äù), and the reason for the failure (e.g., ‚ÄúVAR(dunif(0, 10)) not equal to var_dunif(0, 10)‚Äù). The goal is to pass all the tests.</p>
</div>
<div id="test-structure" class="section level2">
<h2>
<span class="header-section-number">12.2</span> Test structure<a class="anchor" aria-label="anchor" href="#test-structure"><i class="fas fa-link"></i></a>
</h2>
<p>A test file lives in <code>tests/testthat/</code>. Its name must start with <code>test</code>. Here‚Äôs an example of a test file from the stringr package:</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">context</a></span><span class="op">(</span><span class="st">"String length"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"str_length is number of characters"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="st">"ab"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="st">"abc"</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> üéä</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"str_length of factor is length of level"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="st">"ab"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="st">"abc"</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ü•≥</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"str_length of missing is missing"</span>, <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>, <span class="cn">NA_integer_</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html">str_length</a></span><span class="op">(</span><span class="st">"NA"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ü•á</span></code></pre></div>
<p>Tests are organised hierarchically: <strong>expectations</strong> are grouped into <strong>tests</strong> which are organised in <strong>files</strong>:</p>
<ul>
<li><p>An <strong>expectation</strong> is the atom of testing. It describes the expected result
of a computation: Does it have the right value and right class? Does it
produce error messages when it should? An expectation automates visual
checking of results in the console. Expectations are functions that start
with <code>expect_</code>.</p></li>
<li><p>A <strong>test</strong> groups together multiple expectations to test the output
from a simple function, a range of possibilities for a single parameter
from a more complicated function, or tightly related functionality from
across multiple functions. This is why they are sometimes called <strong>unit</strong>
as they test one unit of functionality. A test is created with <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> .</p></li>
<li><p>A <strong>file</strong> groups together multiple related tests. Files are given a human
readable name with <code><a href="https://dplyr.tidyverse.org/reference/context.html">context()</a></code>.</p></li>
</ul>
<p>These are described in detail below.</p>
<div id="expectations" class="section level3">
<h3>
<span class="header-section-number">12.2.1</span> Expectations<a class="anchor" aria-label="anchor" href="#expectations"><i class="fas fa-link"></i></a>
</h3>
<p>An expectation is the finest level of testing. It makes a binary assertion about whether or not a function call does what you expect. All expectations have a similar structure:</p>
<ul>
<li><p>They start with <code>expect_</code>.</p></li>
<li><p>They have two arguments: the first is the actual result, the second is what
you expect.</p></li>
<li><p>If the actual and expected results don‚Äôt agree, testthat throws an error.</p></li>
</ul>
<p>While you‚Äôll normally put expectations inside tests inside files, you can also run them directly. This makes it easy to explore expectations interactively. There are almost 20 expectations in the testthat package. The most important are discussed below.</p>
<ul>
<li>
<p>There are two basic ways to test for equality: <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal()</a></code>,
and <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical()</a></code>. <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal()</a></code> is the most commonly used: it
uses <code><a href="https://rdrr.io/r/base/all.equal.html">all.equal()</a></code> to check for equality within a numerical tolerance:</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span> <span class="op">+</span> <span class="fl">1e-7</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">11</span><span class="op">)</span></code></pre></div>
<p>If you want to test for exact equivalence, or need to compare a more
exotic object like an environment, use <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical()</a></code>. It‚Äôs built
on top of <code><a href="https://rdrr.io/r/base/identical.html">identical()</a></code>:</p>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span> <span class="op">+</span> <span class="fl">1e-7</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span> <span class="op">+</span> <span class="fl">1e-7</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p><code><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match()</a></code> matches a character vector against a regular expression.
The optional <code>all</code> argument controls whether all elements or just one
element needs to match. This is powered by <code><a href="https://rdrr.io/r/base/grep.html">grepl()</a></code> (additional arguments
like <code>ignore.case = FALSE</code> or <code>fixed = TRUE</code> are passed on down).</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">string</span> <span class="op">&lt;-</span> <span class="st">"Testing is fun!"</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="va">string</span>, <span class="st">"Testing"</span><span class="op">)</span> 

<span class="co"># Fails, match is case-sensitive</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="va">string</span>, <span class="st">"testing"</span><span class="op">)</span>

<span class="co"># Additional arguments are passed to grepl:</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="va">string</span>, <span class="st">"testing"</span>, ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p>Four variations of <code><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match()</a></code> let you check for other types of
result: <code><a href="https://testthat.r-lib.org/reference/expect_output.html">expect_output()</a></code>, inspects printed output; <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_message()</a></code>,
messages; <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning()</a></code>, warnings; and <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error()</a></code> errors.</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">letters</span><span class="op">)</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span>, <span class="st">"List of 2"</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_output.html">expect_output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span>, <span class="st">"int [1:10]"</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_message</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span>, <span class="st">"This is mgcv"</span><span class="op">)</span></code></pre></div>
<p>With <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_message()</a></code>, <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning()</a></code>, <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error()</a></code> you can
leave the second argument blank if you just want to see if a message,
warning or error is created. However, it‚Äôs normally better to be explicit,
and provide some text from the message.</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="st">"a"</span><span class="op">)</span> 

<span class="co"># But always better to be explicit</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"NaNs produced"</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="st">"a"</span>, <span class="st">"non-numeric argument"</span><span class="op">)</span>

<span class="co"># Failure to produce a warning or error when an error is expected</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> </code></pre></div>
</li>
<li>
<p><code><a href="https://testthat.r-lib.org/reference/expect_is.html">expect_is()</a></code> checks that an object <code>inherit()</code>s from a specified class.</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_is.html">expect_is</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"lm"</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/expect_is.html">expect_is</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"glm"</span><span class="op">)</span></code></pre></div>
</li>
<li><p><code><a href="https://testthat.r-lib.org/reference/logical-expectations.html">expect_true()</a></code> and <code><a href="https://testthat.r-lib.org/reference/logical-expectations.html">expect_false()</a></code> are useful catchalls if none of the
other expectations do what you need.</p></li>
<li><p>Sometimes you don‚Äôt know exactly what the result should be, or it‚Äôs too
complicated to easily recreate in code. In that case the best you can do is
check that the result is the same as last time. <code><a href="https://testthat.r-lib.org/reference/expect_known_output.html">expect_equal_to_reference()</a></code>
caches the result the first time its run, and then compares it to subsequent
runs. If for some reason the result does change, just delete the cache (*)
file and re-test.</p></li>
</ul>
<p>Running a sequence of expectations is useful because it ensures that your code behaves as expected. You could even use an expectation within a function to check that the inputs are what you expect. However, they‚Äôre not so useful when something goes wrong. All you know is that something is not as expected. You don‚Äôt know the goal of the expectation. Tests, described next, organise expectations into coherent blocks that describe the overall goal of a set of expectations.</p>
</div>
</div>
<div id="test-tests" class="section level2">
<h2>
<span class="header-section-number">12.3</span> Writing tests<a class="anchor" aria-label="anchor" href="#test-tests"><i class="fas fa-link"></i></a>
</h2>
<p>Each test should have an informative name and cover a single unit of functionality. The idea is that when a test fails, you‚Äôll know what‚Äôs wrong and where in your code to look for the problem. You create a new test using <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code>, with test name and code block as arguments. The test name should complete the sentence ‚ÄúTest that ‚Ä¶‚Äù. The code block should be a collection of expectations.</p>
<p>It‚Äôs up to you how to organise your expectations into tests. The main thing is that the message associated with the test should be informative so that you can quickly narrow down the source of the problem. Try to avoid putting too many expectations in one test - it‚Äôs better to have more smaller tests than fewer larger tests.</p>
<p>Each test is run in its own environment and is self-contained. However, testthat doesn‚Äôt know how to cleanup after actions that affect the R landscape:</p>
<ul>
<li><p>The filesystem: creating and deleting files, changing the working directory,
etc.</p></li>
<li><p>The search path: <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>, <code><a href="https://rdrr.io/r/base/attach.html">attach()</a></code>.</p></li>
<li><p>Global options, like <code><a href="https://rdrr.io/r/base/options.html">options()</a></code> and <code><a href="https://rdrr.io/r/graphics/par.html">par()</a></code>.</p></li>
</ul>
<p>When you use these actions in tests, you‚Äôll need to clean up after yourself. While many other testing packages have set-up and teardown methods that are run automatically before and after each test, these are not so important with testthat because you can create objects outside of the tests and you can rely on R‚Äôs copy-on-modify semantics to keep them unchanged between test runs. To clean up other actions you can use regular R functions.</p>
<div id="what-to-test" class="section level3">
<h3>
<span class="header-section-number">12.3.1</span> What to test<a class="anchor" aria-label="anchor" href="#what-to-test"><i class="fas fa-link"></i></a>
</h3>
<blockquote>
<p>Whenever you are tempted to type something into a print statement or a
debugger expression, write it as a test instead.
‚Äî Martin Fowler</p>
</blockquote>
<p>There is a fine balance to writing tests. Each test that you write makes your code less likely to change inadvertently; but it also can make it harder to change your code on purpose. It‚Äôs hard to give good general advice about writing tests, but you might find these points helpful:</p>
<ul>
<li><p>Focus on testing the external interface to your functions - if you test the
internal interface, then it‚Äôs harder to change the implementation in the
future because as well as modifying the code, you‚Äôll also need to update all
the tests.</p></li>
<li><p>Strive to test each behaviour in one and only one test. Then if that
behaviour later changes you only need to update a single test.</p></li>
<li><p>Avoid testing simple code that you‚Äôre confident will work. Instead focus your
time on code that you‚Äôre not sure about, is fragile, or has complicated
interdependencies. That said, I often find I make the most mistakes when I
falsely assume that the problem is simple and doesn‚Äôt need any tests.</p></li>
<li><p>Always write a test when you discover a bug. You may find it helpful to adopt
the test-first philosophy. There you always start by writing the tests, and
then write the code that makes them pass. This reflects an important problem
solving strategy: start by establishing your success criteria, how you
know if you‚Äôve solved the problem.</p></li>
</ul>
</div>
<div id="skipping-a-test" class="section level3">
<h3>
<span class="header-section-number">12.3.2</span> Skipping a test<a class="anchor" aria-label="anchor" href="#skipping-a-test"><i class="fas fa-link"></i></a>
</h3>
<p>Sometimes it‚Äôs impossible to perform a test - you may not have an internet connection or you may be missing an important file. Unfortunately, another likely reason follows from this simple rule: the more machines you use to write your code, the more likely it is that you won‚Äôt be able to run all of your tests. In short, there are times when, instead of getting a failure, you just want to skip a test. To do that, you can use the <code><a href="https://testthat.r-lib.org/reference/skip.html">skip()</a></code> function - rather than throwing an error it simply prints an <code>S</code> in the output.</p>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">check_api</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu">not_working</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip</a></span><span class="op">(</span><span class="st">"API not available"</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns bar when given baz"</span>, <span class="op">{</span>
  <span class="fu">check_api</span><span class="op">(</span><span class="op">)</span>
  <span class="va">...</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div id="building-your-own-testing-tools" class="section level3">
<h3>
<span class="header-section-number">12.3.3</span> Building your own testing tools<a class="anchor" aria-label="anchor" href="#building-your-own-testing-tools"><i class="fas fa-link"></i></a>
</h3>
<p>As you start to write more tests, you might notice duplication in your code. For example, the following code shows one test of the <code><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date()</a></code> function from <code><a href="https://lubridate.tidyverse.org">library(lubridate)</a></code>. There are seven expectations that check the results of rounding a date down to the nearest second, minute, hour, etc. There‚Äôs a lot of duplication (which increases the chance of bugs), so we might want to extract common behaviour into a new function.</p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'lubridate'</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     date, intersect, setdiff, union</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"floor_date works for different units"</span>, <span class="op">{</span>
  <span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-03 12:01:59.23"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>

  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="st">"second"</span><span class="op">)</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-03 12:01:59"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="st">"minute"</span><span class="op">)</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-03 12:01:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="st">"hour"</span><span class="op">)</span>,   
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-03 12:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="st">"day"</span><span class="op">)</span>,    
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-03 00:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="st">"week"</span><span class="op">)</span>,   
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-02 00:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="st">"month"</span><span class="op">)</span>,  
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-01 00:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="st">"year"</span><span class="op">)</span>,   
    <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-01-01 00:00:00"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> üéä</span></code></pre></div>
<p>I‚Äôd start by defining a couple of helper functions to make each expectation more concise. That allows each test to fit on one line, so you can line up actual and expected values to make it easier to see the differences:</p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"floor_date works for different units"</span>, <span class="op">{</span>
  <span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-03 12:01:59.23"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
  <span class="va">floor_base</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="va">unit</span><span class="op">)</span>
  <span class="va">as_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>

  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">floor_base</span><span class="op">(</span><span class="st">"second"</span><span class="op">)</span>, <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-08-03 12:01:59"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">floor_base</span><span class="op">(</span><span class="st">"minute"</span><span class="op">)</span>, <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-08-03 12:01:00"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">floor_base</span><span class="op">(</span><span class="st">"hour"</span><span class="op">)</span>,   <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-08-03 12:00:00"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">floor_base</span><span class="op">(</span><span class="st">"day"</span><span class="op">)</span>,    <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-08-03 00:00:00"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">floor_base</span><span class="op">(</span><span class="st">"week"</span><span class="op">)</span>,   <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-08-02 00:00:00"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">floor_base</span><span class="op">(</span><span class="st">"month"</span><span class="op">)</span>,  <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-08-01 00:00:00"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">floor_base</span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>,   <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-01-01 00:00:00"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ü•á</span></code></pre></div>
<p>We could go a step further and create a custom expectation function:</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-08-03 12:01:59.23"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>

<span class="va">expect_floor_equal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">unit</span>, <span class="va">time</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="va">unit</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">time</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"2009-01-01 00:00:00"</span><span class="op">)</span></code></pre></div>
<p>However, if the expectation fails this doesn‚Äôt give very informative output:</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"2008-01-01 00:00:00"</span><span class="op">)</span></code></pre></div>
<p>Instead you can use a little <a href="https://adv-r.hadley.nz/metaprogramming.html">non-standard evaluation</a> to produce something more informative. The key is to use <code><a href="https://rdrr.io/r/base/bquote.html">bquote()</a></code> and <code><a href="https://rdrr.io/r/base/eval.html">eval()</a></code>. In the <code><a href="https://rdrr.io/r/base/bquote.html">bquote()</a></code> call below, note the use of <code>.(x)</code> - the contents of <code>()</code> will be inserted into the call.</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">expect_floor_equal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">unit</span>, <span class="va">time</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">as_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html">bquote</a></span><span class="op">(</span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="fu">.</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span><span class="op">)</span>, <span class="fu">as_time</span><span class="op">(</span><span class="fu">.</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"2008-01-01 00:00:00"</span><span class="op">)</span></code></pre></div>
<p>This sort of refactoring is often worthwhile because removing redundant code makes it easier to see what‚Äôs changing. Readable tests give you more confidence that they‚Äôre correct.</p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"floor_date works for different units"</span>, <span class="op">{</span>
  <span class="va">as_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
  <span class="va">expect_floor_equal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">unit</span>, <span class="va">time</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html">bquote</a></span><span class="op">(</span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">base</span>, <span class="fu">.</span><span class="op">(</span><span class="va">unit</span><span class="op">)</span><span class="op">)</span>, <span class="fu">as_time</span><span class="op">(</span><span class="fu">.</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">base</span> <span class="op">&lt;-</span> <span class="fu">as_time</span><span class="op">(</span><span class="st">"2009-08-03 12:01:59.23"</span><span class="op">)</span>
  <span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"second"</span>, <span class="st">"2009-08-03 12:01:59"</span><span class="op">)</span>
  <span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"minute"</span>, <span class="st">"2009-08-03 12:01:00"</span><span class="op">)</span>
  <span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"hour"</span>,   <span class="st">"2009-08-03 12:00:00"</span><span class="op">)</span>
  <span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"day"</span>,    <span class="st">"2009-08-03 00:00:00"</span><span class="op">)</span>
  <span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"week"</span>,   <span class="st">"2009-08-02 00:00:00"</span><span class="op">)</span>
  <span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"month"</span>,  <span class="st">"2009-08-01 00:00:00"</span><span class="op">)</span>
  <span class="fu">expect_floor_equal</span><span class="op">(</span><span class="st">"year"</span>,   <span class="st">"2009-01-01 00:00:00"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> üåà</span></code></pre></div>
</div>
</div>
<div id="test-files" class="section level2">
<h2>
<span class="header-section-number">12.4</span> Test files<a class="anchor" aria-label="anchor" href="#test-files"><i class="fas fa-link"></i></a>
</h2>
<p>The highest-level structure of tests is the file. Each file should contain a single <code><a href="https://dplyr.tidyverse.org/reference/context.html">context()</a></code> call that provides a brief description of its contents. Just like the files in the <code>R/</code> directory, you are free to organise your tests any way that you like. But again, the two extremes are clearly bad (all tests in one file, one file per test). You need to find a happy medium that works for you. A good starting place is to have one file of tests for each complicated function.</p>
</div>
<div id="test-cran" class="section level2">
<h2>
<span class="header-section-number">12.5</span> CRAN notes<a class="anchor" aria-label="anchor" href="#test-cran"><i class="fas fa-link"></i></a>
</h2>
<p>CRAN will run your tests on all CRAN platforms: Windows, Mac, Linux and Solaris. There are a few things to bear in mind:</p>
<ul>
<li><p>Tests need to run relatively quickly - aim for under a minute. Place
<code><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran()</a></code> at the beginning of long-running tests that shouldn‚Äôt be run
on CRAN - they‚Äôll still be run locally, but not on CRAN.</p></li>
<li><p>Note that tests are always run in the English language (<code>LANGUAGE=EN</code>) and
with C sort order (<code>LC_COLLATE=C</code>). This minimises spurious differences
between platforms.</p></li>
<li><p>Be careful about testing things that are likely to be variable on CRAN
machines. It‚Äôs risky to test how long something takes (because CRAN machines
are often heavily loaded) or to test parallel code (because CRAN runs multiple
package tests in parallel, multiple cores will not always be available).
Numerical precision can also vary across platforms (it‚Äôs often less precise on
32-bit versions of R) so use <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal()</a></code> rather than <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical()</a></code>.</p></li>
</ul>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="vignettes.html"><span class="header-section-number">11</span> Vignettes: long-form documentation</a></div>
<div class="next"><a href="namespace.html"><span class="header-section-number">13</span> Namespace</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#tests"><span class="header-section-number">12</span> Testing</a></li>
<li><a class="nav-link" href="#test-workflow"><span class="header-section-number">12.1</span> Test workflow</a></li>
<li>
<a class="nav-link" href="#test-structure"><span class="header-section-number">12.2</span> Test structure</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#expectations"><span class="header-section-number">12.2.1</span> Expectations</a></li></ul>
</li>
<li>
<a class="nav-link" href="#test-tests"><span class="header-section-number">12.3</span> Writing tests</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#what-to-test"><span class="header-section-number">12.3.1</span> What to test</a></li>
<li><a class="nav-link" href="#skipping-a-test"><span class="header-section-number">12.3.2</span> Skipping a test</a></li>
<li><a class="nav-link" href="#building-your-own-testing-tools"><span class="header-section-number">12.3.3</span> Building your own testing tools</a></li>
</ul>
</li>
<li><a class="nav-link" href="#test-files"><span class="header-section-number">12.4</span> Test files</a></li>
<li><a class="nav-link" href="#test-cran"><span class="header-section-number">12.5</span> CRAN notes</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/r-pkgs/blob/main/testing.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/r-pkgs/edit/main/testing.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Packages</strong>" was written by Hadley Wickham, Jennifer Bryan. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
