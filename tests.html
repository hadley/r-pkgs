<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 13 Testing | R Packages</title>
<meta name="author" content="Hadley Wickham">
<meta name="author" content="Jennifer Bryan">
<meta name="description" content="Testing is a vital part of package development. It ensures that your code does what you want it to do. Testing, however, adds an additional step to your development workflow. The goal of this...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 13 Testing | R Packages">
<meta property="og:type" content="book">
<meta property="og:url" content="https://r-pkgs.org/tests.html">
<meta property="og:image" content="https://r-pkgs.org/images/cover.png">
<meta property="og:description" content="Testing is a vital part of package development. It ensures that your code does what you want it to do. Testing, however, adds an additional step to your development workflow. The goal of this...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 13 Testing | R Packages">
<meta name="twitter:site" content="@hadley">
<meta name="twitter:description" content="Testing is a vital part of package development. It ensures that your code does what you want it to do. Testing, however, adds an additional step to your development workflow. The goal of this...">
<meta name="twitter:image" content="https://r-pkgs.org/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141182576-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141182576-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Packages</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="whole-game.html"><span class="header-section-number">2</span> The whole game</a></li>
<li><a class="" href="setup.html"><span class="header-section-number">3</span> System setup</a></li>
<li><a class="" href="package-structure-state.html"><span class="header-section-number">4</span> Package structure and state</a></li>
<li><a class="" href="workflows101.html"><span class="header-section-number">5</span> Fundamental development workflows</a></li>
<li><a class="" href="package-within.html"><span class="header-section-number">6</span> The package within</a></li>
<li class="book-part">Package components</li>
<li><a class="" href="r.html"><span class="header-section-number">7</span> R code</a></li>
<li><a class="" href="data.html"><span class="header-section-number">8</span> Data</a></li>
<li><a class="" href="misc.html"><span class="header-section-number">9</span> Other components</a></li>
<li class="book-part">Package metadata</li>
<li><a class="" href="description-and-namespace.html"><span class="header-section-number">10</span> DESCRIPTION and NAMESPACE</a></li>
<li><a class="" href="description-dependencies.html"><span class="header-section-number">11</span> Dependencies: What does your package need?</a></li>
<li><a class="" href="license.html"><span class="header-section-number">12</span> Licensing</a></li>
<li class="book-part">Testing</li>
<li><a class="active" href="tests.html"><span class="header-section-number">13</span> Testing</a></li>
<li class="book-part">Documentation</li>
<li><a class="" href="doc-intro.html"><span class="header-section-number">14</span> Introduction</a></li>
<li><a class="" href="man.html"><span class="header-section-number">15</span> Function documentation</a></li>
<li><a class="" href="vignettes.html"><span class="header-section-number">16</span> Vignettes</a></li>
<li><a class="" href="important-files.html"><span class="header-section-number">17</span> Other markdown files</a></li>
<li><a class="" href="website.html"><span class="header-section-number">18</span> Website</a></li>
<li class="book-part">Maintenance and distribution</li>
<li><a class="" href="r-cmd-check.html"><span class="header-section-number">19</span> R CMD check</a></li>
<li><a class="" href="continuous-integration.html"><span class="header-section-number">20</span> Continuous integration</a></li>
<li><a class="" href="release.html"><span class="header-section-number">21</span> Releasing to CRAN</a></li>
<li><a class="" href="lifecycle.html"><span class="header-section-number">22</span> Lifecycle</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/r-pkgs">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="tests" class="section level1" number="13">
<h1>
<span class="header-section-number">13</span> Testing<a class="anchor" aria-label="anchor" href="#tests"><i class="fas fa-link"></i></a>
</h1>
<p>Testing is a vital part of package development.
It ensures that your code does what you want it to do.
Testing, however, adds an additional step to your development workflow.
The goal of this chapter is to show you how to make this task easier and more effective by doing formal automated testing using the testthat package.</p>
<p>The first stage of your testing journey is to become convinced that testing has enough benefits to justify the work.
For some of us, this is easy to accept.
Others must learn the hard way.</p>
<p>Once youâ€™ve decided to embrace automated testing, itâ€™s time to learn some mechanics and figure out where testing fits into your development workflow.</p>
<p>As you and your R packages evolve, youâ€™ll start to encounter testing situations where itâ€™s fruitful to use techniques that are somewhat specific to testing and differ from what we do below <code>R/</code>.</p>
<div id="why-is-formal-testing-worth-the-trouble" class="section level2" number="13.1">
<h2>
<span class="header-section-number">13.1</span> Why is formal testing worth the trouble?<a class="anchor" aria-label="anchor" href="#why-is-formal-testing-worth-the-trouble"><i class="fas fa-link"></i></a>
</h2>
<p>Up until now, your workflow probably looks like this:</p>
<ol style="list-style-type: decimal">
<li>Write a function.</li>
<li>Load it with <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code>, maybe via Ctrl/Cmd + Shift + L.</li>
<li>Experiment with it in the console to see if it works.</li>
<li>Rinse and repeat.</li>
</ol>
<p>While you <em>are</em> testing your code in this workflow, youâ€™re only doing it informally.
The problem with this approach is that when you come back to this code in 3 months time to add a new feature, youâ€™ve probably forgotten some of the informal tests you ran the first time around.
This makes it very easy to break code that used to work.</p>
<p>Many of us embrace automated testing when we realize weâ€™re re-fixing a bug for the second or fifth time.
While writing code or fixing bugs, we might perform some interactive tests to make sure the code weâ€™re working on does what we want.
But itâ€™s easy to forget all the different use cases you need to check, if you donâ€™t have a system for storing and re-running the tests.
This is a common practice among R programmers.
The problem is not that you donâ€™t test your code, itâ€™s that you donâ€™t automate your tests.</p>
<p>In this chapter youâ€™ll learn how to transition from informal <em>ad hoc</em> testing, done interactively in the console, to automated testing (also known as unit testing).
While turning casual interactive tests into formal tests requires a little more work up front, it pays off in four ways:</p>
<ul>
<li>
<p>Fewer bugs.
Because youâ€™re explicit about how your code should behave, you will have fewer
bugs.
The reason why is a bit like the reason double entry book-keeping works:
because you describe the behaviour of your code in two places, both in your
code and in your tests, you are able to check one against the other.</p>
<p>With informal testing, itâ€™s tempting to just explore typical and authentic
usage, similar to writing examples.
However, when writing formal tests, itâ€™s natural to adopt a more adversarial
mindset and to anticipate how unexpected inputs could break your code.</p>
<p>If you always introduce new tests when you add a new feature or function,
youâ€™ll prevent many bugs from being created in the first place,
because you will proactively address pesky edge cases.
Tests also keep you from (re-)breaking one feature, when youâ€™re tinkering with
another.</p>
</li>
<li><p>Better code structure.
Code that is well designed tends to be easy to test and you can turn this to
your advantage.
If you are struggling to write tests, consider if the problem is
actually the design of your function(s).
The process of writing tests is a great way to get free, private, and
personalized feedback on how well-factored your code is.
If you integrate testing into your development workflow (versus planning to
slap tests on â€œlaterâ€), youâ€™ll subject yourself to constant pressure to break
complicated operations into separate functions that work in isolation.
Functions that are easier to test are usually easier to understand and
re-combine in new ways.</p></li>
<li><p>Call to action.
When we start to fix a bug, we first like to convert it into a (failing) test.
This is wonderfully effective at making your goal very concrete:
make this test pass.
This is basically a special case of a general methodology known as test driven
development.</p></li>
<li><p>Robust code.
If you know that all the major functionality of your package is well covered
by the tests, you can confidently make big changes without worrying about
accidentally breaking something.
This provides a great reality check when you think youâ€™ve discovered some
brilliant new way to simplify your package.
Sometimes such â€œsimplificationsâ€ fail to account for some important use case
and your tests will save you from yourself.</p></li>
</ul>
</div>
<div id="introducing-testthat" class="section level2" number="13.2">
<h2>
<span class="header-section-number">13.2</span> Introducing testthat<a class="anchor" aria-label="anchor" href="#introducing-testthat"><i class="fas fa-link"></i></a>
</h2>
<p>This chapter describes how to test your R package using the testthat package:
<a href="https://testthat.r-lib.org" class="uri">https://testthat.r-lib.org</a></p>
<p>If youâ€™re familiar with frameworks for unit testing in other languages, you should note that there are some fundamental differences with testthat.
This is because R is, at heart, more a functional programming language than an object-oriented programming language.
For instance, because Râ€™s main object-oriented systems (S3 and S4) are based on generic functions (i.e., methods belong to functions not classes), testing approaches built around objects and methods donâ€™t make much sense.</p>
<p>testthat 3.0.0 (released 2020-10-31) introduced the idea of an <strong>edition</strong> of testthat, specifically the third edition of testthat, which we refer to as testthat 3e.
An edition is a bundle of behaviors that you have to explicitly choose to use, allowing us to make otherwise backward incompatible changes.
This is particularly important for testthat since it has a very large number of packages that use it (almost 5,000 at last count).
To use testthat 3e, you must have a version of testthat &gt;= 3.0.0 <strong>and</strong> explicitly opt-in to the third edition behaviors.
This allows testthat to continue to evolve and improve without breaking historical packages that are in a rather passive maintenance phase.
You can learn more in the <a href="https://testthat.r-lib.org/articles/third-edition.html">testthat 3e article</a> and the blog post <a href="https://www.tidyverse.org/blog/2022/02/upkeep-testthat-3/">Upgrading to testthat edition 3</a>.</p>
<p>We recommend testthat 3e for all new packages and we recommend updating existing, actively maintained packages to use testthat 3e.
Unless we say otherwise, this chapter describes testthat 3e.</p>
</div>
<div id="tests-mechanics-workflow" class="section level2" number="13.3">
<h2>
<span class="header-section-number">13.3</span> Test mechanics and workflow<a class="anchor" aria-label="anchor" href="#tests-mechanics-workflow"><i class="fas fa-link"></i></a>
</h2>
<div id="initial-setup" class="section level3" number="13.3.1">
<h3>
<span class="header-section-number">13.3.1</span> Initial setup<a class="anchor" aria-label="anchor" href="#initial-setup"><i class="fas fa-link"></i></a>
</h3>
<p>To setup your package to use testthat, run:</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_testthat.html">use_testthat</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>This will:</p>
<ol style="list-style-type: decimal">
<li><p>Create a <code>tests/testthat/</code> directory.</p></li>
<li>
<p>Add testthat to the <code>Suggests</code> field in the <code>DESCRIPTION</code>.
Specify testthat 3e in the <code>Config/testthat/edition</code> field.
The affected <code>DESCRIPTION</code> fields might look like:</p>
<pre><code>Suggests: testthat (&gt;= 3.0.0)
Config/testthat/edition: 3</code></pre>
</li>
<li>
<p>Create a file <code>tests/testthat.R</code> that runs all your tests when
<code>R CMD check</code> runs. (Youâ€™ll learn more about that in
<a href="r-cmd-check.html#r-cmd-check">automated checking</a>.)
The contents of this file will be something like:</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">abcde</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_package.html">test_check</a></span><span class="op">(</span><span class="st">"abcde"</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
<p>This initial setup is usually something you do once per package.
However, even in a package that already uses testthat, it is safe to run <code>use_testthat(3)</code>, when youâ€™re ready to opt-in to testthat 3e.</p>
<p>Do not edit <code>tests/testthat.R</code>!
It is run during <code>R CMD check</code> (and, therefore, <code><a href="https://devtools.r-lib.org/reference/check.html">devtools::check()</a></code>), but is not used in most other test-running scenarios (such as <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code> or <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test_active_file()</a></code>).
If you want to do something that affects all of your tests, there is almost always a better way than modifying the boilerplate <code>tests/testthat.R</code> script.
This chapter details many different ways to make objects and logic available during testing.</p>
</div>
<div id="create-a-test" class="section level3" number="13.3.2">
<h3>
<span class="header-section-number">13.3.2</span> Create a test<a class="anchor" aria-label="anchor" href="#create-a-test"><i class="fas fa-link"></i></a>
</h3>
<p>As you define functions in your package, in the files below <code>R/</code>, you add the corresponding tests to <code>.R</code> files in <code>tests/testthat/</code>.
We strongly recommend that the organisation of test files match the organisation of <code>R/</code> files, discussed in section <a href="r.html#code-organising">7.1</a>:
The <code>foofy()</code> function (and its friends and helpers) should be defined in <code>R/foofy.R</code> and their tests should live in <code>tests/testthat/test-foofy.R</code>.</p>
<pre><code>R                                     tests/testthat
â””â”€â”€ foofy.R                           â””â”€â”€ test-foofy.R
    foofy &lt;- function(...) {...}          test_that("foofy does this", {...})
                                          test_that("foofy does that", {...})</code></pre>
<p>Even if you have different conventions for file organisation and naming, note that testthat tests <strong>must</strong> live in files below <code>tests/testthat/</code> and these file names <strong>must</strong> begin with <code>test</code>.
The test file name is displayed in testthat output, which provides helpful context<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The legacy function &lt;code&gt;testthat::context()&lt;/code&gt; is superseded now and its use in new or actively maintained code is discouraged.
In testthat 3e, &lt;code&gt;context()&lt;/code&gt; is formally deprecated; you should just remove it.
Once you adopt an intentional, synchronized approach to the organisation of files below &lt;code&gt;R/&lt;/code&gt; and &lt;code&gt;tests/testthat/&lt;/code&gt;, the necessary contextual information is right there in the file name, rendering the legacy &lt;code&gt;context()&lt;/code&gt; superfluous.&lt;/p&gt;"><sup>27</sup></a>.</p>
<!-- Hadley thinks this is too much detail about use_r()/use_test(). I will likely agree when I revisit this later. Leaving it for now. -->
<p>usethis offers a helpful pair of functions for creating or toggling between files:</p>
<ul>
<li><code><a href="https://usethis.r-lib.org/reference/use_r.html">usethis::use_r()</a></code></li>
<li><code><a href="https://usethis.r-lib.org/reference/use_r.html">usethis::use_test()</a></code></li>
</ul>
<p>Either one can be called with a file (base) name, in order to create a file <em>de novo</em> and open it for editing:</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_r.html">use_r</a></span><span class="op">(</span><span class="st">"foofy"</span><span class="op">)</span>    <span class="co"># creates and opens R/foofy.R</span></span>
<span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_r.html">use_test</a></span><span class="op">(</span><span class="st">"blarg"</span><span class="op">)</span> <span class="co"># creates and opens tests/testthat/test-blarg.R</span></span></code></pre></div>
<p>The <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_r()</a></code> / <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_test()</a></code> duo has some convenience features that make them â€œjust workâ€ in many common situations:</p>
<ul>
<li>When determining the target file, they can deal with the presence or absence
of the <code>.R</code> extension and the <code>test-</code> prefix.
<ul>
<li>Equivalent: <code>use_r("foofy.R")</code>, <code>use_r("foofy")</code>
</li>
<li>Equivalent: <code>use_test("test-blarg.R")</code>, <code>use_test("blarg.R")</code>, <code>use_test("blarg")</code>
</li>
</ul>
</li>
<li>If the target file already exists, it is opened for editing. Otherwise, the
target is created and then opened for editing.</li>
</ul>
<div class="rstudio-tip">
<p>If <code>R/foofy.R</code> is the active file in your source editor, you can even call <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_test()</a></code> with no arguments!
The target test file can be inferred: if youâ€™re editing <code>R/foofy.R</code>, you probably want to work on the companion test file, <code>tests/testthat/test-foofy.R</code>.
If it doesnâ€™t exist yet, it is created and, either way, the test file is opened for editing.
This all works the other way around also.
If youâ€™re editing <code>tests/testthat/test-foofy.R</code>, a call to <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_r()</a></code> (optionally, creates and) opens <code>R/foofy.R</code>.</p>
</div>
<p>Bottom line: <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_r()</a></code> / <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_test()</a></code> are handy for initially creating these file pairs and, later, for shifting your attention from one to the other.</p>
<p>When <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_test()</a></code> creates a new test file, it inserts an example test:</p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"multiplication works"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>You will replace this with your own logic, but itâ€™s a nice reminder of the basic form:</p>
<ul>
<li>A test file holds one or more <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> tests.</li>
<li>Each test describes what itâ€™s testing: e.g.Â â€œmultiplication worksâ€.</li>
<li>Each test has one or more expectations: e.g.Â <code>expect_equal(2 * 2, 4)</code>.</li>
</ul>
<p>Below we go into much more detail about how to test your own functions.</p>
</div>
<div id="run-tests" class="section level3" number="13.3.3">
<h3>
<span class="header-section-number">13.3.3</span> Run tests<a class="anchor" aria-label="anchor" href="#run-tests"><i class="fas fa-link"></i></a>
</h3>
<p>Depending on where you are in the development cycle, youâ€™ll run your tests at various scales.
When you are rapidly iterating on a function, you might work at the level of individual tests.
As the code settles down, youâ€™ll run entire test files and eventually the entire test suite.</p>
<p><strong>Micro-iteration</strong>: This is the interactive phase where you initiate and refine a function and its tests in tandem.
Here you will run <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> often, and then execute individual expectations or whole tests interactively in the console.
Note that <code><a href="https://devtools.r-lib.org/reference/load_all.html">load_all()</a></code> attaches testthat, so it puts you in the perfect position to test drive your functions and to execute individual tests and expectations.</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tweak the foofy() function and re-load it</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># interactively explore and refine expectations and tests</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">foofy</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>, <span class="va">EXPECTED_FOOFY_OUTPUT</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">testthat</span><span class="op">(</span><span class="st">"foofy does good things"</span>, <span class="op">{</span><span class="va">...</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><strong>Mezzo-iteration</strong>: As one fileâ€™s-worth of functions and their associated tests start to shape up, you will want to execute the entire file of associated tests, perhaps with <code><a href="https://testthat.r-lib.org/reference/test_file.html">testthat::test_file()</a></code>:</p>
<!-- `devtools::test_file()` exists, but is deprecated, because of the collision.

Consider marking as defunct / removing before the book is published. -->
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-foofy.R"</span><span class="op">)</span></span></code></pre></div>
<div class="rstudio-tip">
<p>In RStudio, you have a couple shortcuts for running a single test file.</p>
<p>If the target test file is the active file, you can use the â€œRun Testsâ€ button in the upper right corner of the source editor.</p>
<p>There is also a useful function, <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test_active_file()</a></code>.
It infers the target test file from the active file and, similar to how <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_r()</a></code> and <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_test()</a></code> work, it works regardless of whether the active file is a test file or a companion <code>R/*.R</code> file.
You can invoke this via â€œRun a test fileâ€ in the Addins menu.
However, for heavy users (like us!), we recommend <a href="https://support.rstudio.com/hc/en-us/articles/206382178-Customizing-Keyboard-Shortcuts-in-the-RStudio-IDE">binding this to a keyboard shortcut</a>; we use Ctrl/Cmd + T.</p>
</div>
<p><strong>Macro-iteration</strong>: As you near the completion of a new feature or bug fix, you will want to run the entire test suite.</p>
<p>Most frequently, youâ€™ll do this with <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code>:</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html">test</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Then eventually, as part of <code>R CMD check</code> with <code><a href="https://devtools.r-lib.org/reference/check.html">devtools::check()</a></code>:</p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/check.html">check</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="rstudio-tip">
<p><code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code> is mapped to Ctrl/Cmd + Shift + T.
<code><a href="https://devtools.r-lib.org/reference/check.html">devtools::check()</a></code> is mapped to Ctrl/Cmd + Shift + E.</p>
</div>
<!-- We'll probably want to replace this example eventually, but it's a decent placeholder.
The test failure is something highly artificial I created very quickly. 
It would be better to use an example that actually makes sense, if someone elects to really read and think about it.-->
<p>The output of <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code> looks like this:</p>
<pre><code>devtools::test()
â„¹ Loading usethis
â„¹ Testing usethis
âœ“ | F W S  OK | Context
âœ“ |         1 | addin [0.1s]
âœ“ |         6 | badge [0.5s]
   ...
âœ“ |        27 | github-actions [4.9s]
   ...
âœ“ |        44 | write [0.6s]

â•â• Results â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Duration: 31.3 s

â”€â”€ Skipped tests  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Not on GitHub Actions, Travis, or Appveyor (3)

[ FAIL 1 | WARN 0 | SKIP 3 | PASS 728 ]</code></pre>
<p>Test failure is reported like this:</p>
<pre><code>Failure (test-release.R:108:3): get_release_data() works if no file found
res$Version (`actual`) not equal to "0.0.0.9000" (`expected`).

`actual`:   "0.0.0.1234"
`expected`: "0.0.0.9000"</code></pre>
<p>Each failure gives a description of the test (e.g., â€œget_release_data() works if no file foundâ€), its location (e.g., â€œtest-release.R:108:3â€), and the reason for the failure (e.g., â€œres$Version (<code>actual</code>) not equal toâ€0.0.0.9000â€ (<code>expected</code>)â€œ).</p>
<p>The idea is that youâ€™ll modify your code (either the functions defined below <code>R/</code> or the tests in <code>tests/testthat/</code>) until all tests are passing.</p>
</div>
</div>
<div id="test-organisation" class="section level2" number="13.4">
<h2>
<span class="header-section-number">13.4</span> Test organisation<a class="anchor" aria-label="anchor" href="#test-organisation"><i class="fas fa-link"></i></a>
</h2>
<p>A test file lives in <code>tests/testthat/</code>.
Its name must start with <code>test</code>.
We will inspect and execute a test file from the stringr package.</p>
<!-- https://github.com/hadley/r-pkgs/issues/778 -->
<p>But first, for the purposes of rendering this book, we must attach stringr and testthat.
Note that in real-life test-running situations, this is taken care of by your package development tooling:</p>
<ul>
<li>During interactive development, <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> makes testthat and the
package-under-development available (both its exported and unexported
functions).</li>
<li>During arms-length test execution, this is taken care of by
<code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test_active_file()</a></code>, <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code>, and <code>tests/testthat.R</code>.</li>
</ul>
<p><strong>Your test files should not include these <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> calls.
We also explicitly request testthat edition 3, but in a real package this will be declared in DESCRIPTION.</strong></p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/local_edition.html">local_edition</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<!-- TODO: check if stringr has released and, if so, remove this footnote and edit DESCRIPTION. -->
<p>Here are the contents of <code>tests/testthat/test-dup.r</code> from stringr<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Note that we are building the book against a dev version of stringr.&lt;/p&gt;"><sup>28</sup></a>:</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"basic duplication works"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"aaa"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="st">"abc"</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"abcabc"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"aa"</span>, <span class="st">"bb"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"aa"</span>, <span class="st">"bbb"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸ˜€</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"0 duplicates equals empty string"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">""</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸŒˆ</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"uses tidyverse recycling rules"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"vctrs_error_incompatible_size"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸ¥³</span></span></code></pre></div>
<p>This file shows a typical mix of tests:</p>
<ul>
<li>â€œbasic duplication worksâ€ tests typical usage of <code><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup()</a></code>.</li>
<li>â€œ0 duplicates equals empty stringâ€ probes a specific edge case.</li>
<li>â€œuses tidyverse recycling rulesâ€ checks that malformed input results in a
specific kind of error.</li>
</ul>
<p>Tests are organised hierarchically:
<strong>expectations</strong> are grouped into <strong>tests</strong> which are organised in <strong>files</strong>:</p>
<ul>
<li><p>A <strong>file</strong> holds multiple related tests.
In this example, the file <code>tests/testthat/test-dup.r</code> has all of the tests
for the code in <code>R/dup.r</code>.</p></li>
<li>
<p>A <strong>test</strong> groups together multiple expectations to test the output from a
simple function, a range of possibilities for a single parameter from a more
complicated function, or tightly related functionality from across multiple
functions.
This is why they are sometimes called <strong>unit</strong> tests.
Each test should cover a single unit of functionality.
A test is created with <code>test_that(desc, code)</code>.</p>
<p>Itâ€™s common to write the description (<code>desc</code>) to create something that reads
naturally, e.g.Â <code>test_that("basic duplication works", { ... })</code>.
A test failure report includes this description, which is why you want a
concise statement of the testâ€™s purpose, e.g.Â a specific behaviour.</p>
</li>
<li><p>An <strong>expectation</strong> is the atom of testing.
It describes the expected result of a computation:
Does it have the right value and right class?
Does it produce an error when it should?
An expectation automates visual checking of results in the console.
Expectations are functions that start with <code>expect_</code>.</p></li>
</ul>
<p>You want to arrange things such that, when a test fails, youâ€™ll know whatâ€™s wrong and where in your code to look for the problem.
This motivates all our recommendations regarding file organisation, file naming, and the test description.
Finally, try to avoid putting too many expectations in one test - itâ€™s better to have more smaller tests than fewer larger tests.</p>
</div>
<div id="expectations" class="section level2" number="13.5">
<h2>
<span class="header-section-number">13.5</span> Expectations<a class="anchor" aria-label="anchor" href="#expectations"><i class="fas fa-link"></i></a>
</h2>
<p>An expectation is the finest level of testing.
It makes a binary assertion about whether or not an object has the properties you expect.
This object is usually the return value from a function in your package.</p>
<p>All expectations have a similar structure:</p>
<ul>
<li><p>They start with <code>expect_</code>.</p></li>
<li><p>They have two main arguments:
the first is the actual result, the second is what you expect.</p></li>
<li><p>If the actual and expected results donâ€™t agree, testthat throws an error.</p></li>
<li><p>Some expectations have additional arguments that control the finer points of
comparing an actual and expected result.</p></li>
</ul>
<p>While youâ€™ll normally put expectations inside tests inside files, you can also run them directly.
This makes it easy to explore expectations interactively.
There are more than 40 expectations in the testthat package, which can be explored in testthatâ€™s <a href="https://testthat.r-lib.org/reference/index.html">reference index</a>.
Weâ€™re only going to cover the most important expectations here.</p>
<div id="testing-for-equality" class="section level3" number="13.5.1">
<h3>
<span class="header-section-number">13.5.1</span> Testing for equality<a class="anchor" aria-label="anchor" href="#testing-for-equality"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal()</a></code> checks for equality, with some reasonable amount of numeric tolerance:</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span> <span class="op">+</span> <span class="fl">1e-7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">11</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: 10 (`actual`) not equal to 11 (`expected`).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   `actual`: <span style="color: #00BB00;">10</span></span></span>
<span><span class="co">#&gt; `expected`: <span style="color: #00BB00;">11</span></span></span></code></pre></div>
<p>If you want to test for exact equivalence, use <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical()</a></code>.</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span> <span class="op">+</span> <span class="fl">1e-7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span> <span class="op">+</span> <span class="fl">1e-7</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: 10 (`actual`) not identical to 10 + 1e-07 (`expected`).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   `actual`: <span style="color: #00BB00;">10.0000000</span></span></span>
<span><span class="co">#&gt; `expected`: <span style="color: #00BB00;">10.0000001</span></span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2L</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: 2 (`actual`) not identical to 2L (`expected`).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; `actual` is <span style="color: #00BB00;">a double vector</span> (2)</span></span>
<span><span class="co">#&gt; `expected` is <span style="color: #00BB00;">an integer vector</span> (2)</span></span></code></pre></div>
</div>
<div id="testing-errors" class="section level3" number="13.5.2">
<h3>
<span class="header-section-number">13.5.2</span> Testing errors<a class="anchor" aria-label="anchor" href="#testing-errors"><i class="fas fa-link"></i></a>
</h3>
<p>Use <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error()</a></code> to check whether an expression throws an error.
Itâ€™s the most important expectation in a trio that also includes <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning()</a></code> and <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_message()</a></code>.
Weâ€™re going to emphasize errors here, but most of this also applies to warnings and messages.</p>
<p>Usually you care about two things when testing an error:</p>
<ul>
<li>Does the code fail? Specifically, does it fail for the right reason?</li>
<li>Does the accompanying message make sense to the human who needs to deal with
the error?</li>
</ul>
<p>The entry-level solution is to expect a specific type of condition:</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span> <span class="op">/</span> <span class="st">"a"</span></span>
<span><span class="co">#&gt; Error in 1/"a": non-numeric argument to binary operator</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="st">"a"</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in log(-1): NaNs produced</span></span>
<span><span class="co">#&gt; [1] NaN</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This is a bit dangerous, though, especially when testing an error.
There are lots of ways for code to fail!
Consider the following test:</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu">str_duq</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This expectation is intended to test the recycling behaviour of <code><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup()</a></code>.
But, due to a typo, it tests behaviour of a non-existent function, <code>str_duq()</code>.
The code throws an error and, therefore, the test above passes, but for the <em>wrong reason</em>.
Due to the typo, the actual error thrown is about not being able to find the <code>str_duq()</code> function:</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">str_duq</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in str_duq(1:2, 1:3): could not find function "str_duq"</span></span></code></pre></div>
<p>Historically, the best defense against this was to assert that the condition message matches a certain regular expression, via the second argument, <code>regexp</code>.</p>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="st">"a"</span>, <span class="st">"non-numeric argument"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"NaNs produced"</span><span class="op">)</span></span></code></pre></div>
<p>This does, in fact, force our typo problem to the surface:</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu">str_duq</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, <span class="st">"recycle"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in str_duq(1:2, 1:3): could not find function "str_duq"</span></span></code></pre></div>
<p>Recent developments in both base R and rlang make it increasingly likely that conditions are signaled with a <em>class</em>, which provides a better basis for creating precise expectations.
That is exactly what youâ€™ve already seen in this stringr example.
This is what the <code>class</code> argument is for:</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fails, error has wrong class</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu">str_duq</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"vctrs_error_incompatible_size"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in str_duq(1:2, 1:3): could not find function "str_duq"</span></span>
<span></span>
<span><span class="co"># passes, error has expected class</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"vctrs_error_incompatible_size"</span><span class="op">)</span></span></code></pre></div>
<!-- This advice feels somewhat at odds with Hadley's ambivalence about classed errors.
I.e. I think he recommends using a classed condition only when there's a specific reason to.
Then again, maybe the desire to test it is a legitimate reason? -->
<p>If you have the choice, express your expectation in terms of the conditionâ€™s class, instead of its message.
Often this is under your control, i.e.Â if your package signals the condition.
If the condition originates from base R or another package, proceed with caution.
This is often a good reminder to re-consider the wisdom of testing a condition that is not fully under your control in the first place.</p>
<p>To check for the <em>absence</em> of an error, warning, or message, pass <code>NA</code> to the <code>regexp</code> argument:</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span>, <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<p>Of course, this is functionally equivalent to simply executing <code>1 / 2</code> inside a test, but some developers find the explicit expectation expressive.</p>
<p>If you genuinely care about the conditionâ€™s message, testthat 3eâ€™s snapshot tests are the best approach, which we describe next.</p>
</div>
<div id="snapshot-tests" class="section level3" number="13.5.3">
<h3>
<span class="header-section-number">13.5.3</span> Snapshot tests<a class="anchor" aria-label="anchor" href="#snapshot-tests"><i class="fas fa-link"></i></a>
</h3>
<p>Sometimes itâ€™s difficult or awkward to describe an expected result with code.
Snapshot tests are a great solution to this problem and this is one of the main innovations in testthat 3e.
The basic idea is that you record the expected result in a separate, human-readable file.
Going forward, testthat alerts you when a newly computed result differs from the previously recorded snapshot.
Snapshot tests are particularly suited to monitoring your packageâ€™s user interface, such as its informational messages and errors.
Other use cases include testing images or other complicated objects.</p>
<p>Weâ€™ll illustrate snapshot tests using the waldo package.
Under the hood, testthat 3e uses waldo to do the heavy lifting of â€œactual vs.Â expectedâ€ comparisons, so itâ€™s good for you to know a bit about waldo anyway.
One of waldoâ€™s main design goals is to present differences in a clear and actionable manner, as opposed to a frustrating declaration that â€œthis differs from that and I know exactly how, but I wonâ€™t tell youâ€.
Therefore, the formatting of output from <code><a href="https://waldo.r-lib.org/reference/compare.html">waldo::compare()</a></code> is very intentional and is well-suited to a snapshot test.
The binary outcome of <code>TRUE</code> (actual == expected) vs.Â <code>FALSE</code> (actual != expected) is fairly easy to check and could get its own test.
Here weâ€™re concerned with writing a test to ensure that differences are reported to the user in the intended way.</p>
<p>waldo uses a few different layouts for showing diffs, depending on various conditions.
Here we deliberately constrain the width, in order to trigger a side-by-side layout.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The actual waldo test that inspires this example targets an unexported helper function that produces the desired layout.
But this example uses an exported waldo function for simplicity.&lt;/p&gt;"><sup>29</sup></a>.
(Weâ€™ll talk more about the withr package below.)</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">with_options</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>  <span class="fu">waldo</span><span class="fu">::</span><span class="fu"><a href="https://waldo.r-lib.org/reference/compare.html">compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="va">letters</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="st">"X"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     old | new    </span></span>
<span><span class="co">#&gt; [1] <span style="color: #BBBB00;">"X"</span> -        </span></span>
<span><span class="co">#&gt; [2] <span style="color: #555555;">"a"</span> | <span style="color: #555555;">"a"</span> [1]</span></span>
<span><span class="co">#&gt; [3] <span style="color: #555555;">"b"</span> | <span style="color: #555555;">"b"</span> [2]</span></span>
<span><span class="co">#&gt; [4] <span style="color: #555555;">"c"</span> | <span style="color: #555555;">"c"</span> [3]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      old | new     </span></span>
<span><span class="co">#&gt; [25] <span style="color: #555555;">"x"</span> | <span style="color: #555555;">"x"</span> [24]</span></span>
<span><span class="co">#&gt; [26] <span style="color: #555555;">"y"</span> | <span style="color: #555555;">"y"</span> [25]</span></span>
<span><span class="co">#&gt; [27] <span style="color: #555555;">"z"</span> | <span style="color: #555555;">"z"</span> [26]</span></span>
<span><span class="co">#&gt;          - <span style="color: #0000BB;">"X"</span> [27]</span></span></code></pre></div>
<p>The two primary inputs differ at two locations:
once at the start and once at the end.
This layout presents both of these, with some surrounding context, which helps the reader orient themselves.</p>
<p>Hereâ€™s how this would look as a snapshot test:</p>
<!-- Actually using snapshot test technology here is hard.
I can sort of see how it might be done, by looking at the source of testthat's vignette about snapshotting.
For the moment, I'm just faking it. -->
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"side-by-side diffs work"</span>, <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span></span>
<span>    <span class="fu">waldo</span><span class="fu">::</span><span class="fu"><a href="https://waldo.r-lib.org/reference/compare.html">compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="va">letters</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="st">"X"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>If you execute <code><a href="https://testthat.r-lib.org/reference/expect_snapshot.html">expect_snapshot()</a></code> or a test containing <code><a href="https://testthat.r-lib.org/reference/expect_snapshot.html">expect_snapshot()</a></code> interactively, youâ€™ll see this:</p>
<pre><code>Can't compare snapshot to reference when testing interactively
â„¹ Run `devtools::test()` or `testthat::test_file()` to see changes</code></pre>
<p>followed by a preview of the snapshot output.</p>
<p>This reminds you that snapshot tests only function when executed non-interactively, i.e.Â while running an entire test file or the entire test suite.
This applies both to recording snapshots and to checking them.</p>
<p>The first time this test is executed via <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code> or similar, youâ€™ll see something like this (assume the test is in <code>tests/testthat/test-diff.R</code>):</p>
<pre><code>â”€â”€ Warning (test-diff.R:63:3): side-by-side diffs work â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Adding new snapshot:
Code
  waldo::compare(c(
    "X", letters), c(
    letters, "X"))
Output
      old | new    
  [1] "X" -        
  [2] "a" | "a" [1]
  [3] "b" | "b" [2]
  [4] "c" | "c" [3]
  
       old | new     
  [25] "x" | "x" [24]
  [26] "y" | "y" [25]
  [27] "z" | "z" [26]
           - "X" [27]</code></pre>
<p>There is always a warning upon initial snapshot creation.
The snapshot is added to <code>tests/testthat/_snaps/diff.md</code>, under the heading â€œside-by-side diffs workâ€, which comes from the testâ€™s description.
The snapshot looks exactly like what a user sees interactively in the console, which is the experience we want to check for.
The snapshot file is <em>also</em> very readable, which is pleasant for the package developer.
This readability extends to snapshot changes, i.e.Â when examining Git diffs and reviewing pull requests on GitHub, which helps you keep tabs on your user interface.
Going forward, as long as your package continues to re-capitulate the expected snapshot, this test will pass.</p>
<p>If youâ€™ve written a lot of conventional unit tests, you can appreciate how well-suited snapshot tests are for this use case.
If we were forced to inline the expected output in the test file, there would be a great deal of quoting, escaping, and newline management.
Ironically, with conventional expectations, the output you expect your user to see tends to get obscured by a heavy layer of syntactical noise.</p>
<p>What about when a snapshot test fails?
Letâ€™s imagine a hypothetical internal change where the default labels switch from â€œoldâ€ and â€œnewâ€ to â€œOLDâ€ and â€œNEWâ€.
Hereâ€™s how this snapshot test would react:</p>
<pre><code>â”€â”€ Failure (test-diff.R:63:3): side-by-side diffs workâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Snapshot of code has changed:
old[3:15] vs new[3:15]
  "    \"X\", letters), c("
  "    letters, \"X\"))"
  "Output"
- "      old | new    "
+ "      OLD | NEW    "
  "  [1] \"X\" -        "
  "  [2] \"a\" | \"a\" [1]"
  "  [3] \"b\" | \"b\" [2]"
  "  [4] \"c\" | \"c\" [3]"
  "  "
- "       old | new     "
+ "       OLD | NEW     "
and 3 more ...

* Run `snapshot_accept('diff')` to accept the change
* Run `snapshot_review('diff')` to interactively review the change</code></pre>
<p>This diff is presented more effectively in most real-world usage, e.g.Â in the console, by a Git client, or via a Shiny app (see below).
But even this plain text version highlights the changes quite clearly.
Each of the two loci of change is indicated with a pair of lines marked with <code>-</code> and <code>+</code>, showing how the snapshot has changed.</p>
<p>You can call <code>testthat::snapshot_review('diff')</code> to review changes locally in a Shiny app, which lets you skip or accept individual snapshots.
Or, if all changes are intentional and expected, you can go straight to <code>testthat::snapshot_accept('diff')</code>.
Once youâ€™ve re-synchronized your actual output and the snapshots on file, your tests will pass once again.
In real life, snapshot tests are a great way to stay informed about changes to your packageâ€™s user interface, due to your own internal changes or due to changes in your dependencies or even R itself.</p>
<p><code><a href="https://testthat.r-lib.org/reference/expect_snapshot.html">expect_snapshot()</a></code> has a few arguments worth knowing about:</p>
<ul>
<li><p><code>cran = FALSE</code>: By default, snapshot tests are skipped if it looks like the
tests are running on CRANâ€™s servers.
This reflects the typical intent of snapshot tests, which is to proactively
monitor user interface, but not to check for correctness, which presumably
is the job of other unit tests which are not skipped.
In typical usage, a snapshot change is something the developer will want to
know about, but it does not signal an actual defect.</p></li>
<li>
<p><code>error = FALSE</code>: By default, snapshot code is <em>not</em> allowed to throw an error.
See <code><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error()</a></code>, described above, for one approach to testing errors.
But sometimes you want to assess â€œDoes this error message make sense to a
human?â€ and having it laid out in context in a snapshot is a great way to see
it with fresh eyes.
Specify <code>error = TRUE</code> in this case:</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_dup.html">str_dup</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li><p><code>transform</code>: Sometimes a snapshot contains volatile, insignificant elements,
such as a temporary filepath or a timestamp.
The <code>transform</code> argument accepts a function, presumably written by you, to
remove or replace such changeable text.
Another use of <code>transform</code> is to scrub sensitive information from the
snapshot.</p></li>
<li><p><code>variant</code>: Sometimes snapshots reflect the ambient conditions, such as the
operating system or the version of R or one of your dependencies, and you need
a different snapshot for each variant. This is an experimental and somewhat
advanced feature, so if you can arrange things to use a single snapshot, you
probably should.</p></li>
</ul>
<p>In typical usage, testthat will take care of managing the snapshot files below <code>tests/testthat/_snaps/</code>.
This happens in the normal course of you running your tests and, perhaps, calling <code><a href="https://testthat.r-lib.org/reference/snapshot_accept.html">testthat::snapshot_accept()</a></code>.</p>
</div>
<div id="shortcuts-for-other-common-patterns" class="section level3" number="13.5.4">
<h3>
<span class="header-section-number">13.5.4</span> Shortcuts for other common patterns<a class="anchor" aria-label="anchor" href="#shortcuts-for-other-common-patterns"><i class="fas fa-link"></i></a>
</h3>
<p>We conclude this section with a few more expectations that come up frequently.
But remember that testthat has <a href="https://testthat.r-lib.org/reference/index.html">many more pre-built expectations</a> than we can demonstrate here.</p>
<p>Several expectations can be described as â€œshortcutsâ€, i.e.Â they streamline a pattern that comes up often enough to deserve its own wrapper.</p>
<ul>
<li>
<p><code>expect_match(object, regexp, ...)</code> is a shortcut that wraps
<code>grepl(pattern = regexp, x = object, ...)</code>.
It matches a character vector input against a regular expression <code>regexp</code>.
The optional <code>all</code> argument controls whether all elements or just one element
needs to match.
Read the <code><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match()</a></code> documentation to see how additional arguments, like
<code>ignore.case = FALSE</code> or <code>fixed = TRUE</code>, can be passed down to <code><a href="https://rdrr.io/r/base/grep.html">grepl()</a></code>.</p>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">string</span> <span class="op">&lt;-</span> <span class="st">"Testing is fun!"</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="va">string</span>, <span class="st">"Testing"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Fails, match is case-sensitive</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="va">string</span>, <span class="st">"testing"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: `string` does not match "testing".</span></span>
<span><span class="co">#&gt; Actual value: "Testing is fun!"</span></span>
<span></span>
<span><span class="co"># Passes because additional arguments are passed to grepl():</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="va">string</span>, <span class="st">"testing"</span>, ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</li>
<li><p><code>expect_length(object, n)</code> is a shortcut for
<code>expect_equal(length(object), n)</code>.</p></li>
<li><p><code>expect_setequal(x, y)</code> tests that every element of <code>x</code> occurs in <code>y</code>, and
that every element of <code>y</code> occurs in <code>x</code>.
But it wonâ€™t fail if <code>x</code> and <code>y</code> happen to have their elements in a different
order.</p></li>
<li>
<p><code><a href="https://testthat.r-lib.org/reference/inheritance-expectations.html">expect_s3_class()</a></code> and <code><a href="https://testthat.r-lib.org/reference/inheritance-expectations.html">expect_s4_class()</a></code> check that an object <code>inherit()</code>s
from a specified class. <code><a href="https://testthat.r-lib.org/reference/inheritance-expectations.html">expect_type()</a></code>checks the <code><a href="https://rdrr.io/r/base/typeof.html">typeof()</a></code> an object.</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/inheritance-expectations.html">expect_s3_class</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"lm"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/inheritance-expectations.html">expect_s3_class</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"glm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: `model` inherits from 'lm' not 'glm'.</span></span></code></pre></div>
</li>
</ul>
<p><code><a href="https://testthat.r-lib.org/reference/logical-expectations.html">expect_true()</a></code> and <code><a href="https://testthat.r-lib.org/reference/logical-expectations.html">expect_false()</a></code> are useful catchalls if none of the other expectations does what you need.</p>
</div>
</div>
<div id="what-to-test" class="section level2" number="13.6">
<h2>
<span class="header-section-number">13.6</span> What to test<a class="anchor" aria-label="anchor" href="#what-to-test"><i class="fas fa-link"></i></a>
</h2>
<blockquote>
<p>Whenever you are tempted to type something into a print statement or a
debugger expression, write it as a test instead.
â€” Martin Fowler</p>
</blockquote>
<p>There is a fine balance to writing tests.
Each test that you write makes your code less likely to change inadvertently;
but it also can make it harder to change your code on purpose.
Itâ€™s hard to give good general advice about writing tests, but you might find these points helpful:</p>
<ul>
<li><p>Focus on testing the external interface to your functions - if you test the
internal interface, then itâ€™s harder to change the implementation in the
future because as well as modifying the code, youâ€™ll also need to update all
the tests.</p></li>
<li><p>Strive to test each behaviour in one and only one test.
Then if that behaviour later changes you only need to update a single test.</p></li>
<li><p>Avoid testing simple code that youâ€™re confident will work.
Instead focus your time on code that youâ€™re not sure about, is fragile, or has
complicated interdependencies.
That said, I often find I make the most mistakes when I falsely assume that
the problem is simple and doesnâ€™t need any tests.</p></li>
<li><p>Always write a test when you discover a bug.
You may find it helpful to adopt the test-first philosophy.
There you always start by writing the tests, and then write the code that
makes them pass.
This reflects an important problem solving strategy:
start by establishing your success criteria, how you know if youâ€™ve solved the
problem.</p></li>
</ul>
<div id="test-coverage" class="section level3" number="13.6.1">
<h3>
<span class="header-section-number">13.6.1</span> Test coverage<a class="anchor" aria-label="anchor" href="#test-coverage"><i class="fas fa-link"></i></a>
</h3>
<p>Another concrete way to direct your test writing efforts is to examine your test coverage.
The covr package (&lt;<a href="https://covr.r-lib.org" class="uri">https://covr.r-lib.org</a>) can be used to determine which lines of your packageâ€™s source code are (or are not!) executed when the test suite is run.
This is most often presented as a percentage.
Generally speaking, the higher the better.</p>
<p>In some technical sense, 100% test coverage is the goal, however, this is rarely achieved in practice and thatâ€™s often OK.
Going from 90% or 99% coverage to 100% is not always the best use of your development time and energy.
In many cases, that last 10% or 1% often requires some awkward gymnastics to cover.
Sometimes this forces you to introduce mocking or some other new complexity.
Donâ€™t sacrifice the maintainability of your test suite in the name of covering some weird edge case that hasnâ€™t yet proven to be a problem.
Also remember that not every line of code or every function is equally likely to harbor bugs.
Focus your testing energy on code that is tricky, based on your expert opinion and any empirical evidence youâ€™ve accumulated about bug hot spots.</p>
<p>We use covr regularly, in two different ways:</p>
<ul>
<li>Local, interactive use.
We mostly use <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test_coverage_active_file()</a></code> and
<code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test_coverage()</a></code>, for exploring the coverage of an individual file
or the whole package, respectively.</li>
<li>Automatic, remote use via GitHub Actions (GHA).
We cover continuous integration and GHA more thoroughly elsewhere, but we
will at least mention here that
<code>usethis::use_github_action("test-coverage")</code> configures a GHA workflow that
constantly monitors your test coverage.
Test coverage can be an especially helpful metric when evaluating a pull
request (either your own or from an external contributor).
A proposed change that is well-covered by tests is less risky to merge.</li>
</ul>
</div>
</div>
<div id="high-level-principles-for-testing" class="section level2" number="13.7">
<h2>
<span class="header-section-number">13.7</span> High-level principles for testing<a class="anchor" aria-label="anchor" href="#high-level-principles-for-testing"><i class="fas fa-link"></i></a>
</h2>
<p>In later sections, we offer concrete strategies for how to handle common testing dilemmas in R.
Here we lay out the high-level principles that underpin these recommendations:</p>
<ul>
<li>A test should ideally be self-sufficient and self-contained.</li>
<li>The interactive workflow is important, because you will mostly interact with
your tests when they are failing.</li>
<li>Itâ€™s more important that test code be obvious than, e.g., as DRY as possible.</li>
<li>However, the interactive workflow shouldnâ€™t â€œleakâ€ into and undermine the test
suite.</li>
</ul>
<p>Writing good tests for a code base often feels more challenging than writing the code in the first place.
This can come as a bit of a shock when youâ€™re new to package development and you might be concerned that youâ€™re doing it wrong.
Donâ€™t worry, youâ€™re not!
Testing presents many unique challenges and maneuvers, which tend to get much less air time in programming communities than strategies for writing the â€œmain codeâ€, i.e.Â the stuff below <code>R/</code>.
As a result, it requires more deliberate effort to develop your skills and taste around testing.</p>
<p>Many of the packages maintained by our team violate some of the advice youâ€™ll find here.
There are (at least) two reasons for that:</p>
<ul>
<li>testthat has been evolving for more than twelve years and this chapter
reflects the cumulative lessons learned from that experience.
The tests in many packages have been in place for a long time and reflect
typical practices from different eras and different maintainers.</li>
<li>These arenâ€™t hard and fast rules, but are, rather, guidelines. There will
always be specific situations where it makes sense to bend the rule.</li>
</ul>
<p>This chapter canâ€™t address all possible testing situations, but hopefully these guidelines will help your future decision-making.</p>
<div id="self-sufficient-tests" class="section level3" number="13.7.1">
<h3>
<span class="header-section-number">13.7.1</span> Self-sufficient tests<a class="anchor" aria-label="anchor" href="#self-sufficient-tests"><i class="fas fa-link"></i></a>
</h3>
<blockquote>
<p>All tests should strive to be hermetic:
a test should contain all of the information necessary to set up, execute, and tear down its environment.
Tests should assume as little as possible about the outside environment â€¦.</p>
<p>From the book Software Engineering at Google, <a href="https://abseil.io/resources/swe-book/html/ch11.html">Chapter 11</a></p>
</blockquote>
<p>Recall this advice found in section <a href="r.html#code-r-landscape">7.5</a>, which covers your packageâ€™s â€œmain codeâ€, i.e.Â everything below <code>R/</code>:</p>
<blockquote>
<p>The <code>.R</code> files below <code>R/</code> should consist almost entirely of function definitions.
Any other top-level code is suspicious and should be carefully reviewed for possible conversion into a function.</p>
</blockquote>
<p>We have analogous advice for your test files:</p>
<blockquote>
<p>The <code>test-*.R</code> files below <code>tests/testthat/</code> should consist almost entirely of calls to <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code>.
Any other top-level code is suspicious and should be carefully considered for relocation into calls to <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> or to other files that get special treatment inside an R package or from the testthat.</p>
</blockquote>
<p>Eliminating (or at least minimizing) top-level code outside of <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> will have the beneficial effect of making your tests more hermetic.
This is basically the testing analogue of the general programming advice that itâ€™s wise to avoid unstructured sharing of state.</p>
<p>Logic at the top-level of a test file has an awkward scope:
Objects or functions defined here have what you might call â€œtest file scopeâ€, if the definitions appear before the first call to <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code>.
If top-level code is interleaved between <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> calls, you can even create â€œpartial test file scopeâ€.</p>
<p>While writing tests, it can feel convenient to rely on these file-scoped objects, especially early in the life of a test suite, e.g.Â when each test file fits on one screen.
But we find that implicitly relying on objects in a testâ€™s parent environment tends to make a test suite harder to understand and maintain over time.</p>
<p>Consider a test file with top-level code sprinkled around it, outside of <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code>:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="tests.html#cb189-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb189-2"><a href="tests.html#cb189-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-3"><a href="tests.html#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="fu">skip_if</span>(<span class="fu">today_is_a_monday</span>())</span>
<span id="cb189-4"><a href="tests.html#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="tests.html#cb189-5" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"foofy() does this"</span>, {</span>
<span id="cb189-6"><a href="tests.html#cb189-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">foofy</span>(dat), ...)</span>
<span id="cb189-7"><a href="tests.html#cb189-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb189-8"><a href="tests.html#cb189-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-9"><a href="tests.html#cb189-9" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>))</span>
<span id="cb189-10"><a href="tests.html#cb189-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-11"><a href="tests.html#cb189-11" aria-hidden="true" tabindex="-1"></a><span class="fu">skip_on_os</span>(<span class="st">"windows"</span>)</span>
<span id="cb189-12"><a href="tests.html#cb189-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-13"><a href="tests.html#cb189-13" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"foofy2() does that"</span>, {</span>
<span id="cb189-14"><a href="tests.html#cb189-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_snapshot</span>(<span class="fu">foofy2</span>(dat, dat2)</span>
<span id="cb189-15"><a href="tests.html#cb189-15" aria-hidden="true" tabindex="-1"></a><span class="er">}</span>)</span></code></pre></div>
<p>We recommend relocating file-scoped logic to either a narrower scope or to a broader scope.
Hereâ€™s what it would look like to use a narrow scope, i.e.Â to inline everything inside <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> calls:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="tests.html#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"foofy() does this"</span>, {</span>
<span id="cb190-2"><a href="tests.html#cb190-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if</span>(<span class="fu">today_is_a_monday</span>())</span>
<span id="cb190-3"><a href="tests.html#cb190-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-4"><a href="tests.html#cb190-4" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb190-5"><a href="tests.html#cb190-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-6"><a href="tests.html#cb190-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">foofy</span>(dat), ...)</span>
<span id="cb190-7"><a href="tests.html#cb190-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb190-8"><a href="tests.html#cb190-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-9"><a href="tests.html#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"foofy() does that"</span>, {</span>
<span id="cb190-10"><a href="tests.html#cb190-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if</span>(<span class="fu">today_is_a_monday</span>())</span>
<span id="cb190-11"><a href="tests.html#cb190-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_on_os</span>(<span class="st">"windows"</span>)</span>
<span id="cb190-12"><a href="tests.html#cb190-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-13"><a href="tests.html#cb190-13" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb190-14"><a href="tests.html#cb190-14" aria-hidden="true" tabindex="-1"></a>  dat2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>))</span>
<span id="cb190-15"><a href="tests.html#cb190-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-16"><a href="tests.html#cb190-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_snapshot</span>(<span class="fu">foofy</span>(dat, dat2)</span>
<span id="cb190-17"><a href="tests.html#cb190-17" aria-hidden="true" tabindex="-1"></a><span class="er">}</span>)</span></code></pre></div>
<p>Below we will discuss techniques for moving file-scoped logic to a broader scope.</p>
</div>
<div id="self-contained-tests" class="section level3" number="13.7.2">
<h3>
<span class="header-section-number">13.7.2</span> Self-contained tests<a class="anchor" aria-label="anchor" href="#self-contained-tests"><i class="fas fa-link"></i></a>
</h3>
<p>Each <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> test has its own execution environment, which makes it somewhat self-contained.
For example, an R object you create inside a test does not exist after the test exits:</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"thingy"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"thingy exists"</span>, <span class="op">{</span></span>
<span>  <span class="va">thingy</span> <span class="op">&lt;-</span> <span class="st">"thingy"</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="va">thingy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸŠ</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"thingy"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>The <code>thingy</code> object lives and dies entirely within the confines of <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code>.
However, testthat doesnâ€™t know how to cleanup after actions that affect other aspects of the R landscape:</p>
<ul>
<li>The filesystem: creating and deleting files, changing the working directory,
etc.</li>
<li>The search path: <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>, <code><a href="https://rdrr.io/r/base/attach.html">attach()</a></code>.</li>
<li>Global options, like <code><a href="https://rdrr.io/r/base/options.html">options()</a></code> and <code><a href="https://rdrr.io/r/graphics/par.html">par()</a></code>, and environment variables.</li>
</ul>
<p>Watch how calls like <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>, <code><a href="https://rdrr.io/r/base/options.html">options()</a></code>, and <code><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv()</a></code> have a persistent effect <em>after</em> a test, even when they are executed inside <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code>:</p>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"jsonlite"</span>, <span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"opt_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"envvar_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"landscape changes leak outside the test"</span>, <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805">jsonlite</a></span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>opt_whatever <span class="op">=</span> <span class="st">"whatever"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>envvar_whatever <span class="op">=</span> <span class="st">"whatever"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"jsonlite"</span>, all <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"opt_whatever"</span><span class="op">)</span>, <span class="st">"whatever"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"envvar_whatever"</span><span class="op">)</span>, <span class="st">"whatever"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸ¥³</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"jsonlite"</span>, <span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "package:jsonlite"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"opt_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "whatever"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"envvar_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "whatever"</span></span></code></pre></div>
<p>These changes to the landscape even persist beyond the current test file, i.e.Â they carry over into all subsequent test files.</p>
<p>If itâ€™s easy to avoid making such changes in your test code, that is the best strategy!
But if itâ€™s unavoidable, then you have to make sure that you clean up after yourself.
This mindset is very similar to one we advocated for in section <a href="r.html#code-r-landscape">7.5</a>, when discussing how to design well-mannered functions.</p>
<p>We like to use the withr package (<a href="https://withr.r-lib.org" class="uri">https://withr.r-lib.org</a>) to make temporary changes in global state, because it automatically captures the initial state and arranges the eventual restoration.
Youâ€™ve already seen an example of its usage, when we explored snapshot tests:</p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"side-by-side diffs work"</span>, <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>             <span class="co"># &lt;-- (Â°_Â°) look here!</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_snapshot.html">expect_snapshot</a></span><span class="op">(</span></span>
<span>    <span class="fu">waldo</span><span class="fu">::</span><span class="fu"><a href="https://waldo.r-lib.org/reference/compare.html">compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="va">letters</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="st">"X"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>This test requires the display width to be set at 20 columns, which is considerably less than the default width.
<code>withr::local_options(width = 20)</code> sets the <code>width</code> option to 20 and, at the end of the test, restores the option to its original value.
withr is also pleasant to use during interactive development:
deferred actions are still captured on the global environment and can be executed explicitly via <code><a href="https://withr.r-lib.org/reference/defer.html">withr::deferred_run()</a></code> or implicitly by restarting R.</p>
<p>We recommend including withr in <code>Suggests</code>, if youâ€™re only going to use it in your tests, or in <code>Imports</code>, if you also use it below <code>R/</code>.
Call withr functions as we do above, e.g.Â like <code>withr::local_whatever()</code>, in either case.
See section <a href="description-dependencies.html#suggested-packages-and-tests">11.1.1.1</a> for a full discussion.</p>
<div class="tip">
<p>The easiest way to add a package to DESCRIPTION is with, e.g., <code>usethis::use_package("withr", type = "Suggests")</code>.
For tidyverse packages, withr is considered a â€œfree dependencyâ€, i.e.Â the tidyverse uses withr so
extensively that we donâ€™t hesitate to use it whenever it would be useful.</p>
</div>
<p>withr has a large set of pre-implemented <code>local_*()</code> / <code>with_*()</code> functions that should handle most of your testing needs, so check there before you write your own.
If nothing exists that meets your need, <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code> is the general way to schedule some action at the end of a test.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Base Râ€™s &lt;code&gt;on.exit()&lt;/code&gt; is another alternative, but it requires more from you.
You need to capture the original state and write the restoration code yourself.
Also remember to do &lt;code&gt;on.exit(..., add = TRUE)&lt;/code&gt; if thereâ€™s &lt;em&gt;any&lt;/em&gt; chance a second &lt;code&gt;on.exit()&lt;/code&gt; call could be added in the test.
You probably also want to default to &lt;code&gt;after = FALSE&lt;/code&gt;.&lt;/p&gt;"><sup>30</sup></a></p>
<p>Hereâ€™s how we would fix the problems in the previous example using withr:
<em>Behind the scenes, we reversed the landscape changes, so we can try this again.</em></p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"jsonlite"</span>, <span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"opt_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"envvar_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"withr makes landscape changes local to a test"</span>, <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_package.html">local_package</a></span><span class="op">(</span><span class="st">"jsonlite"</span><span class="op">)</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span>opt_whatever <span class="op">=</span> <span class="st">"whatever"</span><span class="op">)</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_envvar.html">local_envvar</a></span><span class="op">(</span>envvar_whatever <span class="op">=</span> <span class="st">"whatever"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_match.html">expect_match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"jsonlite"</span>, all <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"opt_whatever"</span><span class="op">)</span>, <span class="st">"whatever"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"envvar_whatever"</span><span class="op">)</span>, <span class="st">"whatever"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸ¥³</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"jsonlite"</span>, <span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; character(0)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"opt_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"envvar_whatever"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ""</span></span></code></pre></div>
<p>testthat leans heavily on withr to make test execution environments as reproducible and self-contained as possible.
In testthat 3e, <code><a href="https://testthat.r-lib.org/reference/local_test_context.html">testthat::local_reproducible_output()</a></code> is implicitly part of each <code><a href="https://testthat.r-lib.org/reference/test_that.html">test_that()</a></code> test.</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"something specific happens"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/local_test_context.html">local_reproducible_output</a></span><span class="op">(</span><span class="op">)</span>     <span class="co"># &lt;-- this happens implicitly</span></span>
<span>  </span>
<span>  <span class="co"># your test code, which might be sensitive to ambient conditions, such as</span></span>
<span>  <span class="co"># display width or the number of supported colors</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://testthat.r-lib.org/reference/local_test_context.html">local_reproducible_output()</a></code> temporarily sets various options and environment variables to values favorable for testing, e.g.Â it suppresses colored output, turns off fancy quotes, sets the console width, and sets <code>LC_COLLATE = "C"</code>.
Usually, you can just passively enjoy the benefits of <code><a href="https://testthat.r-lib.org/reference/local_test_context.html">local_reproducible_output()</a></code>.
But you may want to call it explicitly when replicating test results interactively or if you want to override the default settings in a specific test.</p>
</div>
<div id="plan-for-test-failure" class="section level3" number="13.7.3">
<h3>
<span class="header-section-number">13.7.3</span> Plan for test failure<a class="anchor" aria-label="anchor" href="#plan-for-test-failure"><i class="fas fa-link"></i></a>
</h3>
<p>We regret to inform you that most of the quality time you spend with your tests will be when they are inexplicably failing.</p>
<blockquote>
<p>In its purest form, automating testing consists of three activities: writing tests, running tests, and <strong>reacting to test failures</strong>â€¦.</p>
<p>Remember that tests are often revisited only when something breaks.
When you are called to fix a broken test that you have never seen before, you will be thankful someone took the time to make it easy to understand.
Code is read far more than it is written, so make sure you write the test youâ€™d like to read!</p>
<p>From the book Software Engineering at Google, <a href="https://abseil.io/resources/swe-book/html/ch11.html">Chapter 11</a></p>
</blockquote>
<p>Most of us donâ€™t work on a code base the size of Google.
But even in a team of one, tests that you wrote six months ago might as well have been written by someone else.
Especially when they are failing.</p>
<p>When we do reverse dependency checks, often involving hundreds or thousands of CRAN packages, we have to inspect test failures to determine if changes in our packages are to blame.
As a result, we regularly engage with failing tests in other peopleâ€™s packages, which leaves us with lots of opinions about practices that create unnecessary testing pain.</p>
<p>Test troubleshooting nirvana looks like this:
In a fresh R session, you can do <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> and immediately run an individual test or walk through it line-by-line.
There is no need to hunt around for setup code that has to be run manually first, that is found elsewhere in the test file or perhaps in a different file altogether.
Test-related code that lives in an unconventional location causes extra self-inflicted pain when you least need it.</p>
<p>Consider this extreme and abstract example of a test that is difficult to troubleshoot due to implicit dependencies on free-range code:</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dozens or hundreds of lines of top-level code, interspersed with other tests,</span></span>
<span><span class="co"># which you must read and selectively execute</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"f() works"</span>, <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">function_from_some_dependency</span><span class="op">(</span><span class="va">object_with_unknown_origin</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>This test is much easier to drop in on if dependencies are invoked in the normal way, i.e.Â via <code>::</code>, and test objects are created inline:</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dozens or hundreds of lines of self-sufficient, self-contained tests,</span></span>
<span><span class="co"># all of which you can safely ignore!</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"f() works"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing</span> <span class="op">&lt;-</span> <span class="va">...</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">somePkg</span><span class="fu">::</span><span class="fu">someFunction</span><span class="op">(</span><span class="va">useful_thing</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>This test is self-sufficient.
The code inside <code>{ ... }</code> explicitly creates any necessary objects or conditions and makes explicit calls to any helper functions.
This test doesnâ€™t rely on objects or dependencies that happen to be be ambiently available.</p>
<p>Self-sufficient, self-contained tests are a win-win:
It is literally safer to design tests this way and it also makes tests much easier for humans to troubleshoot later.</p>
</div>
<div id="repetition-is-ok" class="section level3" number="13.7.4">
<h3>
<span class="header-section-number">13.7.4</span> Repetition is OK<a class="anchor" aria-label="anchor" href="#repetition-is-ok"><i class="fas fa-link"></i></a>
</h3>
<p>One obvious consequence of our suggestion to minimize code with â€œfile scopeâ€ is that your tests will probably have some repetition.
And thatâ€™s OK!
Weâ€™re going to make the controversial recommendation that you tolerate a fair amount of duplication in test code, i.e.Â you can relax some of your DRY (â€œdonâ€™t repeat yourselfâ€) tendencies.</p>
<blockquote>
<p>Keep the reader in your test function.
Good production code is well-factored; good test code is obvious.
â€¦ think about what will make the problem obvious when a test fails.</p>
<p>From the blog post <a href="https://mtlynch.io/good-developers-bad-tests/">Why Good Developers Write Bad Unit Tests</a></p>
</blockquote>
<p>Hereâ€™s a toy example to make things concrete.</p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"multiplication works"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">useful_thing</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸŒˆ</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"subtraction works"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">5</span> <span class="op">-</span> <span class="va">useful_thing</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸŒˆ</span></span></code></pre></div>
<p>In real life, <code>useful_thing</code> is usually a more complicated object that somehow feels burdensome to instantiate.
Notice how <code>useful_thing &lt;- 3</code> appears in more than once place.
Conventional wisdom says we should DRY this code out.
Itâ€™s tempting to just move <code>useful_thing</code>â€™s definition outside of the tests:</p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">useful_thing</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"multiplication works"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">useful_thing</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸŒˆ</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"subtraction works"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fl">5</span> <span class="op">-</span> <span class="va">useful_thing</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">Test passed</span> ğŸ˜¸</span></span></code></pre></div>
<p>But we really do think the first form, with the repetition, if often the better choice.</p>
<p>At this point, many readers might be thinking â€œbut the code I might have to repeat is much longer than 1 line!â€.
Below we describe the use of test fixtures.
This can often reduce complicated situations back to something that resembles this simple example.</p>
</div>
<div id="remove-tension-between-interactive-and-automated-testing" class="section level3" number="13.7.5">
<h3>
<span class="header-section-number">13.7.5</span> Remove tension between interactive and automated testing<a class="anchor" aria-label="anchor" href="#remove-tension-between-interactive-and-automated-testing"><i class="fas fa-link"></i></a>
</h3>
<p>Your test code will be executed in two different settings:</p>
<ul>
<li>Interactive test development and maintenance, which includes tasks like:
<ul>
<li>Initial test creation</li>
<li>Modifying tests to adapt to change</li>
<li>Debugging test failure</li>
</ul>
</li>
<li>Automated test runs, which is accomplished with functions such as:
<ul>
<li>Single file: <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test_active_file()</a></code>, <code><a href="https://testthat.r-lib.org/reference/test_file.html">testthat::test_file()</a></code>
</li>
<li>Whole package: <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code>, <code><a href="https://devtools.r-lib.org/reference/check.html">devtools::check()</a></code>
</li>
</ul>
</li>
</ul>
<p>Automated testing of your whole package is what takes priority.
This is ultimately the whole point of your tests.
However, the interactive experience is clearly important for the humans doing this work.
Therefore itâ€™s important to find a pleasant workflow, but also to ensure that you donâ€™t rig anything for interactive convenience that actually compromises the health of the test suite.</p>
<p>These two modes of test-running should not be in conflict with each other.
If you perceive tension between these two modes, this can indicate that youâ€™re not taking full advantage of some of testthatâ€™s features and the way itâ€™s designed to work with <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code>.</p>
<p>When working on your tests, use <code><a href="https://devtools.r-lib.org/reference/load_all.html">load_all()</a></code>, just like you do when working below <code>R/</code>.
By default, <code><a href="https://devtools.r-lib.org/reference/load_all.html">load_all()</a></code> does all of these things:</p>
<ul>
<li>Simulates re-building, re-installing, and re-loading your package.</li>
<li>Makes everything in your packageâ€™s namespace available, including unexported
functions and objects and anything youâ€™ve imported from another package.</li>
<li>Attaches testthat, i.e.Â does <code><a href="https://testthat.r-lib.org">library(testthat)</a></code>.</li>
<li>Runs test helper files, i.e.Â executes <code>test/testthat/helper.R</code> (more on that
below).</li>
</ul>
<p>This eliminates the need for any <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> calls below <code>tests/testthat/</code>, for the vast majority of R packages.
Any instance of <code><a href="https://testthat.r-lib.org">library(testthat)</a></code> is clearly no longer necessary.
Likewise, any instance of attaching one of your dependencies via <code><a href="https://rdrr.io/r/base/library.html">library(somePkg)</a></code> is unnecessary.
In your tests, if you need to call functions from somePkg, do it just as you do below <code>R/</code>.
If you have imported the function into your namespace, use <code>fun()</code>.
If you have not, use <code>somePkg::fun()</code>.
Itâ€™s fair to say that <code><a href="https://rdrr.io/r/base/library.html">library(somePkg)</a></code> in the tests should be about as rare as taking a dependency via <code>Depends</code>, i.e.Â there is almost always a better alternative.</p>
<p>Unnecessary calls to <code><a href="https://rdrr.io/r/base/library.html">library(somePkg)</a></code> in test files have a real downside, because they actually change the R landscape.
<code><a href="https://rdrr.io/r/base/library.html">library()</a></code> alters the search path.
This means the circumstances under which you are testing may not necessarily reflect the circumstances under which your package will be used.
This makes it easier to create subtle test bugs, which you will have to unravel in the future.</p>
<p>One other function that should almost never appear below <code>tests/testhat/</code> is <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>.
There are several special files with an official role in testthat workflows (see below), not to mention the entire R package machinery, that provide better ways to make functions, objects, and other logic available in your tests.</p>
</div>
</div>
<div id="tests-files-overview" class="section level2" number="13.8">
<h2>
<span class="header-section-number">13.8</span> Files relevant to testing<a class="anchor" aria-label="anchor" href="#tests-files-overview"><i class="fas fa-link"></i></a>
</h2>
<p>Here we review which package files are especially relevant to testing and, more generally, best practices for interacting with the file system from your tests.</p>
<div id="hiding-in-plain-sight-files-below-r" class="section level3" number="13.8.1">
<h3>
<span class="header-section-number">13.8.1</span> Hiding in plain sight: files below <code>R/</code><a class="anchor" aria-label="anchor" href="#hiding-in-plain-sight-files-below-r"><i class="fas fa-link"></i></a>
</h3>
<p>The most important functions youâ€™ll need to access from your tests are clearly those in your package!
Here weâ€™re talking about everything thatâ€™s defined below <code>R/</code>.
The functions and other objects defined by your package are always available when testing, regardless of whether they are exported or not.
For interactive work, <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> takes care of this.
During automated testing, this is taken care of internally by testthat.</p>
<p>This implies that test helpers can absolutely be defined below <code>R/</code> and used freely in your tests.
It might make sense to gather such helpers in a clearly marked file, such as one of these:</p>
<pre><code>.                              
â”œâ”€â”€ ...
â””â”€â”€ R
    â”œâ”€â”€ ...
    â”œâ”€â”€ test-helpers.R
    â”œâ”€â”€ test-utils.R
    â”œâ”€â”€ utils-testing.R
    â””â”€â”€ ...</code></pre>
</div>
<div id="teststesthat.r" class="section level3" number="13.8.2">
<h3>
<span class="header-section-number">13.8.2</span> <code>tests/testhat.R</code><a class="anchor" aria-label="anchor" href="#teststesthat.r"><i class="fas fa-link"></i></a>
</h3>
<p>Recall the initial testthat setup described in section <a href="tests.html#tests-mechanics-workflow">13.3</a>:
The standard <code>tests/testhat.R</code> file looks like this:</p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">abcde</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_package.html">test_check</a></span><span class="op">(</span><span class="st">"abcde"</span><span class="op">)</span></span></code></pre></div>
<p>We repeat the advice to not edit <code>tests/testthat.R</code>.
It is run during <code>R CMD check</code> (and, therefore, <code><a href="https://devtools.r-lib.org/reference/check.html">devtools::check()</a></code>), but is not used in most other test-running scenarios (such as <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code> or <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test_active_file()</a></code> or during interactive development).
Do not attach your dependencies here with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>.
Call them in your tests in the same manner as you do below <code>R/</code>.</p>
</div>
<div id="testthat-helper-files" class="section level3" number="13.8.3">
<h3>
<span class="header-section-number">13.8.3</span> Testthat helper files<a class="anchor" aria-label="anchor" href="#testthat-helper-files"><i class="fas fa-link"></i></a>
</h3>
<p>Another type of file that is always executed by <code><a href="https://devtools.r-lib.org/reference/load_all.html">load_all()</a></code> and at the beginning of automated testing is a helper file, defined as any file below <code>tests/testthat/</code> that begins with <code>helper</code>.
Helper files are a mighty weapon in the battle to eliminate code floating around at the top-level of test files.
Helper files are a prime example of what we mean when we recommend moving such code into a broader scope.
Objects or functions defined in a helper file are available to all of your tests.</p>
<p>If you have just one such file, you should probably name it <code>helper.R</code>.
If you organize your helpers into multiple files, you could include a suffix with additional info.
Here are examples of how such files might look:</p>
<pre><code>.                              
â”œâ”€â”€ ...
â””â”€â”€ tests
    â”œâ”€â”€ testthat
    â”‚   â”œâ”€â”€ helper.R
    â”‚   â”œâ”€â”€ helper-blah.R
    â”‚   â”œâ”€â”€ helper-foo.R    
    â”‚   â”œâ”€â”€ test-foofy.R
    â”‚   â””â”€â”€ (more test files)
    â””â”€â”€ testthat.R</code></pre>
<p>Many developers use helper files to define custom test helper functions, which we describe in detail below.
Compared to defining helpers below <code>R/</code>, some people find that <code>tests/testthat/helper.R</code> makes it more clear that these utilities are specifically for testing the package.
This location also feels more natural if your helpers rely on testthat functions.</p>
<p>A helper file is also a good location for setup code that is needed for its side effects.
This is a case where <code>tests/testthat/helper.R</code> is clearly more appropriate than a file below <code>R/</code>.
For example, in an API-wrapping package, <code>helper.R</code> is a good place to (attempt to) authenticate with the testing credentials.</p>
</div>
<div id="testthat-setup-files" class="section level3" number="13.8.4">
<h3>
<span class="header-section-number">13.8.4</span> Testthat setup files<a class="anchor" aria-label="anchor" href="#testthat-setup-files"><i class="fas fa-link"></i></a>
</h3>
<p>Testthat has one more special file type: setup files, defined as any file below <code>test/testthat/</code> that begins with <code>setup</code>.
Hereâ€™s an example of how that might look:</p>
<pre><code>.                              
â”œâ”€â”€ ...
â””â”€â”€ tests
    â”œâ”€â”€ testthat
    â”‚   â”œâ”€â”€ helper.R
    â”‚   â”œâ”€â”€ setup.R
    â”‚   â”œâ”€â”€ test-foofy.R
    â”‚   â””â”€â”€ (more test files)
    â””â”€â”€ testthat.R</code></pre>
<p>A setup file is handled almost exactly like a helper file, but with two big differences:</p>
<ul>
<li>Setup files are not executed by <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code>.</li>
<li>Setup files often contain the corresponding teardown code.</li>
</ul>
<p>Setup files are good for global test setup that is tailored for test execution in non-interactive or remote environments.
For example, you might turn off behaviour thatâ€™s aimed at an interactive user, such as messaging or writing to the clipboard.</p>
<p>If any of your setup should be reversed after test execution, you should also include the necessary teardown code in <code>setup.R</code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;A legacy approach (which still works, but is no longer recommended) is to put teardown code in &lt;code&gt;tests/testthat/teardown.R&lt;/code&gt;.&lt;/p&gt;"><sup>31</sup></a>.
We recommend maintaining teardown code alongside the setup code, in <code>setup.R</code>, because this makes it easier to ensure they stay in sync.
The artificial environment <code><a href="https://testthat.r-lib.org/reference/teardown_env.html">teardown_env()</a></code> exists as a magical handle to use in <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code> and <code>withr::local_*()</code> / <code>withr::with_*()</code>.</p>
<p>Hereâ€™s a <code>setup.R</code> example from the reprex package, where we turn off clipboard and HTML preview functionality during testing:</p>
<div class="sourceCode" id="cb204"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>reprex.clipboard <span class="op">=</span> <span class="cn">FALSE</span>, reprex.html_preview <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, <span class="fu"><a href="https://testthat.r-lib.org/reference/teardown_env.html">teardown_env</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Since we are just modifying options here, we can be even more concise and use the pre-built function <code><a href="https://withr.r-lib.org/reference/with_options.html">withr::local_options()</a></code> and pass <code><a href="https://testthat.r-lib.org/reference/teardown_env.html">teardown_env()</a></code> as the <code>.local_envir</code>:</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>reprex.clipboard <span class="op">=</span> <span class="cn">FALSE</span>, reprex.html_preview <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  .local_envir <span class="op">=</span> <span class="fu"><a href="https://testthat.r-lib.org/reference/teardown_env.html">teardown_env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="files-ignored-by-testthat" class="section level3" number="13.8.5">
<h3>
<span class="header-section-number">13.8.5</span> Files ignored by testthat<a class="anchor" aria-label="anchor" href="#files-ignored-by-testthat"><i class="fas fa-link"></i></a>
</h3>
<p>testthat only automatically executes files where these are both true:</p>
<ul>
<li>File is a direct child of <code>tests/testthat/</code>
</li>
<li>File name starts with one of the specific strings:
<ul>
<li><code>helper</code></li>
<li><code>setup</code></li>
<li><code>test</code></li>
</ul>
</li>
</ul>
<p>It is fine to have other files or directories in <code>tests/testthat/</code>, but testthat wonâ€™t automatically do anything with them (other than the <code>_snaps</code> directory, which holds snapshots).</p>
</div>
<div id="storing-test-data" class="section level3" number="13.8.6">
<h3>
<span class="header-section-number">13.8.6</span> Storing test data<a class="anchor" aria-label="anchor" href="#storing-test-data"><i class="fas fa-link"></i></a>
</h3>
<p>Many packages contain files that hold test data.
Where should these be stored?
The best location is somewhere below <code>tests/testthat/</code>, often in a subdirectory, to keep things neat.
Below is an example, where <code>useful_thing1.rds</code> and <code>useful_thing2.rds</code> hold objects used in the test files.</p>
<pre><code>.
â”œâ”€â”€ ...
â””â”€â”€ tests
    â”œâ”€â”€ testthat
    â”‚   â”œâ”€â”€ fixtures
    â”‚   â”‚   â”œâ”€â”€ make-useful-things.R
    â”‚   â”‚   â”œâ”€â”€ useful_thing1.rds
    â”‚   â”‚   â””â”€â”€ useful_thing2.rds
    â”‚   â”œâ”€â”€ helper.R
    â”‚   â”œâ”€â”€ setup.R
    â”‚   â””â”€â”€ (all the test files)
    â””â”€â”€ testthat.R</code></pre>
<p>Then, in your tests, use <code><a href="https://testthat.r-lib.org/reference/test_path.html">testthat::test_path()</a></code> to build a robust filepath to such files.</p>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foofy() does this"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_path.html">test_path</a></span><span class="op">(</span><span class="st">"fixtures"</span>, <span class="st">"useful_thing1.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># ...</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://testthat.r-lib.org/reference/test_path.html">testthat::test_path()</a></code> is extremely handy, because it produces the correct path in the two important modes of test execution:</p>
<ul>
<li>Interactive test development and maintenance, where working directory is
presumably set to the top-level of the package.</li>
<li>Automated testing, where working directory is usually set to something
below <code>tests/</code>.</li>
</ul>
</div>
<div id="tests-files-where-write" class="section level3" number="13.8.7">
<h3>
<span class="header-section-number">13.8.7</span> Where to write files during testing<a class="anchor" aria-label="anchor" href="#tests-files-where-write"><i class="fas fa-link"></i></a>
</h3>
<p>If itâ€™s easy to avoid writing files from you tests, that is definitely the best plan.
But there are many times when you really must write files.</p>
<p><strong>You should only write files inside the session temp directory.</strong>
Do not write into your packageâ€™s <code>tests/</code> directory.
Do not write into the current working directory.
Do not write into the userâ€™s home directory.
Even though you are writing into the session temp directory, you should still clean up after yourself, i.e.Â delete any files youâ€™ve written.</p>
<p>Most package developers donâ€™t want to hear this, because it sounds like a hassle.
But itâ€™s not that burdensome once you get familiar with a few techniques and build some new habits.
A high level of file system discipline also eliminates various testing bugs and will absolutely make your CRAN life run more smoothly.</p>
<p>This test is from roxygen2 and demonstrates everything we recommend:</p>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"can read from file name with utf-8 path"</span>, <span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_tempfile.html">local_tempfile</a></span><span class="op">(</span></span>
<span>    pattern <span class="op">=</span> <span class="st">"Universit\u00e0-"</span>,</span>
<span>    lines <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#' @include foo.R"</span>, <span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">find_includes</span><span class="op">(</span><span class="va">path</span><span class="op">)</span>, <span class="st">"foo.R"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://withr.r-lib.org/reference/with_tempfile.html">withr::local_tempfile()</a></code> creates a file within the session temp directory whose lifetime is tied to the â€œlocalâ€ environment â€“ in this case, the execution environment of an individual test.
It is a wrapper around <code><a href="https://rdrr.io/r/base/tempfile.html">base::tempfile()</a></code> and passes, e.g., the <code>pattern</code> argument through, so you have some control over the file name.
You can optionally provide <code>lines</code> to populate the file with at creation time or you can write to the file in all the usual ways in subsequent steps.
Finally, with no special effort on your part, the temporary file will automatically be deleted at the end of the test.</p>
<p>Sometimes you need even more control over the file name.
In that case, you can use <code><a href="https://withr.r-lib.org/reference/with_tempfile.html">withr::local_tempdir()</a></code> to create a self-deleting temporary directory and write intentionally-named files inside this directory.</p>
</div>
</div>
<div id="test-fixtures" class="section level2" number="13.9">
<h2>
<span class="header-section-number">13.9</span> Test fixtures<a class="anchor" aria-label="anchor" href="#test-fixtures"><i class="fas fa-link"></i></a>
</h2>
<p>When itâ€™s not practical to make your test entirely self-sufficient, prefer making the necessary object, logic, or conditions available in a structured, explicit way.
Thereâ€™s a pre-existing term for this in software engineering: a <em>test fixture</em>.</p>
<blockquote>
<p>A test fixture is something used to consistently test some item, device, or
piece of software.
â€” Wikipedia</p>
</blockquote>
<p>The main idea is that we need to make it as easy and obvious as possible to arrange the world into a state that is conducive for testing.
We describe several specific solutions to this problem:</p>
<ul>
<li>Put repeated code in a constructor-type helper function. Memoise it, if
construction is demonstrably slow.</li>
<li>If the repeated code has side effects, write a custom <code>local_*()</code> function to
do whatâ€™s needed and clean up afterwards.</li>
<li>If the above approaches are too slow or awkward and the thing you need is
fairly stable, save it as a static file and load it.</li>
</ul>
<!--
I have not found a good example of memoising a test helper in the wild.

Here's a clean little example of low-tech memoisation, taken from pillar, in
case I come back to this.

# Only check if we have color support once per session
num_colors <- local({
  num_colors <- NULL
  function(forget = FALSE) {
    if (is.null(num_colors) || forget) {
      num_colors <<- cli::num_ansi_colors()
    }
    num_colors
  }
})
--><div id="create-useful_things-with-a-helper-function" class="section level3" number="13.9.1">
<h3>
<span class="header-section-number">13.9.1</span> Create <code>useful_thing</code>s with a helper function<a class="anchor" aria-label="anchor" href="#create-useful_things-with-a-helper-function"><i class="fas fa-link"></i></a>
</h3>
<p>Is it fiddly to create a <code>useful_thing</code>?
Does it take several lines of code, but not much time or memory?
In that case, write a helper function to create a <code>useful_thing</code> on-demand:</p>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_useful_thing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># your fiddly code to create a useful_thing goes here</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>and call that helper in the affected tests:</p>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foofy() does this"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing1</span> <span class="op">&lt;-</span> <span class="fu">new_useful_thing</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">foofy</span><span class="op">(</span><span class="va">useful_thing1</span>, x <span class="op">=</span> <span class="st">"this"</span><span class="op">)</span>, <span class="va">EXPECTED_FOOFY_OUTPUT</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foofy() does that"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing2</span> <span class="op">&lt;-</span> <span class="fu">new_useful_thing</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">foofy</span><span class="op">(</span><span class="va">useful_thing2</span>, x <span class="op">=</span> <span class="st">"that"</span><span class="op">)</span>, <span class="va">EXPECTED_FOOFY_OUTPUT</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where should the <code>new_useful_thing()</code> helper be defined?
This comes back to what we outlined in section <a href="tests.html#tests-files-overview">13.8</a>.
Test helpers can be defined below <code>R/</code>, just like any other internal utility in your package.
Another popular location is in a test helper file, e.g.Â <code>tests/testthat/helper.R</code>.
A key feature of both options is that the helpers are made available to you during interactive maintenance via <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code>.</p>
<p>If itâ€™s fiddly AND costly to create a <code>useful_thing</code>, your helper function could even use memoisation to avoid unnecessary re-computation.
Once you have a helper like <code>new_useful_thing()</code>, you often discover that it has uses beyond testing, e.g.Â behind-the-scenes in a vignette.
Sometimes you even realize you should just define it below <code>R/</code> and export and document it, so you can use it freely in documentation and tests.</p>
</div>
<div id="create-and-destroy-a-local-useful_thing" class="section level3" number="13.9.2">
<h3>
<span class="header-section-number">13.9.2</span> Create (and destroy) a â€œlocalâ€ <code>useful_thing</code><a class="anchor" aria-label="anchor" href="#create-and-destroy-a-local-useful_thing"><i class="fas fa-link"></i></a>
</h3>
<p>So far, our example of a <code>useful_thing</code> was a regular R object, which is cleaned-up automatically at the end of each test.
What if the creation of a <code>useful_thing</code> has a side effect on the local file system, on a remote resource, R session options, environment variables, or the like?
Then your helper function should create a <code>useful_thing</code> <strong>and clean up afterwards</strong>.
Instead of a simple <code>new_useful_thing()</code> constructor, youâ€™ll write a customized function in the style of withrâ€™s <code>local_*()</code> functions:</p>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local_useful_thing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># your fiddly code to create a useful_thing goes here</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span></span>
<span>    <span class="co"># your fiddly code to clean up after a useful_thing goes here</span></span>
<span>    envir <span class="op">=</span> <span class="va">env</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Use it in your tests like this:</p>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foofy() does this"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing1</span> <span class="op">&lt;-</span> <span class="fu">local_useful_thing</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">foofy</span><span class="op">(</span><span class="va">useful_thing1</span>, x <span class="op">=</span> <span class="st">"this"</span><span class="op">)</span>, <span class="va">EXPECTED_FOOFY_OUTPUT</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foofy() does that"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing2</span> <span class="op">&lt;-</span> <span class="fu">local_useful_thing</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">foofy</span><span class="op">(</span><span class="va">useful_thing2</span>, x <span class="op">=</span> <span class="st">"that"</span><span class="op">)</span>, <span class="va">EXPECTED_FOOFY_OUTPUT</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Where should the <code>local_useful_thing()</code> helper be defined?
All the advice given above for <code>new_useful_thing()</code> applies:
define it below <code>R/</code> or in a test helper file.</p>
<p>To learn more about writing custom helpers like <code>local_useful_thing()</code>, see the <a href="https://testthat.r-lib.org/articles/test-fixtures.html">testthat vignette on test fixtures</a>.</p>
</div>
<div id="store-a-concrete-useful_thing-persistently" class="section level3" number="13.9.3">
<h3>
<span class="header-section-number">13.9.3</span> Store a concrete <code>useful_thing</code> persistently<a class="anchor" aria-label="anchor" href="#store-a-concrete-useful_thing-persistently"><i class="fas fa-link"></i></a>
</h3>
<p>If a <code>useful_thing</code> is costly to create, in terms of time or memory, maybe you donâ€™t actually need to re-create it for each test run.
You could make the <code>useful_thing</code> once, store it as a static test fixture, and load it in the tests that need it.
Hereâ€™s a sketch of how this could look:</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foofy() does this"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_path.html">test_path</a></span><span class="op">(</span><span class="st">"fixtures"</span>, <span class="st">"useful_thing.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">foofy</span><span class="op">(</span><span class="va">useful_thing1</span>, x <span class="op">=</span> <span class="st">"this"</span><span class="op">)</span>, <span class="va">EXPECTED_FOOFY_OUTPUT</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foofy() does that"</span>, <span class="op">{</span></span>
<span>  <span class="va">useful_thing2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_path.html">test_path</a></span><span class="op">(</span><span class="st">"fixtures"</span>, <span class="st">"useful_thing.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu">foofy</span><span class="op">(</span><span class="va">useful_thing2</span>, x <span class="op">=</span> <span class="st">"that"</span><span class="op">)</span>, <span class="va">EXPECTED_FOOFY_OUTPUT</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Now we can revisit a file listing from earlier, which addressed exactly this scenario:</p>
<pre><code>.
â”œâ”€â”€ ...
â””â”€â”€ tests
    â”œâ”€â”€ testthat
    â”‚   â”œâ”€â”€ fixtures
    â”‚   â”‚   â”œâ”€â”€ make-useful-things.R
    â”‚   â”‚   â”œâ”€â”€ useful_thing1.rds
    â”‚   â”‚   â””â”€â”€ useful_thing2.rds
    â”‚   â”œâ”€â”€ helper.R
    â”‚   â”œâ”€â”€ setup.R
    â”‚   â””â”€â”€ (all the test files)
    â””â”€â”€ testthat.R</code></pre>
<p>This shows static test files stored in <code>tests/testthat/fixtures/</code>, but also notice the companion R script, <code>make-useful-things.R</code>.
From data analysis, we all know there is no such things as a script that is run only once.
Refinement and iteration is inevitable.
This also holds true for test objects like <code>useful_thing1.rds</code>.
We highly recommend saving the R code used to create your test objects, so that they can be re-created as needed.</p>
</div>
</div>
<div id="building-your-own-testing-tools" class="section level2" number="13.10">
<h2>
<span class="header-section-number">13.10</span> Building your own testing tools<a class="anchor" aria-label="anchor" href="#building-your-own-testing-tools"><i class="fas fa-link"></i></a>
</h2>
<p>Letâ€™s return to the topic of duplication in your test code.
Weâ€™ve encouraged you to have a higher tolerance for repetition in test code, in the name of making your tests obvious.
But thereâ€™s still a limit to how much repetition to tolerate.
Weâ€™ve covered techniques such as loading static objects with <code><a href="https://testthat.r-lib.org/reference/test_path.html">test_path()</a></code>, writing a constructor like <code>new_useful_thing()</code>, or implementing a test fixture like <code>local_useful_thing()</code>.
There are even more types of test helpers that can be useful in certain situations.</p>
<div id="helper-defined-inside-a-test" class="section level3" number="13.10.1">
<h3>
<span class="header-section-number">13.10.1</span> Helper defined inside a test<a class="anchor" aria-label="anchor" href="#helper-defined-inside-a-test"><i class="fas fa-link"></i></a>
</h3>
<p>Consider this test for the <code><a href="https://stringr.tidyverse.org/reference/str_trunc.html">str_trunc()</a></code> function in stringr:</p>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># from stringr (hypothetically)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"truncations work for all sides"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trunc.html">str_trunc</a></span><span class="op">(</span><span class="st">"This string is moderately long"</span>, width <span class="op">=</span> <span class="fl">20</span>, side <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>,</span>
<span>    <span class="st">"This string is mo..."</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trunc.html">str_trunc</a></span><span class="op">(</span><span class="st">"This string is moderately long"</span>, width <span class="op">=</span> <span class="fl">20</span>, side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>,</span>
<span>    <span class="st">"...s moderately long"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trunc.html">str_trunc</a></span><span class="op">(</span><span class="st">"This string is moderately long"</span>, width <span class="op">=</span> <span class="fl">20</span>, side <span class="op">=</span> <span class="st">"center"</span><span class="op">)</span>,</span>
<span>    <span class="st">"This stri...ely long"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Thereâ€™s a lot of repetition here, which increases the chance of copy / paste errors and generally makes your eyes glaze over.
Sometimes itâ€™s nice to create a hyper-local helper, <em>inside the test</em>.
Hereâ€™s how the test actually looks in stringr</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># from stringr (actually)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"truncations work for all sides"</span>, <span class="op">{</span></span>
<span></span>
<span>  <span class="va">trunc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">direction</span><span class="op">)</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trunc.html">str_trunc</a></span><span class="op">(</span></span>
<span>    <span class="st">"This string is moderately long"</span>,</span>
<span>    <span class="va">direction</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">trunc</a></span><span class="op">(</span><span class="st">"right"</span><span class="op">)</span>,   <span class="st">"This string is mo..."</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">trunc</a></span><span class="op">(</span><span class="st">"left"</span><span class="op">)</span>,    <span class="st">"...s moderately long"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">trunc</a></span><span class="op">(</span><span class="st">"center"</span><span class="op">)</span>,  <span class="st">"This stri...ely long"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>A hyper-local helper like <code><a href="https://rdrr.io/r/base/Round.html">trunc()</a></code> is particularly useful when it allows you to fit all the important business for each expectation on one line.
Then your expectations can be read almost like a table of actual vs.Â expected, for a set of related use cases.
Above, itâ€™s very easy to watch the result change as we truncate the input from the right, left, and in the center.</p>
<p>Note that this technique should be used in extreme moderation.
A helper like <code><a href="https://rdrr.io/r/base/Round.html">trunc()</a></code> is yet another place where you can introduce a bug, so itâ€™s best to keep such helpers extremely short and simple.</p>
</div>
<div id="custom-expectatations" class="section level3" number="13.10.2">
<h3>
<span class="header-section-number">13.10.2</span> Custom expectatations<a class="anchor" aria-label="anchor" href="#custom-expectatations"><i class="fas fa-link"></i></a>
</h3>
<p>If a more complicated helper feels necessary, itâ€™s a good time to reflect on why that is.
If itâ€™s fussy to get into position to <em>test</em> a function, that could be a sign that itâ€™s also fussy to <em>use</em> that function.
Do you need to refactor it?
If the function seems sound, then you probably need to use a more formal helper, defined outside of any individual test, as described earlier.</p>
<p>One specific type of helper you might want to create is a custom expectation.
Here are two very simple ones from usethis:</p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expect_usethis_error</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html">expect_error</a></span><span class="op">(</span><span class="va">...</span>, class <span class="op">=</span> <span class="st">"usethis_error"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">expect_proj_file</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html">expect_true</a></span><span class="op">(</span><span class="fu">file_exists</span><span class="op">(</span><span class="fu"><a href="https://usethis.r-lib.org/reference/proj_utils.html">proj_path</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code>expect_usethis_error()</code> checks that an error has the <code>"usethis_error"</code> class.
<code>expect_proj_file()</code> is a simple wrapper around <code>file_exists()</code> that searches for the file in the current project.
These are very simple functions, but the sheer amount of repetition and the expressiveness of their names makes them feel justified.</p>
<p>It is somewhat involved to make a proper custom expectation, i.e.Â one that behaves like the expectations built into testthat.
We refer you to the <a href="https://testthat.r-lib.org/articles/custom-expectation.html">Custom expectations</a> vignette if you wish to learn more about that.</p>
<p>Finally, it can be handy to know that testthat makes specific information available when itâ€™s running:</p>
<ul>
<li>
<p>The environment variable <code>TESTTHAT</code> is set to <code>"true"</code>.
<code><a href="https://testthat.r-lib.org/reference/is_testing.html">testthat::is_testing()</a></code> is a shortcut:</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">is_testing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"TESTTHAT_PKG"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>The package-under-test is available as the environment variable <code>TESTTHAT_PKG</code>
and <code><a href="https://testthat.r-lib.org/reference/is_testing.html">testthat::testing_package()</a></code> is a shortcut:</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testing_package</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"TESTTHAT_PKG"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
</ul>
<p>In some situations, you may want to exploit this information without taking a run-time dependency on testthat.
In that case, just inline the source of these functions directly into your package.</p>
</div>
</div>
<div id="when-testing-gets-hard" class="section level2" number="13.11">
<h2>
<span class="header-section-number">13.11</span> When testing gets hard<a class="anchor" aria-label="anchor" href="#when-testing-gets-hard"><i class="fas fa-link"></i></a>
</h2>
<p>Despite all the techniques weâ€™ve covered so far, there remain situations where it still feels very difficult to write tests.
In this section, we review more ways to deal with challenging situations:</p>
<ul>
<li>Skipping a test in certain situations</li>
<li>Mocking an external service</li>
<li>Dealing with secrets</li>
</ul>
<div id="tests-skipping" class="section level3" number="13.11.1">
<h3>
<span class="header-section-number">13.11.1</span> Skipping a test<a class="anchor" aria-label="anchor" href="#tests-skipping"><i class="fas fa-link"></i></a>
</h3>
<p>Sometimes itâ€™s impossible to perform a test - you may not have an internet connection or you may not have access to the necessary credentials.
Unfortunately, another likely reason follows from this simple rule:
the more platforms you use to test your code, the more likely it is that you wonâ€™t be able to run all of your tests, all of the time.
In short, there are times when, instead of getting a failure, you just want to skip a test.</p>
<div id="testthatskip" class="section level4" number="13.11.1.1">
<h4>
<span class="header-section-number">13.11.1.1</span> <code>testthat::skip()</code><a class="anchor" aria-label="anchor" href="#testthatskip"><i class="fas fa-link"></i></a>
</h4>
<p>Here we use <code><a href="https://testthat.r-lib.org/reference/skip.html">testthat::skip()</a></code> to write a hypothetical custom skipper, <code>skip_if_no_api()</code>:</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">skip_if_no_api</span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">api_unavailable</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip</a></span><span class="op">(</span><span class="st">"API not available"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns bar when given baz"</span>, <span class="op">{</span></span>
<span>  <span class="fu">skip_if_no_api</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><code>skip_if_no_api()</code> is a yet another example of a test helper and the advice already given about where to define it applies here too.</p>
<p><code><a href="https://testthat.r-lib.org/reference/skip.html">skip()</a></code>s and the associated reasons are reported inline as tests are executed and are also indicated clearly in the summary:</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html">test</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; â„¹ Loading abcde</span></span>
<span><span class="co">#&gt; â„¹ Testing abcde</span></span>
<span><span class="co">#&gt; âœ” | F W S  OK | Context</span></span>
<span><span class="co">#&gt; âœ” |         2 | blarg</span></span>
<span><span class="co">#&gt; âœ” |     1   2 | foofy</span></span>
<span><span class="co">#&gt; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; Skip (test-foofy.R:6:3): foo api returns bar when given baz</span></span>
<span><span class="co">#&gt; Reason: API not available</span></span>
<span><span class="co">#&gt; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; âœ” |         0 | yo                                                              </span></span>
<span><span class="co">#&gt; â•â• Results â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span><span class="co">#&gt; â”€â”€ Skipped tests  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; â€¢ API not available (1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [ FAIL 0 | WARN 0 | SKIP 1 | PASS 4 ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ğŸ¥³</span></span></code></pre></div>
<p>Something like <code>skip_if_no_api()</code> is likely to appear many times in your test suite.
This is another occasion where it is tempting to DRY things out, by hoisting the <code><a href="https://testthat.r-lib.org/reference/skip.html">skip()</a></code> to the top-level of the file.
However, we still lean towards calling <code>skip_if_no_api()</code> in each test where itâ€™s needed.</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># we prefer this:</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns bar when given baz"</span>, <span class="op">{</span></span>
<span>  <span class="fu">skip_if_no_api</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns an errors when given qux"</span>, <span class="op">{</span></span>
<span>  <span class="fu">skip_if_no_api</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># over this:</span></span>
<span><span class="fu">skip_if_no_api</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns bar when given baz"</span>, <span class="op">{</span><span class="va">...</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns an errors when given qux"</span>, <span class="op">{</span><span class="va">...</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Within the realm of top-level code in test files, having a <code><a href="https://testthat.r-lib.org/reference/skip.html">skip()</a></code> at the very beginning of a test file is one of the more benign situations.
But once a test file does not fit entirely on your screen, it creates an implicit yet easy-to-miss connection between the <code><a href="https://testthat.r-lib.org/reference/skip.html">skip()</a></code> and individual tests.</p>
</div>
<div id="built-in-skip-functions" class="section level4" number="13.11.1.2">
<h4>
<span class="header-section-number">13.11.1.2</span> Built-in <code>skip()</code> functions<a class="anchor" aria-label="anchor" href="#built-in-skip-functions"><i class="fas fa-link"></i></a>
</h4>
<p>Similar to testthatâ€™s built-in expectations, there is a family of <code><a href="https://testthat.r-lib.org/reference/skip.html">skip()</a></code> functions that anticipate some common situations.
These functions often relieve you of the need to write a custom skipper.
Here are some examples of the most useful <code><a href="https://testthat.r-lib.org/reference/skip.html">skip()</a></code> functions:</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns bar when given baz"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_if</a></span><span class="op">(</span><span class="fu">api_unavailable</span><span class="op">(</span><span class="op">)</span>, <span class="st">"API not available"</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"foo api returns bar when given baz"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_if_not</a></span><span class="op">(</span><span class="fu">api_available</span><span class="op">(</span><span class="op">)</span>, <span class="st">"API not available"</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_if_not_installed</a></span><span class="op">(</span><span class="st">"sp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_if_not_installed</a></span><span class="op">(</span><span class="st">"stringi"</span>, <span class="st">"1.2.2"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_if_offline</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_os</a></span><span class="op">(</span><span class="st">"windows"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="dangers-of-skipping" class="section level4" number="13.11.1.3">
<h4>
<span class="header-section-number">13.11.1.3</span> Dangers of skipping<a class="anchor" aria-label="anchor" href="#dangers-of-skipping"><i class="fas fa-link"></i></a>
</h4>
<p>One challenge with skips is that they are currently completely invisible in CI â€” if you automatically skip too many tests, itâ€™s easy to fool yourself that all your tests are passing when in fact theyâ€™re just being skipped!
In an ideal world, your CI/CD would make it easy to see how many tests are being skipped and how that changes over time.</p>
<p><em>2022-06-01: Recent changes to GitHub Actions mean that we will likely have better test reporting before the second edition of this book is published. Stay tuned!</em></p>
<p>Itâ€™s a good practice to regularly dig into the <code>R CMD check</code> results, especially on CI, and make sure the skips are as you expect.
But this tends to be something you have to learn through experience.</p>
</div>
</div>
<div id="mocking" class="section level3" number="13.11.2">
<h3>
<span class="header-section-number">13.11.2</span> Mocking<a class="anchor" aria-label="anchor" href="#mocking"><i class="fas fa-link"></i></a>
</h3>
<p>The practice known as mocking is when we replace something thatâ€™s complicated or unreliable or out of our control with something simpler, thatâ€™s fully within our control.
Usually we are mocking an external service, such as a REST API, or a function that reports something about session state, such as whether the session is interactive.</p>
<p>The classic application of mocking is in the context of a package that wraps an external API.
In order to test your functions, technically you need to make a live call to that API to get a response, which you then process.
But what if that API requires authentication or what if itâ€™s somewhat flaky and has occasional downtime?
It can be more productive to just <em>pretend</em> to call the API but, instead, to test the code under your control by processing a pre-recorded response from the actual API.</p>
<p>Our main advice about mocking is to avoid it if you can.
This is not an indictment of mocking, but just a realistic assessment that mocking introduces new complexity that is not always justified by the payoffs.</p>
<p>Since most R packages do not need full-fledged mocking, we do not cover it here.
Instead weâ€™ll point you to the packages that represent the state-of-the-art for mocking in R today:</p>
<ul>
<li>mockery: <a href="https://github.com/r-lib/mockery" class="uri">https://github.com/r-lib/mockery</a>
</li>
<li>mockr: <a href="https://krlmlr.github.io/mockr/" class="uri">https://krlmlr.github.io/mockr/</a>
</li>
<li>httptest: <a href="https://enpiar.com/r/httptest/" class="uri">https://enpiar.com/r/httptest/</a>
</li>
<li>httptest2: <a href="https://enpiar.com/httptest2/" class="uri">https://enpiar.com/httptest2/</a>
</li>
<li>webfakes: <a href="https://webfakes.r-lib.org" class="uri">https://webfakes.r-lib.org</a>
</li>
</ul>
</div>
<div id="secrets" class="section level3" number="13.11.3">
<h3>
<span class="header-section-number">13.11.3</span> Secrets<a class="anchor" aria-label="anchor" href="#secrets"><i class="fas fa-link"></i></a>
</h3>
<p>Another common challenge for packages that wrap an external service is the need to manage credentials.
Specifically, it is likely that you will need to provide a set of test credentials to fully test your package.</p>
<p>Our main advice here is to design your package so that large parts of it can be tested without live, authenticated assess to the external service.</p>
<p>Of course, you will still want to be able to test your package against the actual service that it wraps, in environments that support secure environment variables.
Since this is also a very specialized topic, we wonâ€™t go into more detail here.
Instead we refer you to the <a href="https://httr2.r-lib.org/articles/wrapping-apis.html#secret-management">Wrapping APIs</a> vignette in the httr2 package, which offers substantial support for secret management.</p>
</div>
</div>
<div id="special-considerations-for-cran-packages" class="section level2" number="13.12">
<h2>
<span class="header-section-number">13.12</span> Special considerations for CRAN packages<a class="anchor" aria-label="anchor" href="#special-considerations-for-cran-packages"><i class="fas fa-link"></i></a>
</h2>
<div id="tests-cran-flavors-services" class="section level3" number="13.12.1">
<h3>
<span class="header-section-number">13.12.1</span> CRAN check flavors and related services<a class="anchor" aria-label="anchor" href="#tests-cran-flavors-services"><i class="fas fa-link"></i></a>
</h3>
<p><em>This section will likely move to a different location, once we revise and expand the content elsewhere in the book on <code>R CMD check</code> and package release. But it can gestate here.</em></p>
<p>CRAN runs <code>R CMD check</code> on all contributed packages on a regular basis, on multiple platforms or what they call â€œflavorsâ€.
This check includes, but is not limited to, your testthat tests.
CRANâ€™s check flavors almost certainly include platforms other than your preferred development environment(s), so you must proactively plan ahead if you want your tests to pass there.</p>
<p>You can see CRANâ€™s current check flavors here: <a href="https://cran.r-project.org/web/checks/check_flavors.html" class="uri">https://cran.r-project.org/web/checks/check_flavors.html</a>.
There are various combinations of:</p>
<ul>
<li>Operating system and CPU: Windows, macOS (x86_64, arm64), Linux (various distributions)</li>
<li>R version: r-devel, r-release, r-oldrel</li>
<li>C, C++, FORTRAN compilers</li>
<li>Locale, in the sense of the <code>LC_CTYPE</code> environment variable (this is about
which human language is in use and character encoding)</li>
</ul>
<p>It would be impractical for individual package developers to personally maintain all of these testing platforms.
Instead, we turn to various community- and CRAN-maintained resources to test our packages.
In order of how often we use them:</p>
<ul>
<li>
<p>GitHub Actions (GHA).
Many R package developers host their source code on GitHub and use GHA to
check their package, e.g., every time they push.</p>
<p>The usethis package offers several functions to help you configure GHA
workflows for checking your package.
The most appropriate level of checking depends on the nature of your user base
and how likely it is that your package could behave differently across the
flavors (e.g.Â does it contain compiled code?)</p>
<ul>
<li>
<code><a href="https://usethis.r-lib.org/reference/github_actions.html">usethis::use_github_action_check_release()</a></code>: an entry-level, bare-minimum
workflow that checks with the latest release of R on Linux.</li>
<li>
<code><a href="https://usethis.r-lib.org/reference/github_actions.html">usethis::use_github_action_check_standard()</a></code>: Covers the three major
operating systems and both the released and development versions of R. This
is a good choice for a package that is (or aspires to be) on CRAN or
Bioconductor.</li>
<li>The tidyverse/r-lib team uses an even more extensive check matrix, which
would be overkill for most other packages. Itâ€™s necessary in this case in
order to meet our commitment to support the current version, the development
version, and four previous versions of R.</li>
</ul>
</li>
<li>
<p>R-hub builder (R-hub).
This is a service supported by the R Consortium where package developers can
submit their package for checks that replicate various CRAN check flavors.
This is useful when youâ€™re doing the due diligence leading up to a CRAN
submission.</p>
<p>You can use R-hub via a web interface (<a href="https://builder.r-hub.io" class="uri">https://builder.r-hub.io</a>) or, as we
recommend, through the <a href="https://r-hub.github.io/rhub/">rhub R package</a>.</p>
<p>The <code>rhub::check_for_cran()</code> function is morally similar to the GHA workflow
configured by <code><a href="https://usethis.r-lib.org/reference/github_actions.html">usethis::use_github_action_check_standard()</a></code>, i.e.Â itâ€™s a good
solution for a typical package heading to CRAN.
rhub has many other functions for accessing individual check flavors.</p>
</li>
<li>
<p>Win-Builder is a service maintained by the CRAN personnel who build the
Windows binaries for CRAN packages.
You use it in a similar way as R-hub, i.e.Â itâ€™s a good check to run when
preparing a CRAN submission.
(Win-Builder is basically the inspiration for R-hub, i.e.Â Win-builder is such
a convenient service that it makes sense to extend it for more flavors.)</p>
<p>The Win-Builder homepage (<a href="https://win-builder.r-project.org" class="uri">https://win-builder.r-project.org</a>) explains how to
upload a package via ftp, but we recommend using the convenience functions
<code><a href="https://devtools.r-lib.org/reference/check_win.html">devtools::check_win_release()</a></code> and friends.</p>
</li>
<li>
<p>macOS builder is a service maintained by the CRAN personnel who build the
macOS binaries for CRAN packages.
This is a relatively new addition to the list and checks packages with â€œthe
same setup and available packages as the CRAN M1 build machineâ€.</p>
<p>You can submit your package using the web interface
(<a href="https://mac.r-project.org/macbuilder/submit.html" class="uri">https://mac.r-project.org/macbuilder/submit.html</a>) or with
<code><a href="https://devtools.r-lib.org/reference/check_mac_release.html">devtools::check_mac_release()</a></code>.</p>
</li>
</ul>
</div>
<div id="testing-on-cran" class="section level3" number="13.12.2">
<h3>
<span class="header-section-number">13.12.2</span> Testing on CRAN<a class="anchor" aria-label="anchor" href="#testing-on-cran"><i class="fas fa-link"></i></a>
</h3>
<p>The need to pass tests on all of CRANâ€™s flavors is not the only thing you need to think about.
There are other considerations that will influence how you write your tests and how (or whether) they run on CRAN.
When a package runs afoul of the CRAN Repository Policy (<a href="https://cran.r-project.org/web/packages/policies.html" class="uri">https://cran.r-project.org/web/packages/policies.html</a>), the test suite is very often the culprit (although not always).</p>
<p>If a specific test simply isnâ€™t appropriate to be run by CRAN, include <code><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran()</a></code> at the very start.</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"some long-running thing works"</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># test code that can potentially take "a while" to run  </span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Under the hood, <code><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran()</a></code> consults the <code>NOT_CRAN</code> environment variable.
Such tests will only run when <code>NOT_CRAN</code> has been explicitly defined as <code>"true"</code>.
This variable is set by devtools and testthat, allowing those tests to run in environments where you expect success (and where you can tolerate and troubleshoot occasional failure).</p>
<p>In particular, the GitHub Actions workflows that we recommend elsewhere <strong>will</strong> run tests with <code>NOT_CRAN = "true"</code> call.
For certain types of functionality, there is no practical way to test it on CRAN and your own checks, on GHA or an equivalent continuous integration service, are your best method of quality assurance.</p>
<p>There are even rare cases where it makes sense to maintain tests outside of your package altogether.
The tidymodels team uses this strategy for integration-type tests of their whole ecosystem that would be impossible to host inside an individual CRAN package.</p>
<p>The following subsections enumerate other thing to keep in mind for maximum success when testing on CRAN.</p>
<div id="speed" class="section level4" number="13.12.2.1">
<h4>
<span class="header-section-number">13.12.2.1</span> Speed<a class="anchor" aria-label="anchor" href="#speed"><i class="fas fa-link"></i></a>
</h4>
<p>Your tests need to run relatively quickly - ideally, less than a minute, in total.
Use <code><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran()</a></code> in a test that is unavoidably long-running.</p>
</div>
<div id="reproducibility" class="section level4" number="13.12.2.2">
<h4>
<span class="header-section-number">13.12.2.2</span> Reproducibility<a class="anchor" aria-label="anchor" href="#reproducibility"><i class="fas fa-link"></i></a>
</h4>
<p>Be careful about testing things that are likely to be variable on CRAN machines.
Itâ€™s risky to test how long something takes (because CRAN machines are often heavily loaded) or to test parallel code (because CRAN runs multiple package tests in parallel, multiple cores will not always be available).
Numerical precision can also vary across platforms, so use <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal()</a></code> unless you have a specific reason for using <code><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_identical()</a></code>.</p>
</div>
<div id="flaky-tests" class="section level4" number="13.12.2.3">
<h4>
<span class="header-section-number">13.12.2.3</span> Flaky tests<a class="anchor" aria-label="anchor" href="#flaky-tests"><i class="fas fa-link"></i></a>
</h4>
<p>Due to the scale at which CRAN checks packages, there is basically no latitude for a test thatâ€™s â€œjust flakyâ€, i.e.Â sometimes fails for incidental reasons.
CRAN does not process your packageâ€™s test results the way you do, where you can inspect each failure and exercise some human judgment about how concerning it is.</p>
<p>Itâ€™s probably a good idea to eliminate flaky tests, just for your own sake!
But if you have valuable, well-written tests that are prone to occasional nuisance failure, definitely put <code><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran()</a></code> at the start.</p>
<p>The classic example is any test that accesses a website or web API.
Given that any web resource in the world will experience occasional downtime, itâ€™s best to not let such tests run on CRAN.
The CRAN Repository Policy says:</p>
<blockquote>
<p>Packages which use Internet resources should fail gracefully with an informative message if the resource is not available or has changed (and not give a check warning nor error).</p>
</blockquote>
<p>Often making such a failure â€œgracefulâ€ would run counter to the behaviour you actually want in practice, i.e.Â you would want your user to get an error if their request fails.
This is why it is usually more practical to test such functionality elsewhere.</p>
<p>Recall that snapshot tests, by default, are also skipped on CRAN.
You typically use such tests to monitor, e.g., how various informational messages look.
Slight changes in message formatting are something you want to be alerted to, but do not indicate a major defect in your package.
This is the motivation for the default <code><a href="https://testthat.r-lib.org/reference/skip.html">skip_on_cran()</a></code> behaviour of snapshot tests.</p>
<p>Finally, flaky tests cause problems for the maintainers of your dependencies.
When the packages you depend on are updated, CRAN runs <code>R CMD check</code> on all reverse dependencies, including your package.
If your package has flaky tests, your package can be the reason another package does not clear CRANâ€™s incoming checks and can delay its release.</p>
</div>
<div id="process-and-file-system-hygiene" class="section level4" number="13.12.2.4">
<h4>
<span class="header-section-number">13.12.2.4</span> Process and file system hygiene<a class="anchor" aria-label="anchor" href="#process-and-file-system-hygiene"><i class="fas fa-link"></i></a>
</h4>
<p>In section <a href="tests.html#tests-files-where-write">13.8.7</a>, we urged you to only write into the session temp directory and to clean up after yourself.
This practice makes your test suite much more maintainable and predictable.
For packages that are (or aspire to be) on CRAN, this is absolutely required per the CRAN repository policy:</p>
<blockquote>
<p>Packages should not write in the userâ€™s home filespace (including clipboards), nor anywhere else on the file system apart from the R sessionâ€™s temporary directory (or during installation in the location pointed to by TMPDIR: and such usage should be cleaned up)â€¦.
Limited exceptions may be allowed in interactive sessions if the package obtains confirmation from the user.</p>
</blockquote>
<p>Similarly, you should make an effort to be hygienic with respect to any processes you launch:</p>
<blockquote>
<p>Packages should not start external software (such as PDF viewers or browsers) during examples or tests unless that specific instance of the software is explicitly closed afterwards.</p>
</blockquote>
<p>Accessing the clipboard is the perfect storm that potentially runs afoul of both of these guidelines, as the clipboard is considered part of the userâ€™s home filespace and, on Linux, can launch an external process (e.g.Â xsel or xclip).
Therefore it is best to turn off any clipboard functionality in your tests (and to ensure that, during authentic usage, your user is clearly opting-in to that).</p>
<!--
Creating and maintaining a healthy test suite takes real effort. As a codebase grows, so too will the test suite. It will begin to face challenges like instability and slowness. A failure to address these problems will cripple a test suite. Keep in mind that tests derive their value from the trust engineers place in them. If testing becomes a productivity sink, constantly inducing toil and uncertainty, engineers will lose trust and begin to find workarounds. A bad test suite can be worse than no test suite at all.

Remember that tests are often revisited only when something breaks. When you are called to fix a broken test that you have never seen before, you will be thankful someone took the time to make it easy to understand. Code is read far more than it is written, so make sure you write the test youâ€™d like to read!

https://abseil.io/resources/swe-book/html/ch11.html

Because they make up such a big part of engineersâ€™ lives, Google puts a lot of focus on test maintainability. Maintainable tests  are ones that "just work": after writing them, engineers donâ€™t need to think about them again until they fail, and those failures indicate real bugs with clear causes. The bulk of this chapter focuses on exploring the idea of maintainability and techniques for achieving it.

https://abseil.io/resources/swe-book/html/ch12.html
-->
<!--
Another important path-building function to know about is `fs::path_package()`.
It is essentially `base::system.file()` with one very significant added feature:
it produces the correct path for both an in-development or an installed package.

```
during development               after installation                             

/path/to/local/package           /path/to/some/installed/package
â”œâ”€â”€ DESCRIPTION                  â”œâ”€â”€ DESCRIPTION
â”œâ”€â”€ ...                          â”œâ”€â”€ ...
â”œâ”€â”€ inst                         â””â”€â”€ some-installed-file.txt
â”‚   â””â”€â”€ some-installed-file.txt  
â””â”€â”€ ...
```

`fs::path_package("some-installed_file.txt")` builds the correct path in both cases.

A common theme you've now encountered in multiple places is that devtools and related packages try to eliminate hard choices between having a smooth interactive development experience and arranging things correctly in your package.
-->

</div>
</div>
</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="license.html"><span class="header-section-number">12</span> Licensing</a></div>
<div class="next"><a href="doc-intro.html"><span class="header-section-number">14</span> Introduction</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#tests"><span class="header-section-number">13</span> Testing</a></li>
<li><a class="nav-link" href="#why-is-formal-testing-worth-the-trouble"><span class="header-section-number">13.1</span> Why is formal testing worth the trouble?</a></li>
<li><a class="nav-link" href="#introducing-testthat"><span class="header-section-number">13.2</span> Introducing testthat</a></li>
<li>
<a class="nav-link" href="#tests-mechanics-workflow"><span class="header-section-number">13.3</span> Test mechanics and workflow</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#initial-setup"><span class="header-section-number">13.3.1</span> Initial setup</a></li>
<li><a class="nav-link" href="#create-a-test"><span class="header-section-number">13.3.2</span> Create a test</a></li>
<li><a class="nav-link" href="#run-tests"><span class="header-section-number">13.3.3</span> Run tests</a></li>
</ul>
</li>
<li><a class="nav-link" href="#test-organisation"><span class="header-section-number">13.4</span> Test organisation</a></li>
<li>
<a class="nav-link" href="#expectations"><span class="header-section-number">13.5</span> Expectations</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#testing-for-equality"><span class="header-section-number">13.5.1</span> Testing for equality</a></li>
<li><a class="nav-link" href="#testing-errors"><span class="header-section-number">13.5.2</span> Testing errors</a></li>
<li><a class="nav-link" href="#snapshot-tests"><span class="header-section-number">13.5.3</span> Snapshot tests</a></li>
<li><a class="nav-link" href="#shortcuts-for-other-common-patterns"><span class="header-section-number">13.5.4</span> Shortcuts for other common patterns</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#what-to-test"><span class="header-section-number">13.6</span> What to test</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#test-coverage"><span class="header-section-number">13.6.1</span> Test coverage</a></li></ul>
</li>
<li>
<a class="nav-link" href="#high-level-principles-for-testing"><span class="header-section-number">13.7</span> High-level principles for testing</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#self-sufficient-tests"><span class="header-section-number">13.7.1</span> Self-sufficient tests</a></li>
<li><a class="nav-link" href="#self-contained-tests"><span class="header-section-number">13.7.2</span> Self-contained tests</a></li>
<li><a class="nav-link" href="#plan-for-test-failure"><span class="header-section-number">13.7.3</span> Plan for test failure</a></li>
<li><a class="nav-link" href="#repetition-is-ok"><span class="header-section-number">13.7.4</span> Repetition is OK</a></li>
<li><a class="nav-link" href="#remove-tension-between-interactive-and-automated-testing"><span class="header-section-number">13.7.5</span> Remove tension between interactive and automated testing</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#tests-files-overview"><span class="header-section-number">13.8</span> Files relevant to testing</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#hiding-in-plain-sight-files-below-r"><span class="header-section-number">13.8.1</span> Hiding in plain sight: files below R/</a></li>
<li><a class="nav-link" href="#teststesthat.r"><span class="header-section-number">13.8.2</span> tests/testhat.R</a></li>
<li><a class="nav-link" href="#testthat-helper-files"><span class="header-section-number">13.8.3</span> Testthat helper files</a></li>
<li><a class="nav-link" href="#testthat-setup-files"><span class="header-section-number">13.8.4</span> Testthat setup files</a></li>
<li><a class="nav-link" href="#files-ignored-by-testthat"><span class="header-section-number">13.8.5</span> Files ignored by testthat</a></li>
<li><a class="nav-link" href="#storing-test-data"><span class="header-section-number">13.8.6</span> Storing test data</a></li>
<li><a class="nav-link" href="#tests-files-where-write"><span class="header-section-number">13.8.7</span> Where to write files during testing</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#test-fixtures"><span class="header-section-number">13.9</span> Test fixtures</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#create-useful_things-with-a-helper-function"><span class="header-section-number">13.9.1</span> Create useful_things with a helper function</a></li>
<li><a class="nav-link" href="#create-and-destroy-a-local-useful_thing"><span class="header-section-number">13.9.2</span> Create (and destroy) a â€œlocalâ€ useful_thing</a></li>
<li><a class="nav-link" href="#store-a-concrete-useful_thing-persistently"><span class="header-section-number">13.9.3</span> Store a concrete useful_thing persistently</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#building-your-own-testing-tools"><span class="header-section-number">13.10</span> Building your own testing tools</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#helper-defined-inside-a-test"><span class="header-section-number">13.10.1</span> Helper defined inside a test</a></li>
<li><a class="nav-link" href="#custom-expectatations"><span class="header-section-number">13.10.2</span> Custom expectatations</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#when-testing-gets-hard"><span class="header-section-number">13.11</span> When testing gets hard</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#tests-skipping"><span class="header-section-number">13.11.1</span> Skipping a test</a></li>
<li><a class="nav-link" href="#mocking"><span class="header-section-number">13.11.2</span> Mocking</a></li>
<li><a class="nav-link" href="#secrets"><span class="header-section-number">13.11.3</span> Secrets</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#special-considerations-for-cran-packages"><span class="header-section-number">13.12</span> Special considerations for CRAN packages</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#tests-cran-flavors-services"><span class="header-section-number">13.12.1</span> CRAN check flavors and related services</a></li>
<li><a class="nav-link" href="#testing-on-cran"><span class="header-section-number">13.12.2</span> Testing on CRAN</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/r-pkgs/blob/main/Testing.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/r-pkgs/edit/main/Testing.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Packages</strong>" was written by Hadley Wickham, Jennifer Bryan. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
